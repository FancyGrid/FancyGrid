Fancy.define("Fancy.grid.plugin.Selection",{extend:Fancy.Plugin,ptype:"grid.selection",inWidgetName:"selection",mixins:["Fancy.grid.selection.mixin.Navigation"],enabled:!0,checkboxRow:!1,checkOnly:!1,memory:!1,constructor:function(a){this.Super("const",arguments)},init:function(){var a=this;a.Super("init",arguments),a.memory&&a.initMemory(),a.ons()},ons:function(){var a=this,b=a.widget;b.once("render",function(){a.initTrackOver(),a.initColumnTrackOver(),a.initCellTrackOver(),a.initCellSelection(),a.initRowSelection(),a.initColumnSelection(),b.keyNavigation&&a.initNavigation(),b.on("changepage",a.onChangePage,a)}),b.on("sort",a.onSort,a)},initMemory:function(){var a=this;a.memory={all:!1,except:{},selected:{},setAll:function(){Fancy.apply(a.memory,{all:!0,except:{},selected:{}})},clearAll:function(){Fancy.apply(a.memory,{all:!1,except:{},selected:{}})}}},initTrackOver:function(){var a=this,b=a.widget;b.on("rowenter",a.onRowEnter,a),b.on("rowleave",a.onRowLeave,a)},initCellTrackOver:function(){var a=this,b=a.widget;b.on("cellenter",a.onCellEnter,a),b.on("cellleave",a.onCellLeave,a)},initColumnTrackOver:function(){var a=this,b=a.widget;b.on("columnenter",a.onColumnEnter,a),b.on("columnleave",a.onColumnLeave,a)},onCellEnter:function(a,b){var c=this,d=c.widget;d.cellTrackOver&&Fancy.get(b.cell).addClass(d.cellOverCls)},onCellLeave:function(a,b){var c=this,d=c.widget;d.cellTrackOver&&Fancy.get(b.cell).removeClass(d.cellOverCls)},onColumnEnter:function(a,b){var c=this,d=c.widget,e=d.scroller;!d.columnTrackOver||e.bottomKnobDown||e.rightKnobDown||!1===b.column.trackOver||Fancy.get(b.columnDom).addClass(d.columnOverCls)},onColumnLeave:function(a,b){var c=this,d=c.widget;d.columnTrackOver&&Fancy.get(b.columnDom).removeClass(d.columnOverCls)},onRowEnter:function(a,b){var c=this,d=c.widget,e=d.scroller;if(!1!==c.enabled&&d.trackOver&&!e.bottomKnobDown&&!e.rightKnobDown){for(var f=d.getDomRow(b.rowIndex),g=0,h=f.length;g<h;g++)Fancy.get(f[g]).addClass(d.rowOverCls);d.fire("rowtrackenter",b)}},onRowLeave:function(a,b){var c=this,d=c.widget;if(!1!==c.enabled&&d.trackOver){for(var e=d.getDomRow(b.rowIndex),f=0,g=e.length;f<g;f++)Fancy.get(e[f]).removeClass(d.rowOverCls);d.fire("rowtrackleave",b)}},onChangePage:function(){this.memory||this.clearSelection()},initCellSelection:function(){var a=this,b=a.widget;b.on("cellclick",a.onCellClick,a),b.on("cellmousedown",a.onCellMouseDownCells,a),b.on("cellenter",a.onCellEnterSelection,a)},initRowSelection:function(){var a=this,b=a.widget;b.checkboxRowSelection&&(a.checkboxRow=!0,setTimeout(function(){"rows"===a.selModel&&a.renderHeaderCheckBox()},1)),b.on("rowclick",a.onRowClick,a),b.on("cellmousedown",a.onCellMouseDownRows,a),b.on("cellclick",a.onCellClickRows,a),b.on("rowenter",a.onRowEnterSelection,a)},onCellMouseDownRows:function(a,b){var c=this,d=c.widget;if(c.rows&&c.enabled&&(!c.checkOnly||"$selected"===b.column.index)){var e=b.e,f=e.target,g=e.ctrlKey,h=b.rowIndex,i=d.getDomRow(h);if(g&&d.multiSelect)Fancy.get(i[0]).hasClass(d.cellSelectedCls)?(c.domDeSelectRow(h),c.checkboxRow&&c.deSelectCheckBox(h)):(c.domSelectRow(h),c.checkboxRow&&c.selectCheckBox(h));else if("$selected"===b.column.index){var j=Fancy.getWidget(Fancy.get(b.cell).select(".fancy-field-checkbox").attr("id"));j.el.within(f)?(c.domSelectRow(h),!0===j.get()?c.domDeSelectRow(h):c.domSelectRow(h)):(c.clearSelection(),c.domSelectRow(h),c.checkboxRow&&c.selectCheckBox(h))}else c.clearSelection(),c.domSelectRow(h),c.checkboxRow&&c.selectCheckBox(h);c.isMouseDown=!0,c.startRowSelection=h,Fancy.$(document).one("mouseup",function(){delete c.isMouseDown,delete c.startCellSelection}),d.fire("select")}},selectCheckBox:function(a){for(var b=this,c=b.widget,d=c.columnSelectCls,e=c.cellCls,f=c.el.select("."+d+" ."+e+'[index="'+a+'"] .fancy-field-checkbox'),g=0,h=f.length;g<h;g++){Fancy.getWidget(f.item(g).attr("id")).set(!0)}"rows"===c.selModel&&b.clearHeaderCheckBox()},deSelectCheckBox:function(a){var b=this,c=b.widget,d=c.store,e=c.columnSelectCls,f=c.cellCls,g=c.el.select("."+e+" ."+f+'[index="'+a+'"] .fancy-field-checkbox'),h=0,i=g.length,j=d.get(a,"id");if(j){for(b.memory&&(b.memory.except[j]=!0,delete b.memory.selected[j]);h<i;h++){Fancy.getWidget(g.item(h).attr("id")).set(!1)}b.clearHeaderCheckBox()}},domSelectRow:function(a){var b=this,c=b.widget,d=c.store,e=c.getDomRow(a),f=0,g=e.length,h=d.get(a,"id");for(b.memory&&(delete b.memory.except[h],b.memory.selected[h]=!0);f<g;f++)Fancy.get(e[f]).addClass(c.cellSelectedCls)},domDeSelectRow:function(a){for(var b=this,c=b.widget,d=c.getDomRow(a),e=0,f=d.length;e<f;e++)Fancy.get(d[e]).removeClass(c.cellSelectedCls)},onColumnEnterSelection:function(a,b){var c=this,d=c.widget;if(c.columns&&!0===c.isMouseDown){var e={columnIndex:c.startColumnColumnIndex,side:c.startColumnSide},f={columnIndex:b.columnIndex,side:b.side};if(e.side===f.side){switch(e.side){case"center":c.clearSelection("right"),c.clearSelection("left");break;case"left":c.clearSelection("center"),c.clearSelection("right");break;case"right":c.clearSelection("center"),c.clearSelection("left")}c.selectColumns(e.columnIndex,f.columnIndex,e.side)}else"center"===e.side&&"right"===f.side?(c.selectColumns(e.columnIndex,d.columns.length,"center"),c.selectColumns(0,f.columnIndex,"right")):"center"===e.side&&"left"===f.side?(c.selectColumns(0,e.columnIndex,"center"),c.selectColumns(f.columnIndex,d.leftColumns.length,"left")):"left"===e.side&&"center"===f.side?(c.clearSelection("right"),c.selectColumns(e.columnIndex,d.leftColumns.length,"left"),c.selectColumns(0,f.columnIndex,"center")):"left"===e.side&&"right"===f.side?(c.selectColumns(e.columnIndex,d.leftColumns.length,"left"),c.selectColumns(0,d.columns.length,"center"),c.selectColumns(0,f.columnIndex,"right")):"right"===e.side&&"center"===f.side?(c.clearSelection("left"),c.selectColumns(0,e.columnIndex,"right"),c.selectColumns(f.columnIndex,d.columns.length,"center")):"right"===e.side&&"left"===f.side&&(c.selectColumns(0,e.columnIndex,"right"),c.selectColumns(0,d.columns.length,"center"),c.selectColumns(f.columnIndex,d.leftColumns.length,"left"))}},onRowEnterSelection:function(a,b){var c=this,d=c.widget;if(!1!==c.enabled&&c.rows&&!0===c.isMouseDown){var e=c.startRowSelection,f=b.rowIndex,g={};e>f&&(e=b.rowIndex,f=c.startRowSelection);for(var h=e,i=f+1;h<i;h++)g[h]=!0;var j=c.getSelectedRowByColumn(b.columnIndex,b.side),k={},l={};for(var m in g)!0!==j[m]&&(k[m]=!0);for(var m in j)!0!==g[m]&&(l[m]=!0);for(var m in k)c.domSelectRow(m),c.checkboxRow&&c.selectCheckBox(m);for(var m in l)c.domDeSelectRow(m),c.checkboxRow&&c.deSelectCheckBox(m);d.fire("select")}},getSelectedRowByColumn:function(a,b){var c,d=this,e=d.widget;switch(b){case"left":c=e.leftBody;break;case"center":c=e.body;break;case"right":c=e.rightBody}for(var f=c.el.select('.fancy-grid-column[index="'+a+'"][grid="'+e.id+'"]'),g=f.select("."+e.cellSelectedCls),h={},i=0,j=g.length;i<j;i++)h[Number(g.item(i).attr("index"))]=!0;return h},getSelectedRow:function(){var a=this,b=a.widget,c=b.body,d=c.el.select("."+b.cellSelectedCls);return 0===d.length?-1:Number(d.item(0).attr("index"))},getSelectedRows:function(){for(var a=this,b=a.widget,c=b.body,d=c.el.select('.fancy-grid-column[index="0"][grid="'+b.id+'"]'),e=d.select("."+b.cellSelectedCls),f=[],g=0,h=e.length;g<h;g++)f.push(Number(e.item(g).attr("index")));return f},initColumnSelection:function(){var a=this,b=a.widget;a.selectedColumns=[],b.on("columnclick",a.onColumnClick,a),b.on("columnmousedown",a.onColumnMouseDown,a),b.on("columnenter",a.onColumnEnterSelection,a)},onColumnClick:function(a,b){var c=this,d=c.widget;if(c.column&&!1!==b.column.selectable){var e=Fancy.get(b.columnDom);c.column&&(c.selectedColumns[0]=b),c.clearSelection(),e.addClass(d.columnSelectedCls)}},onRowClick:function(a,b){var c=this,d=c.widget,e=b.rowIndex;if(c.row&&!1!==b&&(!c.checkOnly||"$selected"===b.column.index)){var f=b.column,g=!0;if("action"===f.type&&f.items)for(var h=0,i=f.items.length;h<i;h++)"remove"===f.items[h].action&&(g=!1);var j=d.getDomRow(e),k=0,l=j.length;if(c.clearSelection(),"$selected"===b.column.index){if(!0===Fancy.getWidget(Fancy.get(b.cell).select(".fancy-field-checkbox").attr("id")).get())for(c.selectCheckBox(e);k<l;k++)Fancy.get(j[k]).addClass(d.cellSelectedCls);else c.deSelectCheckBox(e)}else if(g){for(;k<l;k++)Fancy.get(j[k]).addClass(d.cellSelectedCls);c.selectCheckBox(e),d.fire("select")}}},onCellClickRows:function(a,b){var c=this,d=c.widget;if(c.rows&&c.enabled&&(!c.checkOnly||"$selected"===b.column.index)){var e=b.e,f=e.ctrlKey,g=b.rowIndex;if(f&&d.multiSelect);else if("$selected"===b.column.index){var h=Fancy.getWidget(Fancy.get(b.cell).select(".fancy-field-checkbox").attr("id"));!0===h.get()?c.selectCheckBox(g):c.deSelectCheckBox(g)}}},selectRow:function(a){var b=this,c=b.widget;if(!b.row&&!b.rows)throw new Error("[FancyGrid Error] - row selection was not enabled");b.clearSelection();for(var d=c.getDomRow(a),e=0,f=d.length;e<f;e++)Fancy.get(d[e]).addClass(c.cellSelectedCls);c.fire("select")},onCellClick:function(a,b){var c=this,d=c.widget;c.cell&&(c.clearSelection(),Fancy.get(b.cell).addClass(d.cellSelectedCls),d.fire("select"))},clearSelection:function(a){var b=this,c=b.widget;if(b.checkboxRow){for(var d=c.body.el.select('.fancy-grid-column[index="0"] .'+c.cellSelectedCls),e=0,f=d.length;e<f;e++){var g=d.item(e).attr("index");b.deSelectCheckBox(g)}b.memory&&b.memory.clearAll()}if(a)switch(a){case"left":c.leftBody.el.select("."+c.cellSelectedCls).removeClass(c.cellSelectedCls),c.leftBody.el.select("."+c.columnSelectedCls).removeClass(c.columnSelectedCls),c.leftBody.el.select("."+c.cellOverCls).removeClass(c.cellOverCls);break;case"center":c.body.el.select("."+c.cellSelectedCls).removeClass(c.cellSelectedCls),c.body.el.select("."+c.columnSelectedCls).removeClass(c.columnSelectedCls),c.body.el.select("."+c.cellOverCls).removeClass(c.cellOverCls);break;case"right":c.rightBody.el.select("."+c.cellSelectedCls).removeClass(c.cellSelectedCls),c.rightBody.el.select("."+c.columnSelectedCls).removeClass(c.columnSelectedCls),c.rightBody.el.select("."+c.cellOverCls).removeClass(c.cellOverCls)}else c.el.select("."+c.cellSelectedCls).removeClass(c.cellSelectedCls),c.el.select("."+c.columnSelectedCls).removeClass(c.columnSelectedCls),c.el.select("."+c.cellOverCls).removeClass(c.cellOverCls);c.fire("clearselect")},onSort:function(){var a=this;a.memory||a.clearSelection()},onCellEnterSelection:function(a,b){var c=this,d=c.widget,e=0;if(c.cells&&!0===c.isMouseDown){c.prevCellsSelection=b.cell,c.prevCellRowIndex=b.rowIndex,c.prevCellColumnIndex=b.columnIndex,c.prevCellSide=b.side;var f={rowIndex:c.startCellRowIndex,columnIndex:c.startCellColumnIndex,side:c.startCellSide},g={rowIndex:b.rowIndex,columnIndex:b.columnIndex,side:b.side};b.rowIndex<c.startCellRowIndex&&(f.rowIndex=b.rowIndex,g.rowIndex=c.startCellRowIndex),c.startCellSide===b.side?(b.columnIndex<c.startCellColumnIndex&&(f.columnIndex=b.columnIndex,g.columnIndex=c.startCellColumnIndex),e=c.selectCells(f,g,f.side),"left"===c.startCellSide?(c.clearSelection("center"),c.clearSelection("right")):"center"===c.startCellSide?(c.clearSelection("left"),c.clearSelection("right")):"right"===c.startCellSide&&(c.clearSelection("left"),c.clearSelection("center"))):"left"===c.startCellSide?(e=c.selectCells(f,{rowIndex:b.rowIndex,columnIndex:d.leftColumns.length-1},"left"),"center"===b.side?(e+=c.selectCells({columnIndex:0,rowIndex:f.rowIndex},g,"center"),c.clearSelection("right")):"right"===b.side&&(e+=c.selectCells({columnIndex:0,rowIndex:f.rowIndex},{columnIndex:d.columns.length-1,rowIndex:g.rowIndex},"center"),e+=c.selectCells({columnIndex:0,rowIndex:f.rowIndex},g,"right"))):"center"===c.startCellSide?"left"===b.side?(e+=c.selectCells({columnIndex:0,rowIndex:f.rowIndex},{rowIndex:g.rowIndex,columnIndex:f.columnIndex},"center"),e+=c.selectCells({columnIndex:g.columnIndex,rowIndex:f.rowIndex},{rowIndex:g.rowIndex,columnIndex:d.leftColumns.length-1},"left")):"right"===b.side&&(e+=c.selectCells({columnIndex:f.columnIndex,rowIndex:f.rowIndex},{columnIndex:d.columns.length-1,rowIndex:g.rowIndex},"center"),e+=c.selectCells({columnIndex:0,rowIndex:f.rowIndex},{columnIndex:g.columnIndex,rowIndex:g.rowIndex},"right")):"right"===c.startCellSide&&(e+=c.selectCells({columnIndex:0,rowIndex:f.rowIndex},{columnIndex:f.columnIndex,rowIndex:g.rowIndex},"right"),"center"===b.side?(e+=c.selectCells({columnIndex:g.columnIndex,rowIndex:f.rowIndex},{columnIndex:d.columns.length-1,rowIndex:g.rowIndex},"center"),c.clearSelection("left")):"left"===b.side&&(e+=c.selectCells({columnIndex:0,rowIndex:f.rowIndex},{columnIndex:d.columns.length-1,rowIndex:g.rowIndex},"center"),e+=c.selectCells({columnIndex:g.columnIndex,rowIndex:f.rowIndex},{columnIndex:d.leftColumns.length-1,rowIndex:g.rowIndex},"left"))),c.endCellRowIndex=g.rowIndex,d.fire("select")}},onColumnMouseDown:function(a,b){var c=this,d=c.widget;if(c.columns&&!1!==b.column.selectable&&c.enabled){var e=Fancy.get(b.columnDom);c.isMouseDown=!0,c.startColumnColumnIndex=b.columnIndex,c.startColumnSide=b.side,c.clearSelection(),e.addClass(d.columnSelectedCls),Fancy.$(document).one("mouseup",function(){delete c.isMouseDown}),d.fire("select")}},onCellMouseDownCells:function(a,b){var c=this,d=c.widget;if(d.celledit&&d.celledit.hideEditor(),c.cells&&c.enabled){var e=Fancy.get(b.cell);c.clearSelection(),e.addClass(d.cellSelectedCls),c.isMouseDown=!0,c.startCellSelection=b.cell,c.startCellRowIndex=b.rowIndex,c.startCellColumnIndex=b.columnIndex,c.startCellSide=b.side,Fancy.$(document).one("mouseup",function(){delete c.isMouseDown,delete c.startCellSelection}),d.fire("select")}},selectCells:function(a,b,c){var d,e,f,g=this,h=g.widget,i=h.body,j=h.leftBody,k=h.rightBody,l=a.rowIndex,m=b.rowIndex+1,n=g.getSelectedCells(c||"center"),o={},p={},q={};for(l=a.rowIndex,m=b.rowIndex+1;l<m;l++)for(o[l]=o[l]||{},e=a.columnIndex,f=b.columnIndex+1;e<f;e++)o[l][e]=!0;for(var r in o)if(void 0===n[r])p[r]=o[r];else for(var s in o[r])!0!==n[r][s]&&(p[r]=p[r]||{},p[r][s]=!0);for(var r in n)if(void 0===o[r])q[r]=n[r];else for(var s in n[r])!0!==o[r][s]&&(q[r]=q[r]||{},q[r][s]=!0);switch(c){case"left":d=j;break;case"center":d=i;break;case"right":d=k;break;default:d=i}for(var r in p)for(var s in p[r]){var t=d.getCell(r,s);t.addClass(h.cellSelectedCls)}for(var r in q)for(var s in q[r]){var t=d.getCell(r,s);t.removeClass(h.cellSelectedCls)}},getSelectedCells:function(a){for(var b=this,c=b.widget,d=c.getBody(a||"center"),e=d.el.select("."+c.cellSelectedCls),f={},g=0,h=e.length;g<h;g++){var i=e.item(g),j=Number(i.parent().attr("index")),k=Number(i.attr("index"));f[k]=f[k]||{},f[k][j]=!0}return f},getNumberSelectedCells:function(){var a=this,b=a.widget;return b.el.select("."+b.cellSelectedCls).length},getSelectedColumns:function(a){for(var b=this,c=b.widget,d=c.getBody(a),e={},f=d.el.select("."+c.columnSelectedCls),g=0,h=f.length;g<h;g++)e[f.item(g).attr("index")]=!0;return e},selectColumns:function(a,b,c){var d=this,e=d.getSelectedColumns(c||"center"),f={},g={},h={},i=a,j=b;for(j<i&&(i=b,j=a),j++;i<j;i++)f[i]=!0;for(var k in f)!0!==e[k]&&(g[k]=!0);for(var k in e)!0!==f[k]&&(h[k]=!0);for(var k in g)d.selectColumn(k,c);for(var k in h)d.deselectColumn(k,c)},selectColumn:function(a,b){var c=this,d=c.widget,e=d.getBody(b||"center");Fancy.get(e.getDomColumn(a)).addClass(d.columnSelectedCls)},deselectColumn:function(a,b){var c=this,d=c.widget,e=d.getBody(b||"center");Fancy.get(e.getDomColumn(a)).removeClass(d.columnSelectedCls)},getSelection:function(a){var b=this,c=b.widget,d=c.store,e={};switch(b.selModel){case"row":e.row=b.getSelectedRow(),-1!==e.row?(e.items=[d.get(e.row)],e.rows=[e.row]):(e.items=[],e.rows=[]);break;case"rows":if(e.rows=b.getSelectedRows(),b.memory&&b.memory.all)e.items=d.data;else{e.items=[];for(var f=0,g=e.rows.length;f<g;f++)e.items.push(d.get(e.rows[f]))}}return a?e:e.items},renderHeaderCheckBox:function(){var a=this,b=a.widget;a._renderHeaderCheckBox(b.leftHeader,b.leftColumns),a._renderHeaderCheckBox(b.header,b.columns),a._renderHeaderCheckBox(b.rightHeader,b.rightColumns)},_renderHeaderCheckBox:function(a,b){for(var c,d=this,e=0,f=b.length;e<f;e++)if(c=b[e],"$selected"===c.index){var g=a.getCell(e).firstChild();c.headerCheckBox=new Fancy.CheckBox({renderTo:g.dom,renderId:!0,value:!1,label:!1,style:{padding:"0px",display:"inline-block"},events:[{change:function(a,b){b?(d.selectAll(),d.memory&&d.memory.setAll()):(d.deSelectAll(),d.memory&&d.memory.clearAll())}}]})}},selectAll:function(){for(var a=this,b=a.widget,c=b.columnSelectCls,d=b.cellCls,e=b.el.select(".fancy-grid-header-cell-select .fancy-field-checkbox"),f=0,g=b.getViewTotal();f<g;f++){for(var h=b.el.select("."+c+" ."+d+'[index="'+f+'"] .fancy-field-checkbox'),i=0,j=h.length;i<j;i++){var k=Fancy.getWidget(h.item(i).attr("id"));k.setValue(!0)}a.domSelectRow(f)}for(f=0,g=e.length;f<g;f++){var k=Fancy.getWidget(e.item(f).attr("id"));k.setValue(!0,!1)}},deSelectAll:function(){for(var a=this,b=a.widget,c=b.columnSelectCls,d=b.cellCls,e=0,f=f=b.getViewTotal();e<f;e++){for(var g=b.el.select("."+c+" ."+d+'[index="'+e+'"] .fancy-field-checkbox'),h=0,i=g.length;h<i;h++){Fancy.getWidget(g.item(h).attr("id")).setValue(!1)}a.domDeSelectRow(e)}a.clearHeaderCheckBox()},clearHeaderCheckBox:function(){for(var a=this,b=a.widget,c=b.el.select(".fancy-grid-header-cell-select .fancy-field-checkbox"),d=0,e=c.length;d<e;d++){Fancy.getWidget(c.item(d).attr("id")).setValue(!1,!1)}},stopSelection:function(){this.enabled=!1},enableSelection:function(a){var b=this;if(void 0!==a)return void(b.enabled=a);b.enabled=!0}});