Fancy.modules["column-drag"]=!0,function(){var a=Fancy,b=a.get(document),c=a.HIDDEN_CLS,d=a.GRID_HEADER_CELL_CLS,e=a.GRID_HEADER_CELL_TEXT_CLS,f=a.GRID_HEADER_CELL_TRIGGER_CLS,g=a.GRID_HEADER_CELL_TRIGGER_IMAGE_CLS,h=a.GRID_HEADER_CELL_GROUP_LEVEL_1_CLS,i=a.GRID_HEADER_CELL_GROUP_LEVEL_2_CLS,j=a.GRID_STATE_DRAG_COLUMN_CLS,k=a.FIELD_TEXT_INPUT_CLS,l=a.FIELD_CHECKBOX_INPUT_CLS;a.define("Fancy.grid.plugin.ColumnDrag",{extend:a.Plugin,ptype:"grid.columndrag",inWidgetName:"columndrag",activeSide:void 0,activeCell:void 0,activeIndex:void 0,activeColumn:void 0,inCell:void 0,inIndex:void 0,inSide:void 0,ok:!1,status:"none",constructor:function(){this.Super("const",arguments)},init:function(){var a=this,b=a.widget;a.Super("init",arguments),b.on("render",function(){a.ons(),a.initHint()})},ons:function(){var a=this;a.widget.el.on("mousedown",a.onMouseDownCell,a,"div."+d)},onMouseDownCell:function(c){var e=this,j=e.widget,m=Fancy.get(c.currentTarget),n=Number(m.attr("index")),o=j.getSideByCell(m),p=j.getColumns(o),q=p[n],r=a.get(c.target);q&&q.titleEditable||r.hasCls(f)||r.hasCls(g)||r.hasCls(k)||r.hasCls(l)||(m.hasCls(i)&&(e.activeCellTopGroup=e.getGroupStartEnd(m,o),e.activeCellTopGroup.cell=m),j.startResizing||(e.activeCellTopGroup||!1!==q.draggable)&&(m.hasCls(h)&&(e.activeUnderGroup=!0),e.activeSide=o,e.inSide=o,e.activeCell=m,e.inCell=m,e.activeIndex=Number(m.attr("index")),e.inIndex=e.activeIndex,e.activeColumn=p[e.activeIndex],e.mouseDownX=c.pageX,e.mouseDownY=c.pageY,b.once("mouseup",e.onMouseUp,e),b.on("mousemove",e.onMouseMove,e),j.el.on("mouseleave",e.onMouseLeave,e),j.el.on("mouseenter",e.onMouseEnterCell,e,"div."+d),j.el.on("mousemove",e.onMouseMoveCell,e,"div."+d)))},onMouseLeave:function(){this.hideHint()},onMouseUp:function(){var c,e=this,f=e.widget,g=!1;b.un("mousemove",e.onMouseMove,e),f.el.un("mouseleave",e.onMouseLeave,e),f.el.un("mouseenter",e.onMouseEnterCell,e,"div."+d),f.el.un("mousemove",e.onMouseMoveCell,e,"div."+d),e.ok&&(e.fire("beforecolumndrag"),e.inSide===e.activeSide?e.dragColumn(e.inSide):(e.activeSide,c=e.inIndex,"right"===e.okPosition&&c++,f.moveColumn(e.activeSide,e.inSide,e.activeIndex,c,e.activeCellTopGroup)),g=!0);var h={column:e.activeColumn,fromSide:e.activeSide,toSide:e.inSide};delete e.inUpGroupCell,delete e.inUnderGroup,delete e.activeCellTopGroup,delete e.activeUnderGroup,delete e.activeSide,delete e.inSide,delete e.inCell,delete e.inIndex,delete e.activeCell,delete e.activeIndex,delete e.activeColumn,delete e.mouseDownX,delete e.mouseDownY,e.ok=!1,delete e.okPosition,a.tip.hide(),setTimeout(function(){e.status="none"},1),e.removeDragState(),"dragging"===e.status&&setTimeout(function(){e.status="none",g&&(f.fire("columndrag",h),f.sorter&&f.sorter.updateSortedHeader(),e.updateColumnHeaderLImages(),e.clearColumnMenus())},10),e.hideHint(),setTimeout(function(){f.updateColumnsVisibility()},100),f.scroller.update()},onMouseMove:function(b){var c=this,d=c.widget,h=d.header,i=d.leftHeader,j=d.rightHeader,k=b.pageX,l=b.pageY,m=d.getColumns(c.activeSide),n=a.get(b.target);if(!n.hasCls(f)&&!n.hasCls(g)&&(Math.abs(k-c.mouseDownX)>10||Math.abs(l-c.mouseDownY))){if(c.activeCellTopGroup?(a.tip.update(c.activeCellTopGroup.cell.select("."+e).item(0).dom.innerHTML||"&nbsp;"),c.status="dragging",c.addDragState()):(a.tip.update(c.activeColumn.title||"&nbsp;"),c.status="dragging",c.addDragState()),1===m.length&&"center"===c.activeSide)return a.tip.hide(),setTimeout(function(){c.status="none"},1),void c.removeDragState();a.tip.show(b.pageX+15,b.pageY+15),h.hideMenu&&(h.hideMenu(),d.leftColumns&&i.hideMenu()&&i.hideMenu(),d.rightColumns&&j.hideMenu()&&j.hideMenu())}},addDragState:function(){this.widget.el.addClass(j)},removeDragState:function(){this.widget.el.removeClass(j)},onMouseEnterCell:function(a){var b=this,c=b.widget,d=Fancy.get(a.currentTarget),e=c.getSideByCell(d);if(b.hideHint(),d.hasCls(h)?b.inUnderGroup=!0:delete b.inUnderGroup,d.hasCls(i)?b.inUpGroupCell=d:delete b.inUpGroupCell,b.inSide=e,b.inCell=d,b.inUpGroupCell){var f,g=c.getHeader(e),j=g.el.select('[group-index="'+d.attr("index")+'"]');j.each(function(a){"none"!==a.css("display")&&void 0===f&&(f=Number(a.attr("index")))}),b.inIndex=f}else b.inIndex=Number(d.attr("index"))},onMouseMoveCell:function(a){var b=this,c=b.widget,d=b.inCell,e=parseInt(d.css("width")),g=d.select("."+f);if(g.dom){var h=Fancy.get(a.target),i=g.within(h)||h.hasClass(f),j=b.activeUnderGroup!==b.inUnderGroup&&!0===b.inUnderGroup,k=b.activeUnderGroup!==b.inUnderGroup&&!0===b.activeUnderGroup,l=c.getColumns(b.activeSide);if(1===l.length&&"center"===b.activeSide)return b.ok=!1,void b.hideHint();if(b.activeCellTopGroup)if(b.inUpGroupCell);else{var m=b.activeCellTopGroup.start,n=b.activeCellTopGroup.end;b.activeSide!==b.inSide?(b.ok=!0,a.offsetX>e/2||i?b.showHint("right"):b.showHint("left")):isNaN(b.inIndex)?b.hideHint():b.inIndex<m?a.offsetX>e/2?b.inIndex+1===m?b.hideHint():(b.ok=!0,b.showHint("right")):(b.ok=!0,b.showHint("left")):b.inIndex>n?a.offsetX<e/2?b.inIndex===n+1?b.hideHint():(b.ok=!0,b.showHint("left")):(b.ok=!0,b.showHint("right")):b.hideHint()}else if(b.inUpGroupCell){var o=b.getGroupStartEnd(),m=o.start,n=o.end;b.activeSide!==b.inSide?(b.ok=!0,a.offsetX>e/2||i?b.showHint("right"):b.showHint("left")):a.offsetX>e/2?b.activeIndex>n&&b.activeIndex-1===n?b.hideHint():(b.ok=!0,b.showHint("right")):b.activeIndex<m&&b.activeIndex+1===m?b.hideHint():(b.ok=!0,b.showHint("left"))}else if(b.activeSide!==b.inSide)b.ok=!0,a.offsetX>e/2||i?b.showHint("right"):b.showHint("left");else if(b.activeIndex===b.inIndex)b.ok=!1;else if(b.activeIndex<b.inIndex)if(a.offsetX>e/2||i){var p=l[b.inIndex];p.disallowAfterDrop||(b.ok=!0,b.showHint("right"))}else a.offsetX<e/2&&b.activeIndex+1!==b.inIndex?(b.ok=!0,b.showHint("left")):b.activeIndex+1===b.inIndex&&(j||k)?(b.ok=!0,b.showHint("left")):(b.ok=!1,b.hideHint());else b.activeIndex>b.inIndex&&(a.offsetX<e/2?i?j||k?(b.ok=!0,b.showHint("right")):b.activeIndex-1===b.inIndex||b.inUpGroupCell?(b.ok=!1,b.hideHint()):(b.ok=!0,b.showHint("right")):(b.ok=!0,b.showHint("left")):a.offsetX>e/2?b.activeIndex-1===b.inIndex&&(j||k)?(b.ok=!0,b.showHint("right")):b.activeIndex-1!==b.inIndex||b.activeUnderGroup?(b.ok=!0,b.showHint("right")):(b.ok=!1,b.hideHint()):(b.ok=!1,b.hideHint()))}},showHint:function(b){var d=this,e=d.widget,f=e.cellHeaderHeight,g=d.inCell,h=d.topEl,i=d.bottomEl,j=g.offset(),k=parseInt(g.css("width")),l=parseInt(g.css("height"));d.okPosition=b,h.removeCls(c),i.removeCls(c);var m=0;"right"===b&&(m+=k),h.css({left:j.left+m-Math.ceil(parseInt(h.css("width"))/2),top:j.top-parseInt(h.css("height"))});var n=j.top+l;if(d.inUpGroupCell){var o=e.header.calcRows();n=j.top+o*f}if(i.css({left:j.left+m-Math.ceil(parseInt(i.css("width"))/2),top:n}),e.window){var p=1e3+a.zIndex++;h.css("z-index",p),i.css("z-index",p)}},hideHint:function(){var a=this;a.topEl.addCls(c),a.bottomEl.addCls(c)},initHint:function(){var b=this,d=b.widget,e=Fancy.getThemeCSSCls(d.theme),f=a.get(document.body).dom,g=a.get(document.createElement("div")),h=a.get(document.createElement("div"));g.addCls("fancy-drag-hint-top",c,e),h.addCls("fancy-drag-hint-bottom",c,e),b.topEl=a.get(f.appendChild(g.dom)),b.bottomEl=a.get(f.appendChild(h.dom))},dragColumn:function(a){var b=this,c=b.widget,d=c.getHeader(a),e=c.getBody(a),f=b.activeIndex,g=b.inIndex,h=b.okPosition,i=c.getColumns(a),j=i[f],k=d.calcRows();if(b.activeCellTopGroup){var l=b.activeCellTopGroup.start,m=b.activeCellTopGroup.end,n=i.splice(l,m-l+1);g=b.inIndex,"right"===h&&g++,i=b.inIndex<l?Fancy.Array.insert(i,g,n):Fancy.Array.insert(i,g-n.length,n),c.setColumnsLinksToSide(i,a)}else if(b.inUpGroupCell){var o=b.getGroupStartEnd();g=o.start,"right"===h&&(g=o.end+1)}else if("right"===h)if(b.inUnderGroup){var p=i[g].grouping,q=i[g+1];q&&q.grouping===p&&g++}else g++;if(c.groupheader&&!b.activeCellTopGroup){var r=i[g];r&&r.grouping&&b.inUnderGroup?(j.grouping=r.grouping,j.filter&&j.filter.header&&k<3&&delete j.filter):delete j.grouping}b.activeCellTopGroup||(i.splice(f,1),f<g&&g--,i.splice(g,0,j)),e.clearColumnsStyles(),d.updateTitles(),d.updateCellsSizes(),d.reSetCheckBoxes(),setTimeout(function(){c.groupheader&&(c.header.fixGroupHeaderSizing(),c.leftColumns&&c.leftHeader.fixGroupHeaderSizing(),c.rightColumns&&c.rightHeader.fixGroupHeaderSizing(),d.reSetGroupIndexes()),d.reSetColumnsAlign(),d.reSetColumnsCls(),e.reSetColumnsAlign(),e.reSetColumnsCls(),e.updateColumnsSizes()},100),c.update()},getGroupStartEnd:function(b,c){var d=this,e=d.widget,f=e.getHeader(c||d.inSide),g=(b||d.inUpGroupCell).attr("index"),h=f.el.select('[group-index="'+g+'"]'),i=[];return h.each(function(a){i.push(Number(a.attr("index")))}),{start:a.Array.min(i),end:a.Array.max(i)}},clearColumnMenus:function(){var b=this,c=b.widget;a.each(c.columns,function(b){a.isObject(b.menu)&&b._menu&&(b.menu=b._menu,delete b._menu)})},updateColumnHeaderLImages:function(){var a=this,b=a.widget;b.header&&(b.header.updateLImages(),b.leftColumns.length&&b.leftHeader.updateLImages(),b.rightColumns.length&&b.rightHeader.updateLImages())}})}();