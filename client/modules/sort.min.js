Fancy.Mixin("Fancy.store.mixin.Sort",{multiSortLimit:3,sort:function(a,b,c,d){var e,f,g=this;switch(g.fire("beforesort",{key:"key",action:a}),g.multiSort&&!0!==g.multiSortInited&&g.initMultiSort(),b){case"number":case"checkbox":case"progressdonut":case"progressbar":case"grossloss":case"date":case"currency":e="sortNumber",f="number";break;case"string":case"combo":case"text":case"color":e="sortString",f="string";break;default:throw new Error("[FancyGrid error] - does not exist sort function for type "+b)}if(g.multiSort&&g.addSorter(c,a.toLocaleUpperCase(),f),g.remoteSort)return void g.serverSort(a,b,c);if(d.type=b,g[e](a,c,d),g.multiSort)for(var h=0,i=g.sorters.length-1;h<i;h++)g.multiSortOrder(h);g.changeDataView(),g.fire("sort",{key:"key",action:a})},serverSort:function(a,b,c){var d=this;d.params=d.params||{},d.multiSort?d.params.sorters=d.sorters:(d.params[d.sortParam]=c,d.params[d.directionParam]=a),d.loadData()},sortNumber:function(a,b,c){var d,e,f,g=this,h=[];if(g.grouping){var i=g.getColumnOriginalValuesByGroup(b,g.grouping.by,c);switch(d=[],e=0,f=i.length,a){case"asc":for(;e<f;e++)h=h.concat(i[e].values),d=d.concat(i[e].values.sort(function(a,b){return a-b}));break;case"desc":for(;e<f;e++)h=h.concat(i[e].values),d=d.concat(i[e].values.sort(function(a,b){return b-a}))}}else switch(h=g.getColumnOriginalValues(b,c),a){case"asc":d=Fancy.Array.copy(h).sort(function(a,b){return a-b});break;case"desc":d=Fancy.Array.copy(h).sort(function(a,b){return b-a})}g.order=g.getOrder(h,d)},sortString:function(a,b){var c,d,e,f=this,g=[];if(f.grouping){var h=f.getColumnOriginalValuesByGroup(b,f.grouping.by);switch(c=[],d=0,e=h.length,a){case"asc":for(;d<e;d++)g=g.concat(h[d].values),c=c.concat(h[d].values.sort());break;case"desc":for(;d<e;d++)g=g.concat(h[d].values),c=c.concat(h[d].values.sort().reverse())}}else switch(g=f.getColumnOriginalValues(b),a){case"asc":c=Fancy.Array.copy(g).sort();break;case"desc":c=Fancy.Array.copy(g).sort(),c=c.reverse()}f.order=f.getOrder(g,c)},getOrder:function(a,b){for(var c,d={},e=0,f=a.length,g=[];e<f;e++){var h=a[e];void 0===d[h]&&(d[h]=[]),d[h].push(e)}for(e=0;e<f;e++)h=b[e],c=d[h],g.push(c[0]),c.length>1&&c.splice(0,1);return g},changeOrderIndexes:function(a,b){var c=this;if(void 0===b&&(b="-"),void 0!==c.order){var d=0,e=c.order.length;if("-"===b)for(;d<e;d++)c.order[d]>a&&c.order[d]--;else for(;d<e;d++)c.order[d]>=a&&c.order[d]++}},initMultiSort:function(){var a=this;a.multiSortInited=!0,a.sorters||(a.sorters=[])},addSorter:function(a,b,c){for(var d=this,e=0,f=d.sorters.length;e<f;e++)if(d.sorters[e].key===a){d.sorters.splice(e,1);break}d.sorters.push({key:a,dir:b.toLocaleUpperCase(),type:c}),d.sorters.length>d.multiSortLimit&&d.sorters.shift()},multiSortOrder:function(a){for(var b,c,d,e=this,f=e.widget,g=f.store,h=e.sorters[a],i=e.sorters[a+1].key,j=h.key,k=0,l=e.getTotal(),m=[],n=[],o=[];k<l;k++)b=g.get(e.order[k],i,!0),d=g.get(e.order[k],j,!0),b===c?(m[m.length-1].push(d),n[n.length-1].push(e.order[k])):(m.push([d]),n.push([e.order[k]])),c=b;for(k=0,l=n.length;k<l;k++)if(1!==n[k].length){var p;if("number"===h.type)switch(h.dir){case"ASC":p=Fancy.Array.copy(m[k]).sort(function(a,b){return a-b});break;case"DESC":p=Fancy.Array.copy(m[k]).sort(function(a,b){return b-a})}else if("string"===h.type)switch(h.dir){case"ASC":p=Fancy.Array.copy(m[k]).sort();break;case"DESC":p=Fancy.Array.copy(m[k]).sort().reverse()}var q,r=n[k],s=[];q=e.getOrder(m[k],p);for(var t=0,u=q.length;t<u;t++)s.push(r[q[t]]);o=o.concat(s)}else o.push(n[k][0]);e.order=o}}),Fancy.define("Fancy.grid.plugin.Sorter",{extend:Fancy.Plugin,ptype:"grid.sorter",inWidgetName:"sorter",constructor:function(a){this.Super("const",arguments)},init:function(){var a=this;a.Super("init",arguments),a.ons()},ons:function(){var a=this;a.widget.once("render",function(){a.onsHeaders()})},onsHeaders:function(){var a=this;a.widget.on("headercellclick",a.onHeaderCellClick,a)},onHeaderCellClick:function(a,b){var c,d,e,f,g=this,h=g.widget,i=Fancy.get(b.cell),j=b.side,k=b.index,l=h.clsASC,m=h.clsDESC,n=b.e,o=n.target;if("input"!==o.tagName.toLocaleLowerCase()){var p=i.select("."+Fancy.fieldCls);p.length>0&&!0===p.item(0).within(o)||i.hasCls(h.columnResizerCls)||h.startResizing||(d=h.getColumns(j),c=i.hasCls(l)?"desc":(i.hasCls(m),"asc"),e=d[k],f=e.index||e.key,g.sort(c,f,j,e,i))}},sort:function(a,b,c,d,e){var f,g=this,h=g.widget,i=h.store,j=h.clsASC,k=h.clsDESC,l=h.getColumns(c),m=0,n=l.length,o=h.getHeader(c);if(!d||!e)for(;m<n;m++)if(l[m].index===b){d=l[m],e=o.getCell(m);break}if(!0===d.sortable){switch(h.multiSort?g.clearHeaderMultiSortCls(a,e):g.clearHeaderSortCls(),a){case"asc":e.addCls(j);break;case"desc":e.addCls(k)}f=d.type;var p,q;if(d.format)if(Fancy.isString(d.format))switch(d.format){case"date":p=h.lang.date.read,d.format.mode&&(q=d.format.mode)}else switch(d.type){case"date":p=d.format.read,d.format.mode&&(q=d.format.mode)}h.grouping&&i.remoteSort&&i.once("load",function(){h.grouping.reGroup()}),i.sort(a,f,b,{smartIndexFn:d.smartIndexFn,format:p,mode:q})}},clearHeaderMultiSortCls:function(a,b){var c,d,e=this,f=e.widget,g=f.store,h=f.clsASC,i=f.clsDESC;switch(a.toLocaleUpperCase()){case"ASC":b.removeCls(i);break;case"DESC":b.removeCls(h)}if(c=f.el.select("."+h),d=f.el.select("."+i),!(c.length+d.length<3)){for(var j,k=0,l=c.length;k<l;k++){var m,n,o,p=c.item(k),q=p.parent().parent(),r=p.attr("index");q.hasCls(f.centerCls)?m="center":q.hasCls(f.leftCls)?m="left":q.hasCls(f.rightCls)&&(m="right"),n=f.getColumns(m),o=n[r].index;var s=g.sorters[0];s.key===o&&(j=p)}for(var k=0,l=d.length;k<l;k++){var m,n,o,p=d.item(k),q=p.parent().parent(),r=p.attr("index");q.hasCls(f.centerCls)?m="center":q.hasCls(f.leftCls)?m="left":q.hasCls(f.rightCls)&&(m="right"),n=f.getColumns(m),o=n[r].index;var s=g.sorters[0];s.key===o&&(j=p)}j.removeCls(h),j.removeCls(i)}},clearHeaderSortCls:function(){var a=this,b=a.widget,c=b.clsASC,d=b.clsDESC;b.el.select("."+c).removeCls(c),b.el.select("."+d).removeCls(d)}});