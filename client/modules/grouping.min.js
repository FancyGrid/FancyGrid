Fancy.Mixin("Fancy.store.mixin.Grouping",{expand:function(a,b){var c=this,d=c.data,e=0,f=d.length,g=[],h={},i={};for(c.filteredData&&(d=c.filteredData,f=d.length),c.expanded=c.expanded||{},c.expanded[b]=!0;e<f;e++){var j=d[e];c.expanded[j.data[a]]&&(g.push(j),h[j.id]=g.length-1,i[g.length-1]=e)}c.dataView=g,c.dataViewMap=h,c.dataViewIndexes=i},collapse:function(a,b){var c=this,d=c.data,e=0,f=d.length,g=[],h={},i={};for(c.expanded=c.expanded||{},delete c.expanded[b];e<f;e++){var j=d[e];c.expanded[j.data[a]]&&(g.push(j),h[j.id]=g.length-1,i[g.length-1]=e)}c.dataView=g,c.dataViewMap=h,c.dataViewIndexes=i},changeOrderByGroups:function(a,b){for(var c,d=this,e={},f=0,g=a.length,h=[];f<g;f++)e[a[f]]=[];for(f=0,g=d.data.length;f<g;f++){c=d.data[f];e[c.data[b]].push(c)}for(f=0,g=a.length;f<g;f++)h=h.concat(e[a[f]]);d.grouping={by:b},d.data=h},getColumnOriginalValuesByGroup:function(a,b,c){var d=this,e=d.data,f=0,g=e.length,h=[],i=[],j=e[0].data[b];if(c&&c.format&&"date"===c.type)for(;f<g;f++)e[f].data[b]===j?i.push(Fancy.Date.parse(e[f].data[a],c.format,c.mode)):(h.push({values:i,groupName:j}),i=[],j=e[f].data[b],f--);else for(;f<g;f++)e[f].data[b]===j?i.push(e[f].data[a]):(h.push({values:i,groupName:j}),i=[],j=e[f].data[b],f--);return g>0&&h.push({values:i,groupName:j}),h}}),Fancy.define("Fancy.grid.plugin.Grouping",{extend:Fancy.Plugin,ptype:"grid.grouping",inWidgetName:"grouping",tpl:"{text}:{number}",_renderFirstTime:!0,groupRowInnerCls:"fancy-grid-group-row-inner",constructor:function(a){this.Super("const",arguments)},init:function(){var a=this,b=a.widget;a.Super("init",arguments),a._expanded={},a.initTpl(),a.initGroups(),a.initOrder(),a.calcPlusScroll(),a.configParams(),a.ons(),!a.collapsed&&b.store.data&&setTimeout(function(){b.store.changeDataView({doNotFired:!0}),b.update()},100)},initTpl:function(){var a=this;a.tpl&&(a.tpl=new Fancy.Template(a.tpl))},ons:function(){var a=this,b=a.widget;b.once("render",function(){a.renderGroupedRows(),a.update(),b.el.on("click",a.onClick,a,"div."+b.clsGroupRow),b.el.on("mousedown",a.onMouseDown,a,"div."+b.clsGroupRow),b.on("scroll",a.onScroll,a),b.on("columnresize",a.onColumnResize,a)})},initGroups:function(a){var b=this,c=b.widget,d=c.store,a=a||"data";if(!b.by)throw new Error("[FancyGrid Error] - not set by param in grouping");for(var e=d.getColumnOriginalValues(b.by,{dataProperty:a,groupMap:!0}),f={},g=0,h=e.length;g<h;g++)void 0===f[e[g]]&&(f[e[g]]=0),f[e[g]]++;var i=[];for(var j in f)i.push(j);b.groups=i,b.groupsCounts=f},getGroupById:function(a){return this.widget.store.groupMap[a]},getGroupOrderIndex:function(a){for(var b=this,c=b.groups,d=0,e=c.length;d<e;d++)if(c[d]===a)return d},initOrder:function(){var a,b,c=this,d=c.widget,e=d.store,f=[],g={},h=[];if(c.order&&0!==c.order.length)switch(Fancy.typeOf(c.order)){case"string":break;case"array":f=c.groups}else{for(f=c.groups,a=0,b=f.length;a<b;a++){var i=f[a].toLocaleUpperCase();g[i]=f[a],h.push(i)}for(h=h.sort(),a=0;a<b;a++)f[a]=g[h[a]]}c.groups=f,e.changeOrderByGroups(f,c.by)},calcPlusScroll:function(){var a=this,b=a.widget;a.plusScroll=a.groups.length*b.groupRowHeight},configParams:function(){var a,b,c=this,d=c.widget,e=d.store;if(c.expanded=c.expanded||{},e.expanded=e.expanded||{},c.collapsed)e.collapsed=!0;else for(a=0,b=c.groups.length;a<b;a++)void 0===c.expanded[c.groups[a]]&&(e.expanded[c.groups[a]]=!0,c.expanded[c.groups[a]]=!0,c._expanded[c.groups[a]]=!0)},renderGroupedRows:function(){var a,b,c=this,d=c.widget,e=d.columns,f=d.leftColumns,g=d.rightColumns,h=d.body,i=d.leftBody,j=d.rightBody,k=0,l=0,m=0,n=0;for(a=e.length;k<a;k++)e[k].hidden||(l+=e[k].width);for(k=0,a=f.length;k<a;k++)f[k].hidden||(m+=f[k].width);for(k=0,a=g.length;k<a;k++)g[k].hidden||(n+=g[k].width);k=0,a=c.groups.length;for(var o=0;k<a;k++){var p=c.groups[k],q=c.groupsCounts[p];m?(b=c.generateGroupRow(p,q,!0,o),b.css("width",m),i.el.dom.appendChild(b.dom),b=c.generateGroupRow(p,q,!1,o),b.css("width",l),h.el.dom.appendChild(b.dom)):(b=c.generateGroupRow(p,q,!0,o),b.css("width",l),h.el.dom.appendChild(b.dom)),n&&(b=c.generateGroupRow(p,q,!1,o),b.css("width",n),j.el.dom.appendChild(b.dom)),c.collapsed&&(o+=d.groupRowHeight)}},removeGroupRows:function(){var a=this,b=a.widget,c=b.columns,d=b.leftColumns,e=b.rightColumns,f=b.body,g=b.leftBody,h=b.rightBody;c.length&&f.el.select(".fancy-grid-group-row").remove(),d.length&&g.el.select(".fancy-grid-group-row").remove(),e.length&&h.el.select(".fancy-grid-group-row").remove()},removeCells:function(){var a=this,b=a.widget,c=b.columns,d=b.leftColumns,e=b.rightColumns,f=b.body,g=b.leftBody,h=b.rightBody;c.length&&f.el.select(".fancy-grid-cell").remove(),d.length&&g.el.select(".fancy-grid-cell").remove(),e.length&&h.el.select(".fancy-grid-cell").remove()},generateGroupRow:function(a,b,c,d){var e=this,f=e.widget,g=f.clsGroupRow,h=Fancy.get(document.createElement("div")),i=e.groupRowInnerCls;if(h.addClass(g),h.attr("group",a),c){var j=e.tpl.getHTML({text:a,number:b});h.update('<div class="'+i+'"> '+j+"</div>")}return e.collapsed?(h.css("top",d+"px"),h.addClass(f.clsCollapsedRow)):h.css("top","0px"),h},insertGroupEls:function(){var a=this,b=a.widget,c=b.leftBody,d=b.body,e=a.groupRowInnerCls;b.leftColumns.length?c.el.select(".fancy-grid-group-row").each(function(b){var c=a.groups[i];b.update('<div class="'+e+'">'+c+"</div>")}):d.el.select(".fancy-grid-group-row").each(function(b,c){var d=a.groups[c],f=a.groupsCounts[d],g=a.tpl.getHTML({text:d,number:f});b.update('<div class="'+e+'">'+g+"</div>")})},onClick:function(a){var b,c=this,d=c.widget,e=d.clsCollapsedRow,f=Fancy.get(a.currentTarget),g=f.attr("group");d.el.select("."+d.clsGroupRow+'[group="'+g+'"]').toggleClass(e),b=f.hasClass(e),b?c.collapse(c.by,g):c.expand(c.by,g),c.update()},fastCollapse:function(){},onMouseDown:function(a){a.preventDefault()},onScroll:function(){var a=this;a.widget;a.setPositions()},collapse:function(a,b){var c=this,d=c.widget;d.store.collapse(a,b),delete c._expanded[b],delete c.expanded[b],d.fire("collapse",a,b)},expand:function(a,b){var c=this,d=c.widget;d.store.expand(a,b),c._expanded[b]=!0,c.expanded[b]=!0,d.fire("expand",a,b)},setPositions:function(){for(var a=this,b=a.widget,c=0,d=a.groups.length,e=-b.scroller.scrollTop||0,f=b.clsGroupRow,g=b.leftBody.el.select("."+f),h=b.body.el.select("."+f),i=b.rightBody.el.select("."+f);c<d;c++){var j=a.groups[c];if(g.length&&g.item(c).css("top",e+"px"),h.length&&h.item(c).css("top",e+"px"),i.length&&i.item(c).css("top",e+"px"),b.expander){var k=b.expander.expandedGroups[j];for(var l in k){var m=k[l];e+=parseInt(m.el.css("height"))}}e+=b.groupRowHeight,!0===a._expanded[j]&&(e+=a.groupsCounts[j]*b.cellHeight)}},setCellsPosition:function(a,b){for(var c,d,e=this,f=e.widget,g=0,h=e.groups.length,i=0,j=f.body,k=f.leftBody,l=f.rightBody,m=0,n=f.groupRowHeight,o=[],p={},q={},r=e.by;g<h;g++){var s=e.groups[g];if(!0===e._expanded[s]){if(o.push(m),p[m]=!0,void 0===b||"center"===b)if(i=0,c=f.columns.length,void 0!==a&&(i=a,c=a+1),f.expander){var t=f.get(m),u=t.get(r),v=f.expander.expandedGroups,w=e.getGroupOrderIndex(s),x=0;for(var y in v){var z=e.getGroupOrderIndex(y);if(!(w<=z)){var A=v[y];for(var B in A){var C=A[B];if("none"!==C.el.css("display")&&!q[B]){var D=m-1;m<0&&(m=0),D=f.get(D);var E=D.get(r);u!==E?D.id===B&&(q[B]=!0,x+=parseInt(C.el.css("height"))):(q[B]=!0,x+=parseInt(C.el.css("height")))}}}}for(n+=x,d=j.getCell(m,i);i<c;i++)d=j.getCell(m,i),d.css("margin-top",n+"px")}else for(;i<c;i++)d=j.getCell(m,i),d.css("margin-top",n+"px");if(void 0===b||"left"===b)for(i=0,c=f.leftColumns.length,void 0!==a&&(i=a,c=a+1);i<c;i++)d=k.getCell(m,i),d.css("margin-top",n+"px");if(void 0===b||"right"===b)for(i=0,c=f.rightColumns.length,void 0!==a&&(i=a,c=a+1);i<c;i++)d=l.getCell(m,i),d.css("margin-top",n+"px");m+=e.groupsCounts[s],n=f.groupRowHeight}else n+=f.groupRowHeight}if(e._renderFirstTime)e._renderFirstTime=!1;else{for(var g=0,h=e.prevRows.length,F=[];g<h;g++){var G=e.prevRows[g];!0!==p[G]&&F.push(G)}e.clearMargins(F)}e.prevRows=o},setExpanderCellsPosition:function(){for(var a,b,c=this,d=c.widget,e=d.store,f=e.dataView,g=d.body,h=d.leftBody,i=d.rightBody,j=d.expander.expandedGroups,k=c.groupsCounts,l=0,m=c.groups.length,n=d.groupRowHeight,o=0,p=0;l<m;l++){var q=c.groups[l];if(!0===c._expanded[q]){for(var r=o+k[q];o<r;o++)if(b=f[o]){var s=b.id,t=j[q][s];p&&(n+=p,p=0),t&&(p=parseInt(t.el.css("height")));for(var u=0,v=d.columns.length;u<v;u++)a=g.getCell(o,u),a.css("margin-top",n+"px");if(d.leftColumns)for(var u=0,v=d.leftColumns.length;u<v;u++)a=h.getCell(o,u),a.css("margin-top",n+"px");if(d.rightColumns)for(var u=0,v=d.rightColumns.length;u<v;u++)a=i.getCell(o,u),a.css("margin-top",n+"px");n=0}n=d.groupRowHeight}else n+=d.groupRowHeight}},clearMargins:function(a){var b=this,a=a||b.prevRows;if(void 0!==a)for(var c,d,e,f=b.widget,g=f.body,h=f.leftBody,i=f.rightBody,j=0,k=0,l=a.length;j<l;j++){for(d=a[j],k=0,c=f.columns.length;k<c&&(e=g.getCell(d,k),void 0!==e.dom);k++)e.css("margin-top","0px");for(k=0,c=f.leftColumns.length;k<c&&(e=h.getCell(d,k),void 0!==e.dom);k++)e.css("margin-top","0px");for(k=0,c=f.rightColumns.length;k<c&&(e=i.getCell(d,k),void 0!==e.dom);k++)e.css("margin-top","0px")}},onColumnResize:function(){this.updateGroupRows()},updateGroupRows:function(){var a,b=this,c=b.widget,d=c.leftColumns,e=c.columns,f=c.rightColumns,g=c.body,h=c.leftBody,i=c.rightBody,j=0,k=0;for(a=e.length;j<a;j++)k+=e[j].width;for(g.el.select(".fancy-grid-group-row").css("width",k+"px"),j=0,k=0,a=d.length;j<a;j++)k+=d[j].width;for(a&&h.el.select(".fancy-grid-group-row").css("width",k+"px"),j=0,k=0,a=f.length;j<a;j++)k+=f[j].width;a&&i.el.select(".fancy-grid-group-row").css("width",k+"px")},update:function(a){var b=this,c=b.widget,d=c.store;if(!a&&(!0===d.loading||!1===d.autoLoad))return void d.once("load",function(){b.initGroups(),b.initOrder(),b.calcPlusScroll(),b.configParams(),d.changeDataView({doNotFired:!0}),b.renderGroupedRows(),b.update(!0)},b);b.setPositions(),c.update(),c.scroller.update(),b.setCellsPosition(),c.setSidesHeight()},getOffsetForRow:function(a){for(var b=this,c=b.widget,d=0,e=b.groups.length,f=0,g=0;d<e;d++){var h=b.groups[d];if(f+=c.groupRowHeight,!0===b._expanded[h]&&(g+=b.groupsCounts[h]),a<g)break}return f},getSpecialRowsUnder:function(a){for(var b=this,c=b.widget,d=0,e=b.groups.length,f=0,g=0,h=0;d<e;d++){var i=b.groups[d];a<g&&h++,f+=c.groupRowHeight,!0===b._expanded[i]&&(g+=b.groupsCounts[i])}return h},reGroup:function(){var a=this,b=a.widget,c=b.store,d="data";a.expanded={},a._expanded={},b.store.expanded={},b.store.dataView=[],a.collapsed=!0,b.store.filteredData&&(d="filteredData"),a.removeGroupRows(),a.removeCells(),a.initGroups(d),c.remoteFilter&&a.initOrder(),a.calcPlusScroll(),a.configParams(),a.renderGroupedRows(),b.setSidesHeight()},scrollLeft:function(a){var b=this,c=b.widget;c.body.el.select("."+c.clsGroupRow).css("left",a)}});