Fancy.modules.tree=!0,Fancy.Mixin("Fancy.store.mixin.Tree",{initTreeData:function(a){var b=this,a=a||b.data;b.isTree=!0,a&&0!==a.length&&(a=Fancy.isObject(a)?b.treeReadData(a.items):b.treeReadData(a),b.setData(a))},treeReadData:function(a,b,c){var d=this,e=d.widget,f=[];return b=b||1,Fancy.each(a,function(a){a.data&&(a=a.data),a.$deep=b,a.leaf=!!a.leaf,a.expanded=!!a.expanded,Fancy.isArray(a.filteredChild)&&a.filteredChild.length?a.leaf=!1:a.child&&a.child.length&&(a.leaf=!1),c&&(a.parentId=c),a.id||(Fancy.idSeed++,a.id=Fancy.idSeed+1e3),f.push(a),a.expanded&&(a.id&&(e.tree?e.tree.expandMap[a.id]=!0:(e._tempExpandMap=e._tempExpandMap||{},e._tempExpandMap[a.id]=!0)),f=f.concat(d.treeReadData(a.child||[],b+1,a.id)))}),f},treeGetDataAsTree:function(){var a=this,b=[];return Fancy.each(a.data,function(a){1===a.get("$deep")&&b.push(a)}),b},treeSort:function(a,b,c,d,e){var f=this,g=[],h=[],i={},j=[];Fancy.each(a,function(a){var b=a.data||a;g.push(b[c]),void 0===i[b[c]]?i[b[c]]=a:(Fancy.isArray(i[b[c]])||(i[b[c]]=[i[b[c]]]),i[b[c]].push(a))});var k=!1,l=!1;if(g.length){k=!0,l=!0;var m;Fancy.each(a,function(a){var b=a.data||a;""!==b[c]&&(k=!1),void 0!==m&&m!==b[c]&&(l=!1),m=b[c]})}if("number"===d)switch(b){case"asc":h=e?Fancy.Array.copy(g).sort(function(a,b){return e("asc",a,b)}):Fancy.Array.copy(g).sort(function(a,b){return a-b});break;case"desc":h=e?Fancy.Array.copy(g).sort(function(a,b){return e("desc",a,b)}):Fancy.Array.copy(g).sort(function(a,b){return b-a})}else switch(b){case"asc":h=Fancy.Array.copy(g).sort();break;case"desc":h=Fancy.Array.copy(g).sort(),h=h.reverse()}return Fancy.each(h,function(e,g){var h=i[e];Fancy.isArray(h)&&(h=h.splice(0,1)[0]),(k||l)&&(h=a[g]);var m=h.data||h;m.child&&m.expanded&&(h.data.sorted=f.treeSort(m.child,b,c,d)),j.push(h)}),j},treeReadSortedId:function(a){var b=this,c=[];return Fancy.each(a,function(a){c.push(a.id),a=b.getById(a.id),a.data.expanded&&(a.data.sorted?c=c.concat(b.treeReadSortedId(a.data.sorted)):a.data.child&&(c=c.concat(b.treeReadSortedId(a.data.child))))}),c},treeReBuildData:function(){var a=this,b=[],c=[];Fancy.each(a.data,function(a){1===a.get("$deep")&&b.push(a.data)}),c=a.treeReadData(b),a.setData(c)}}),function(){var a=Fancy,b=a.GRID_COLUMN_TREE_EXPANDER_CLS,c=function(a,b){b=b||0;var d=this,e=d.widget;return Fancy.each(a,function(a){b++;var f=a.data?a.data:a;e.store.filteredData?f.id&&e.store.map[f.id]&&(f=e.store.map[f.id].data):f=e.getById(f.id).data;var g=f.child;g&&f.expanded&&(b+=c.apply(d,[g]))}),b};Fancy.define("Fancy.grid.plugin.Tree",{extend:Fancy.Plugin,ptype:"grid.tree",inWidgetName:"tree",singleExpand:!1,constructor:function(a){this.Super("const",arguments)},init:function(){var a=this,b=a.widget;a.expandMap={},b._tempExpandMap&&(a.expandMap=b._tempExpandMap),a.Super("init",arguments),a.ons()},ons:function(){var a=this,b=a.widget;b.once("init",function(){b.on("rowdblclick",a.onRowDBLClick,a),b.on("cellclick",a.onTreeExpanderClick,a),b.on("beforesort",a.onBeforeSort,a)})},onRowDBLClick:function(a,b){var c=this,d=c.widget,e=b.item;if(!(e.get("leaf")||d.edit&&2===d.edit.clicksToEdit)){e.get("expanded")?c.collapseRow(b.item):c.expandRow(b.item)}},onTreeExpanderClick:function(a,c){var d=this,e=c.item;Fancy.get(c.e.target).hasClass(b)&&!e.get("leaf")&&(e.get("expanded")?d.collapseRow(c.item):d.expandRow(c.item))},collapseRow:function(a){var b=this,d=b.widget,e=d.store,f=a.get("child"),g=(a.get("filteredChild"),a.get("id"));d.$onChangeUpdate=!1,b.expandMap[g]=!1,a.set("expanded",!1);var h=e.getRow(a.get("id")),i=0,j=c.apply(this,[f]);if(e.filteredData){var k,l=a.get("id"),m={};m[l]=!0;for(var n,i=0,j=e.data.length;i<j&&(a=e.data[i],!(n&&n>=a.data.$deep));i++){if(m[a.data.parentId]){n||(n=a.data.$deep-1),k||(k=i);var o=e.data.splice(k,1)[0];o.data.child&&(m[o.data.id]=!0),delete e.map[o.id],i--,j--}a.data.child&&n&&(m[a.data.id]=!0)}e.order&&(delete e.order,delete e.filterOrder,e.reSort()),e.changeDataView()}else{for(d.store.treeCollapsing=!0;i<j;i++)d.removeAt(h+1);delete d.store.treeCollapsing}delete d.$onChangeUpdate,d.update(),d.fire("treecollapse")},expandRow:function(a){var b,c=this,d=c.widget,e=d.store,f=a.get("child"),g=(a.get("filteredChild"),a.get("id")),h=a.get("parentId");if(d.$onChangeUpdate=!1,c.singleExpand)if(h){var i=d.getById(h);b=i.get("child"),Fancy.each(b,function(a){var b=a.get("expanded");void 0!==c.expandMap[a.id]&&(b=c.expandMap[a.id]),!0===b&&c.collapseRow(d.getById(a.id))})}else b=d.findItem("parentId",""),Fancy.each(b,function(a){var b=a.get("expanded");void 0!==c.expandMap[a.id]&&(b=c.expandMap[a.id]),!0===b&&c.collapseRow(a)});c.expandMap[g]=!0,a.set("expanded",!0);var j=e.getRow(a.get("id")),k=a.get("$deep")+1,l=!1;if(e.filteredData){var m=a.get("id");Fancy.each(e.data,function(a,b){if(a.id===m)return j=b,!0})}var n=function(a,b,e,f){return f=f||g,Fancy.each(a,function(a,g){var h=a.data;a.data||(l=!0,h=a),h.$deep=e,h.parentId=f;var i=h.expanded;if(void 0!==c.expandMap[h.id]?(i=c.expandMap[h.id],h.expanded=i):void 0!==h.child&&(h.expanded=!1),b++,d.insert(b,h),!0===i){var j=h.child;h.filteredChild,b=n(j,b,e+1,h.id)}}),b};d.store.treeExpanding=!0,n(f,j,k),delete d.store.treeExpanding,l&&Fancy.each(a.data.child,function(b,c){var d=e.getById(b.id);void 0!==d&&(a.data.child[c]=d)}),delete d.$onChangeUpdate,d.update(),e.sorters&&e.order&&(delete e.order,delete e.filterOrder,e.reSort()),d.fire("treeexpand")},onBeforeSort:function(a,b){var c=this;"drop"===b.action&&c.onDropSort()},onDropSort:function(){this.widget.store.treeReBuildData()}})}();