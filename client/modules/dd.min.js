Fancy.modules.dd=!0,function(){var a=Fancy,b=a.GRID_BODY_CLS,c=a.GRID_CLS,d=a.GRID_CELL_CLS;a.define("Fancy.grid.plugin.GridToGrid",{extend:a.Plugin,ptype:"grid.dragdrop",inWidgetName:"dragdrop",dropOK:!1,cellMaskCls:"fancy-drop-cell-mask",dropZoneCls:"fancy-drop-zone-active",dropOkCls:"fancy-drop-ok",dropNotOkCls:"fancy-drop-not-ok",dropHeaderMaskCls:"fancy-drop-header-mask",droppable:!0,dropZoneOverClass:b,constructor:function(){this.Super("const",arguments)},init:function(){var a=this;a.addEvents("drop"),a.Super("init",arguments),a.initDropCls(),a.initEnterLeave(),a.ons()},initDropCls:function(){var a=this,b="."+a.dropGroup;b+=" ."+a.dropZoneOverClass,a.dropCls=b},addDragDropCls:function(){this.widget.el.addCls(this.dragGroup)},ons:function(){var a=this,b=a.widget;b.on("render",function(){a.addDragDropCls()}),a.dropGroup&&(b.on("beforecellmousedown",a.onBeforeCellMouseDown,a),b.on("cellmousedown",a.onCellMouseDown,a),b.on("cellleave",a.onCellLeave,a),b.on("cellenter",a.onCellEnter,a)),a.on("drop",a.onDropItems,a)},onDropItems:function(a,b){var c=this,d=c.widget,e=c.dropGrid,f=void 0===e.activeRowEnterIndex?e.getViewTotal():e.activeRowEnterIndex;d.fire("dropitems",b,f),c.onDrop&&c.onDrop.apply(d,[b,f])},onBeforeCellMouseDown:function(b,c){var d=this,e=d.widget,f=e.lang,g=a.get(document),h=e.getSelection();if((!c.e.ctrlKey||!0!==e.multiSelect)&&h.length>1){var i=!1;if(a.each(h,function(a){if(a.id===c.id)return i=!0,!0}),!1===i)return;e.stopSelection(),g.once("mouseup",d.onDocMouseUp,d),g.on("mousemove",d.onDocMouseMove,d),g.once("mouseup",function(){e.enableSelection()},d),h=e.getSelection();var j=a.String.format(f.dragText,[h.length,h.length>1?"s":""]);d.initTip(j),d.dragItems=e.getSelection(),d.cellMouseDown=!0}},onCellMouseDown:function(b,c){var d=this,e=d.widget,f=a.get(document);if(!1!==e.selection.enabled){c.e.ctrlKey&&!0===e.multiSelect||("$selected"===c.column.index||e.clearSelection(),f.once("mouseup",d.onDocMouseUp,d),f.on("mousemove",d.onDocMouseMove,d),d.cellMouseDown=!0,d.activeRowIndex=c.rowIndex)}},initEnterLeave:function(){var b=this,c=a.select(b.dropCls);if(0===c.length)return void setTimeout(function(){b.initEnterLeave()},500);c.on("mouseenter",b.onMouseEnterDropGroup,b),c.on("mouseleave",b.onMouseLeaveDropGroup,b)},onMouseEnterDropGroup:function(b){var d=this;if(d.cellMouseDown){var e=a.get(b.currentTarget);if(d.dropGrid=a.getWidget(e.closest("."+c).attr("id")),d.dropGrid&&d.dropGrid.dragdrop&&!1===d.dropGrid.dragdrop.droppable)return d.dropOK=!1,void(d.tip&&d.tip.el.replaceClass(d.dropOkCls,d.dropNotOkCls));d.setDropGridCellsMask(),d.dropGridEventInited||d.onsDropGrid(),e.addCls(d.dropZoneCls),d.dropOK=!0,d.tip&&d.tip.el.replaceClass(d.dropNotOkCls,d.dropOkCls)}},onMouseLeaveDropGroup:function(b){var c=this;c.cellMouseDown&&(a.get(b.currentTarget).removeCls(c.dropZoneCls),c.dropOK=!1,c.tip.el.replaceClass(c.dropOkCls,c.dropNotOkCls),c.clearCellsMask())},setDropGridCellsMask:function(){var a,b=this,c=b.dropGrid;c&&b.cellMouseDown&&(a=c.getTotal(),0===a?c.el.addCls(b.dropHeaderMaskCls):c.el.select("."+d+'[index="'+(a-1)+'"]').addCls(b.cellMaskCls))},onsDropGrid:function(){var a=this;a.dropGrid.on("rowenter",a.onDropGridRowEnter,a),a.dropGrid.on("rowleave",a.onDropGridRowLeave,a),a.dropGridEventInited=!0},onDropGridRowEnter:function(a,b){var c=this;!1===c.cellMouseDown&&(c.dropGrid.un("rowenter",c.onDropGridRowEnter),c.dropGrid.un("rowleave",c.onDropGridRowLeave)),c.clearCellsMask(),0===b.rowIndex?a.el.addCls(c.dropHeaderMaskCls):a.el.select("."+d+'[index="'+(b.rowIndex-1)+'"]').addCls(c.cellMaskCls),!1===c.cellMouseDown&&c.clearCellsMask(),c.dropGrid&&(c.dropGrid.activeRowEnterIndex=b.rowIndex)},onDropGridRowLeave:function(){var a=this;a.clearCellsMask(),a.setDropGridCellsMask(),a.dropGrid&&delete a.dropGrid.activeRowEnterIndex},clearCellsMask:function(){var a=this,b=a.cellMaskCls;a.dropGrid&&(a.dropGrid.el.removeCls(a.dropHeaderMaskCls),a.dropGrid.el.select("."+b).removeCls(b))},onDocMouseUp:function(){var b=this,c=b.widget,d=a.get(document);b.cellMouseDown=!1,b.tip&&b.tip.hide(),c.enableSelection(),d.un("mousemove",b.onDocMouseMove),!0===b.dropOK&&(c.clearSelection(),b.dropGrid.clearSelection(),b.fire("drop",b.dragItems)),delete b.dragItems,b.dropOK=!1,a.select("."+b.dropZoneCls).removeCls(b.dropZoneCls),b.clearCellsMask(),b.dropGrid&&(b.dropGrid.un("rowenter",b.onDropGridRowEnter),b.dropGrid.un("rowleave",b.onDropGridRowLeave)),delete b.dropGridEventInited},onDocMouseMove:function(a){this.dragItems&&this.tip.show(a.pageX+20,a.pageY+20)},onCellLeave:function(b,c){var d=this,e=d.widget,f=e.lang;setTimeout(function(){if(d.onceStopDrag)return void(d.onceStopDrag=!1);if(!0===d.cellMouseDown&&!d.dragItems){var b=e.getSelection(),g=a.String.format(f.dragText,[b.length,b.length>1?"s":""]);e.stopSelection(),d.initTip(g,c.e),d.tip.show(),d.tip.el.css("display","block"),d.dragItems=b}},1)},onCellEnter:function(a,b){var c=this;!0!==c.cellMouseDown||c.dragItems||b.rowIndex!==c.activeRowIndex&&(c.onceStopDrag=!0,c.activeRowIndex=b.rowIndex)},initTip:function(b,c){var d=this,e=d.dropNotOkCls;d.tip||(d.tip=new a.ToolTip({cls:e,text:b})),c&&d.tip.show(c.pageX+20,c.pageY+20),d.tip.update(b),d.tip.el.replaceClass(d.dropOkCls,e)}})}(),function(){var a=Fancy;a.define("Fancy.DragRowsManager",{singleton:!0,constructor:function(){this.draggingRows=[]},add:function(a,b){var c=this,d=Fancy.get(document);c.activeGrid=a,c.draggingRows=b,d.on("mouseenter",c.onMouserEnterGrid,c,"."+Fancy.GRID_CLS),c.activeGrid.dropZone&&c.activeGrid.el.on("mouseleave",c.onMouseLeaveActiveGrid,c)},remove:function(){var a=this,b=Fancy.get(document);a.activeGrid&&a.activeGrid.dropZone&&b.un("mousemove",a.onMouseMoveOutSideActiveGrid),delete a.activeGrid,delete a.draggingRows,delete a.toGrid,delete a.droppable,delete a.dropOutSideRowIndex,b.un("mouseenter",a.onMouserEnterGrid)},onMouserEnterGrid:function(b){var c=this,d=Fancy.get(b.currentTarget);if(d.id!==c.activeGrid.el.id){if(c.toGrid?c.toGrid.id!==d.id&&(c.toGrid=Fancy.getWidget(d.id)):c.toGrid=Fancy.getWidget(d.id),!c.toGrid)return!0;if(!0===c.toGrid.droppable||a.isFunction(c.toGrid.droppable)&&!0===c.toGrid.droppable(c.activeGrid,c.draggingRows)){c.droppable=!0;Fancy.get(document).once("mouseleave",c.onMouseLeaveGrid,c,"#"+c.toGrid.id),setTimeout(function(){if(void 0===c.dropOutSideRowIndex&&c.toGrid){var a=c.toGrid.getDisplayedData().length-1;c.toGrid.rowdragdrop.activeRowIndex=a+1,c.toGrid.rowdragdrop.insertItem=c.toGrid.get(a+1),c.dropOutSideRowIndex=a+1,c.toGrid.rowdragdrop.showCellsDropMask()}},100)}}},onMouseLeaveGrid:function(){var a=this;delete a.droppable,delete a.toGrid,delete a.dropOutSideRowIndex},onMouseLeaveActiveGrid:function(){var a=this,b=Fancy.get(document);a.activeGrid&&a.activeGrid.el&&(b.on("mousemove",a.onMouseMoveOutSideActiveGrid,a),a.activeGrid.el.on("mouseenter",function(){b.un("mousemove",a.onMouseMoveOutSideActiveGrid)}))},onMouseMoveOutSideActiveGrid:function(b){var c=this,d=b.target,e=d.tagName.toLocaleLowerCase();if(!c.dropEl){switch(e){case"html":case"document":case"body":return}c.hoverEl!==d&&(c.hoverEl=d,c.activeGrid.dropZone(c.hoverEl)?(c.dropEl=a.get(c.hoverEl),c.dropEl.once("mouseleave",function(){delete c.dropEl,delete c.hoverEl,c.activeGrid&&(c.activeGrid.rowdragdrop.dropOK=!1)}),c.activeGrid.rowdragdrop.dropOK=!0):c.activeGrid.rowdragdrop.dropOK=!1)}}})}(),function(){var a=Fancy,b=a.DragRowsManager,c=a.GRID_BODY_CLS,d=a.GRID_CELL_CLS,e=a.GRID_CELL_SELECTED_CLS;a.define("Fancy.grid.plugin.RowDragDrop",{extend:a.Plugin,ptype:"grid.rowdragdrop",inWidgetName:"rowdragdrop",dropOK:!1,cellMaskCls:"fancy-drop-cell-mask",cellFirstRowMaskCls:"fancy-drop-cell-first-mask",dropZoneCls:"fancy-drop-zone-active",dropOkCls:"fancy-drop-ok",dropNotOkCls:"fancy-drop-not-ok",droppable:!0,dropZoneOverClass:c,tipShown:!1,constructor:function(){this.Super("const",arguments)},init:function(){var a=this;a.Super("init",arguments),a.addEvents("drop","start","dropoutside"),a.ons(),a.initDropCls(),a.initEnterLeave()},ons:function(){var a=this,b=a.widget;b.on("beforecellmousedown",a.onBeforeCellMouseDown,a),b.on("cellmousedown",a.onCellMouseDown,a),b.on("rowenter",a.onRowEnter,a),b.on("rowleave",a.onRowLeave,a,null,100),a.on("drop",a.onDrop,a),a.on("dropoutside",a.onDropOutSide,a),a.on("start",a.onStart,a)},disableSelectionMove:function(){this.widget.selection.disableSelectionMove()},showTip:function(a){var b,c=this,d=c.widget;b=c.singleRowToDrag?[c.singleRowToDrag.data]:d.getSelection(),0!==b.length&&(c.tip||c.initTip(),c.updateTipText(),a&&c.tip.show(a.pageX+20,a.pageY+20),c.tipShown=!0)},hideTip:function(){var a=this;a.tip&&a.tip.hide(),a.tipShown=!1},onCellMouseDown:function(b,c){var d=this,e=a.get(document),f=a.get(c.e.target),g=f.dom.tagName.toLocaleLowerCase();"svg"!==g&&"path"!==g||(d.cellMouseDown=a.get(c.cell),e.once("mouseup",d.onDocMouseUp,d))},onDocMouseUp:function(){var c=this,d=c.widget,e=a.get(document);c.cellMouseDown=!1,c.mouseDownDragEl=!1,delete c.tipValue,c.tipShown&&(e.un("mousemove",c.onDocMouseMove),c.hideTip(),c.clearCellsMask(),c.dropOK?c.fire("drop"):b.droppable&&c.fire("dropoutside"),c.tipShown=!1),d.selection&&(setTimeout(function(){d.selection.clearOverCells()},1),d.enableSelection()),b.remove(),delete c.singleRowToDrag},onRowEnter:function(c,d){var f=this,g=f.widget,h=f.singleRowToDrag?[f.singleRowToDrag.data]:g.getSelection();if(b.droppable&&b.toGrid.id===g.id)b.dropOutSideRowIndex=d.rowIndex;else if(!(f.cellMouseDown&&0!==h.length&&f.tipShown||f.singleRowToDrag))return;if(0!==d.rowIndex){var i=d.rowIndex-1;if(f.singleRowToDrag&&(f.singleRowToDrag.rowIndex===i||f.singleRowToDrag.rowIndex===d.rowIndex)||g.body.getCell(i,0).hasClass(e)&&!f.singleRowToDrag)return f.dropOK=!1,f.clearCellsMask(),void delete f.activeRowIndex;if(f.singleRowToDrag&&(d.rowIndex===f.singleRowToDrag.rowIndex||i===f.singleRowToDrag.rowIndex)||!f.singleRowToDrag&&g.body.getCell(d.rowIndex,0).hasClass(e)&&1===h.length)return f.dropOK=!1,f.clearCellsMask(),void delete f.activeRowIndex;if(h.length>1){var i,j=!0;if(a.each(h,function(a){if(void 0===i)return void(i=g.getRowById(a.id));var b=g.getRowById(a.id);if(i!==b-1)return j=!1,!0;i=b}),j&&g.body.getCell(d.rowIndex,0).hasClass(e))return f.dropOK=!1,f.clearCellsMask(),void delete f.activeRowIndex}f.dropOK=!0;var k=g.get(i);f.insertItem=k}else{if(g.body.getCell(d.rowIndex,0).hasClass(e)){if(!(h.length>1))return f.dropOK=!1,f.clearCellsMask(),void delete f.activeRowIndex;var i,j=!0;if(a.each(h,function(a){if(void 0===i)return void(i=g.getRowById(a.id));var b=g.getRowById(a.id);if(i!==b-1)return j=!1,!0;i=b}),j&&g.body.getCell(d.rowIndex,0).hasClass(e))return f.dropOK=!1,f.clearCellsMask(),void delete f.activeRowIndex;f.dropOK=!0}else f.dropOK=!0;f.insertItem=0}var l=g.selection.memory;if(l&&l.all&&0===l.exceptedLength)return f.dropOK=!1,void delete f.activeRowIndex;f.activeRowIndex=d.rowIndex,f.showCellsDropMask()},initTip:function(){var b=this,c=b.dropNotOkCls;b.tip||(b.tip=new a.ToolTip({cls:c,text:""}))},updateTipText:function(){var c=this,d=c.widget,e=d.lang,f=c.singleRowToDrag?[c.singleRowToDrag.data]:d.getSelection(),g=a.String.format(e.dragText,[f.length,f.length>1?"s":""]);c.tipValue&&1===f.length&&(g=c.tipValue),c.tip.update(g),f.length&&0!=c.dropOK?c.tip.el.replaceClass(c.dropNotOkCls,c.dropOkCls):b.droppable?c.tip.el.replaceClass(c.dropNotOkCls,c.dropOkCls):c.tip.el.replaceClass(c.dropOkCls,c.dropNotOkCls)},onDocMouseMove:function(a){var c=this;c.singleRowToDrag||c.cellMouseDown&&c.cellMouseDown.hasClass(e)?(b.activeGrid||c.fire("start"),c.showTip(a)):c.hideTip()},showCellsDropMask:function(){var a=this,b=a.widget,c=a.activeRowIndex-1;a.clearCellsMask(),-1===c?b.el.select("."+d+'[index="0"]').addCls(a.cellFirstRowMaskCls):b.el.select("."+d+'[index="'+c+'"]').addCls(a.cellMaskCls)},clearCellsMask:function(){var a=this,b=a.widget;b.el.select("."+a.cellMaskCls).removeCls(a.cellMaskCls),b.el.select("."+a.cellFirstRowMaskCls).removeCls(a.cellFirstRowMaskCls)},onStart:function(){var a,c=this,d=c.widget;a=c.singleRowToDrag?[c.singleRowToDrag.data]:d.getSelection(),d.fire("dragstart",a),a.length&&b.add(d,a)},onDrop:function(){var c,d=this,e=d.widget,f=d.singleRowToDrag?[d.singleRowToDrag.data]:e.getSelection();if(b.dropEl)return void(b.activeGrid.dropZoneFn&&b.activeGrid.dropZoneFn(f));if(e.draggingRows=!0,e.selection.memory||e.clearSelection(),e.remove(f,null,!1),0===d.insertItem)c=0;else if(c=e.getRowById(d.insertItem.id)+1,f.length){var g=0;a.each(f,function(a){e.getRowById(a.id)<c&&g++}),c-=g}e.insert(c,f,!1),e.store.changeDataView(),e.update(),e.selection.memory||a.each(f,function(a){var b=e.getRowById(a.id);e.flashRow(b)}),e.fire("dragrows",f),delete e.draggingRows,e.enableSelection()},onDropOutSide:function(){var a=this,c=a.widget,d=a.singleRowToDrag?[a.singleRowToDrag.data]:c.getSelection(),e=b.dropOutSideRowIndex||0;a.singleRowToDrag||c.clearSelection(),c.remove(d,null,!1),c.store.changeDataView(),c.update(),b.toGrid.insert(e,d,!1),b.toGrid.store.changeDataView(),b.toGrid.update(),b.toGrid.rowdragdrop.clearCellsMask(),b.toGrid.fire("dragrows",d),b.remove()},onBeforeCellMouseDown:function(b,c){var d=this,f=Fancy.get(document),g=d.widget,h=a.get(c.e.target);("rowdrag"===c.column.type||c.column.rowdrag)&&(c.column.rowdrag&&(d.tipValue=c.value),("rowdrag"===c.column.type||c.column.rowdrag)&&("svg"!==h.dom.tagName.toLocaleLowerCase()&&"svg"!==h.parent().dom.tagName.toLocaleLowerCase()||(Fancy.get(c.cell).hasClass(e)||(g.selection.row||g.selection.rows,d.singleRowToDrag=c),d.mouseDownDragEl=!0,f.once("mousemove",function(a){d.showTip(a),f.on("mousemove",d.onDocMouseMove,d)}),g.stopSelection())))},initDropCls:function(){var a=this,b=a.widget,c="#"+b.id+" ."+a.dropZoneOverClass;a.dropCls=c},initEnterLeave:function(){var b=this,c=a.select(b.dropCls);if(0===c.length)return void setTimeout(function(){b.initEnterLeave()},500);c.on("mouseleave",b.onMouseLeaveDropGroup,b)},onMouseLeaveDropGroup:function(){var a=this;a.dropOK=!1,a.clearCellsMask()},onRowLeave:function(a,c){var d=this,e=d.widget,f=c.rowIndex,g=d.activeRowIndex;if(!d.cellMouseDown)return void(b.droppable&&(g=b.toGrid.rowdragdrop.activeRowIndex,f===g&&b.toGrid.getDisplayedData().length-1===f&&(b.toGrid.rowdragdrop.activeRowIndex=f+1,b.toGrid.rowdragdrop.showCellsDropMask(),b.toGrid.rowdragdrop.insertItem=b.toGrid.get(f+1),b.dropOutSideRowIndex=f+1)));f===g&&e.getDisplayedData().length-1===f&&(d.activeRowIndex=d.activeRowIndex+1,d.showCellsDropMask(),d.insertItem=e.get(f))}})}();