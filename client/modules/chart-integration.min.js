Fancy.define("Fancy.grid.plugin.ChartIntegration",{extend:Fancy.Plugin,ptype:"grid.chartintegration",inWidgetName:"chartintegration",constructor:function(a){this.Super("const",arguments)},init:function(){var a=this;a.Super("init",arguments),a.initKeys(),a.initBind(),a.ons()},initKeys:function(){for(var a=this,b=a.chart,c=0,d=b.length;c<d;c++){var e,f=b[c],g=f.fields,h=0,i={};if(Fancy.isString(g))i=g;else for(e=g.length;h<e;h++)i[g[h]]=!0;b[c].keys=i}},ons:function(){var a=this,b=a.widget,c=b.store;b.once("render",function(){a.toChart?a.renderToChart():a.readDataFromChart(),c.on("set",a.onSet,a),c.on("sort",a.onSort,a)})},renderToChart:function(){for(var a=this,b=a.widget,c=a.chart,d=0,e=c.length;d<e;d++){var f=c[d];switch(f.type){case"highchart":case"highcharts":b.highchart.setData(f)}}},onSet:function(a,b){for(var c=this,d=c.widget,e=c.chart,f=0,g=e.length,h=b.key;f<g;f++){var i=e[f],j=i.type;if(!0===i.keys[h])switch(j){case"highchart":case"highcharts":d.highchart.set(i,b)}}},onSort:function(a,b){for(var c=this,d=c.widget,e=c.chart,f=0,g=e.length;f<g;f++){var h=e[f];switch(h.type){case"highchart":case"highcharts":if(!1!==h.sortBind){var i=d.highchart.sort(h,b);e[f].categories=i.original}}}},readDataFromChart:function(){var a,b=this,c=b.widget,d=c.store,e=b.chart,f=e[0],g=f.type;switch(g){case"highchart":case"highcharts":a=c.highchart.getData(f)}c.reConfigStore(a),d.setData(a)},initBind:function(){for(var a,b=this,c=b.chart,d=0,e=c.length;d<e;d++)a=c[d],a.bind&&b.chartBind(a)},chartBind:function(a){var b=this,c=b.widget,d=a.bind;c.on(d.event,b.onBindEvent,{chart:a})},onBindEvent:function(a,b){var c=this,d=a,e=c.chart,f=e.bind,g=f.series,h=b.data,i=e.id;switch(f.action){case"add":var j=d.highchart.doesSeriesExist(i,h[g.name]),k=d.highchart.getNumberSeries(i);if(!1!==j&&1!==k)return void d.highchart.removeSeries(i,j);e.maxToShow&&e.maxToShow<=k&&d.highchart.removeLastSeries(i),d.highchart.isTreeMap(i)?d.highchart.setSeriesData(i,{data:h[g.data]}):d.highchart.addSeries(i,{name:h[g.name],data:h[g.data]})}}}),Fancy.define("Fancy.grid.plugin.HighChart",{extend:Fancy.Plugin,ptype:"grid.highchart",inWidgetName:"highchart",constructor:function(a){this.Super("const",arguments)},init:function(){this.Super("init",arguments),this.ons()},ons:function(){},setData:function(a){var b=this,c=b.widget,d=c.store,e=d.getDataView(),f=a.fields,g=0,h=e.length,i=0,j=f.length,k=b.getChart(a.id),l=k.series,m=a.read;if(m&&void 0!==m.rowIndex&&(e=[e[m.rowIndex]],j=1),Fancy.isString(f))for(;i<j;i++){var n=e[i][f],o=l[i],p=[],g=0,h=n.length;if(a.names)for(;g<h;g++){var q={name:a.names[g],value:n[g]};p.push(q)}else for(;g<h;g++)p.push(n[g]);if(!o)break;o.setData(p),a.name&&o.update({name:e[i][a.name]})}else for(;i<j;i++){var r=f[i],o=l[i],p=[];for(g=0;g<h;g++)p.push(e[g][r]);o.setData(p)}},setSeriesData:function(a,b){this.getChart(chartConfig.id).series[0].setData(b.data)},set:function(a,b){var c,d=this.getFieldsMap(a),e=this.getChart(a.id),f=e.series;c=f[d[b.key]],c.data[b.rowIndex].update(Number(b.value))},sort:function(a){var b=this,c=b.widget,d=c.store,e=b.getChart(a.id),f=a.categories?a.categories:e.xAxis[0].categories,g=d.order,h=[],i=0,j=g?g.length:f.length;if(g)for(;i<j;i++)h.push(f[g[i]]);else for(;i<j;i++)h.push(f[i]);return e.xAxis[0].update({categories:h},!0),b.update(a),{original:f,newCategories:h}},update:function(a){for(var b,c=this,d=c.widget,e=d.store,f=e.getDataView(),g=a.fields,h=0,i=f.length,j=0,k=c.getChart(a.id),l=k.series,m=[],n=0,o=g.length;n<o;n++){var p=g[n];h=0;for(var q=[];h<i;h++)q.push(f[h][p]);m.push(q)}for(b=l.length;j<b;j++){l[j].setData(m[j],!1)}k.redraw()},getData:function(a){for(var b=this,c=b.getChart(a.id),d=d=a.fields,e=0,f=d.length,g=c.series,h=g[0].data.length,i=[];e<f;e++)for(var j=d[e],k=0,l=g[e];k<h;k++)void 0===i[k]&&(i[k]={}),i[k][j]=l.data[k].y;var m=b.getColumnsChartIndexes();for(e=0,f=m.length;e<f;e++){var n=m[e],o=n.split("."),p=c[o[0]][0][o[1]];for(k=0,h=p.length;k<h;k++)i[k][n]=p[k]}return i},getColumnsChartIndexes:function(){for(var a=this.widget,b=[],c=a.columns,d=0,e=c.length;d<e;d++){var f=c[d].index;/xAxis\../.test(f)&&b.push(f)}return b},getFieldsMap:function(a){for(var b={},c=a.fields,d=0,e=c.length;d<e;d++)b[c[d]]=d;return b},addSeries:function(a,b){this.getChart(a).addSeries(b)},getNumberSeries:function(a){return this.getChart(a).series.length},removeLastSeries:function(a){var b=this.getChart(a);b.series[b.series.length-1].remove()},removeSeries:function(a,b){this.getChart(a).series[b].remove()},doesSeriesExist:function(a,b){for(var c=this,d=c.getChart(a),e=0,f=d.series.length;e<f;e++)if(d.series[e].name===b)return e;return!1},isTreeMap:function(a){var b=this.getChart(a);return void 0!==b.series[0]&&"treemap"===b.series[0].type},getChart:function(a){var b,c=Highcharts.charts;return c.forEach(function(c,d){c.renderTo.id===a&&(b=c)}),b}});