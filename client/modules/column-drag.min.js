Fancy.modules["column-drag"]=!0,function(){const e=Fancy,t=e.get(document),i=e.HIDDEN_CLS,n=e.GRID_HEADER_CELL_CLS,o=e.GRID_HEADER_CELL_TEXT_CLS,s=e.GRID_HEADER_CELL_TRIGGER_CLS,d=e.GRID_HEADER_CELL_TRIGGER_IMAGE_CLS,l=e.GRID_HEADER_CELL_GROUP_LEVEL_1_CLS,r=e.GRID_HEADER_CELL_GROUP_LEVEL_2_CLS,a=e.GRID_STATE_DRAG_COLUMN_CLS,u=e.FIELD_TEXT_INPUT_CLS,c=e.FIELD_CHECKBOX_INPUT_CLS,p=`div.${n}`;e.define("Fancy.grid.plugin.ColumnDrag",{extend:e.Plugin,ptype:"grid.columndrag",inWidgetName:"columndrag",activeSide:void 0,activeCell:void 0,activeIndex:void 0,activeColumn:void 0,inCell:void 0,inIndex:void 0,inSide:void 0,ok:!1,status:"none",constructor:function(){this.Super("const",arguments)},init(){const e=this,t=e.widget;e.Super("init",arguments),t.on("render",()=>{e.ons(),e.initHint()})},ons(){this.widget.el.on("mousedown",this.onMouseDownCell,this,p)},onMouseDownCell(i){const n=this,o=n.widget,a=Fancy.get(i.currentTarget),h=Number(a.attr("index")),g=o.getSideByCell(a),C=o.getColumns(g),m=C[h],v=e.get(i.target);m&&m.titleEditable||v.hasCls(s)||v.hasCls(d)||v.hasCls(u)||v.hasCls(c)||(a.hasCls(r)&&(n.activeCellTopGroup=n.getGroupStartEnd(a,g),n.activeCellTopGroup.cell=a),o.startResizing||(n.activeCellTopGroup||!1!==m.draggable)&&(a.hasCls(l)&&(n.activeUnderGroup=!0),n.activeSide=g,n.inSide=g,n.activeCell=a,n.inCell=a,n.activeIndex=Number(a.attr("index")),n.inIndex=n.activeIndex,n.activeColumn=C[n.activeIndex],n.mouseDownX=i.pageX,n.mouseDownY=i.pageY,t.once("mouseup",n.onMouseUp,n),t.on("mousemove",n.onMouseMove,n),o.el.on("mouseleave",n.onMouseLeave,n),o.el.on("mouseenter",n.onMouseEnterCell,n,p),o.el.on("mousemove",n.onMouseMoveCell,n,p)))},onMouseLeave(){this.hideHint()},onMouseUp(){var i,n=this,o=n.widget,s=!1;t.un("mousemove",n.onMouseMove,n),o.el.un("mouseleave",n.onMouseLeave,n),o.el.un("mouseenter",n.onMouseEnterCell,n,p),o.el.un("mousemove",n.onMouseMoveCell,n,p),n.ok&&(n.fire("beforecolumndrag"),n.inSide===n.activeSide?n.dragColumn(n.inSide):(n.activeSide,i=n.inIndex,"right"===n.okPosition&&i++,o.moveColumn(n.activeSide,n.inSide,n.activeIndex,i,n.activeCellTopGroup)),s=!0);const d={column:n.activeColumn,fromSide:n.activeSide,toSide:n.inSide};delete n.inUpGroupCell,delete n.inUnderGroup,delete n.activeCellTopGroup,delete n.activeUnderGroup,delete n.activeSide,delete n.inSide,delete n.inCell,delete n.inIndex,delete n.activeCell,delete n.activeIndex,delete n.activeColumn,delete n.mouseDownX,delete n.mouseDownY,n.ok=!1,delete n.okPosition,e.tip.hide(),setTimeout(function(){n.status="none"},1),n.removeDragState(),"dragging"===n.status&&setTimeout(()=>{n.status="none",s&&(o.fire("columndrag",d),o.sorter&&o.sorter.updateSortedHeader(),n.updateColumnHeaderLImages(),n.clearColumnMenus())},10),n.hideHint(),setTimeout(()=>{o.updateColumnsVisibility()},100),o.scroller.update()},onMouseMove(t){const i=this,n=i.widget,l=n.header,r=n.leftHeader,a=n.rightHeader,u=t.pageX,c=t.pageY,p=n.getColumns(i.activeSide),h=e.get(t.target);if(!h.hasCls(s)&&!h.hasCls(d)&&(Math.abs(u-i.mouseDownX)>10||Math.abs(c-i.mouseDownY))){if(i.activeCellTopGroup?(e.tip.update(i.activeCellTopGroup.cell.select("."+o).item(0).dom.innerHTML||"&nbsp;"),i.status="dragging",i.addDragState()):(e.tip.update(i.activeColumn.title||"&nbsp;"),i.status="dragging",i.addDragState()),1===p.length&&"center"===i.activeSide)return e.tip.hide(),setTimeout(()=>{i.status="none"},1),void i.removeDragState();e.tip.show(t.pageX+15,t.pageY+15),l.hideMenu&&(l.hideMenu(),n.leftColumns&&r.hideMenu()&&r.hideMenu(),n.rightColumns&&a.hideMenu()&&a.hideMenu())}},addDragState(){this.widget.el.addClass(a)},removeDragState(){this.widget.el.removeClass(a)},onMouseEnterCell(e){const t=this,i=t.widget,n=Fancy.get(e.currentTarget),o=i.getSideByCell(n);var s;(t.hideHint(),n.hasCls(l)?t.inUnderGroup=!0:delete t.inUnderGroup,n.hasCls(r)?t.inUpGroupCell=n:delete t.inUpGroupCell,t.inSide=o,t.inCell=n,t.inUpGroupCell)?(i.getHeader(o).el.select('[group-index="'+n.attr("index")+'"]').each(e=>{"none"!==e.css("display")&&void 0===s&&(s=Number(e.attr("index")))}),t.inIndex=s):t.inIndex=Number(n.attr("index"))},onMouseMoveCell(e){const t=this,i=t.widget,n=t.inCell,o=parseInt(n.css("width")),d=n.select(`.${s}`);if(!d.dom)return;const l=Fancy.get(e.target),r=d.within(l)||l.hasClass(s),a=t.activeUnderGroup!==t.inUnderGroup&&!0===t.inUnderGroup,u=t.activeUnderGroup!==t.inUnderGroup&&!0===t.activeUnderGroup,c=i.getColumns(t.activeSide);if(1===c.length&&"center"===t.activeSide)return t.ok=!1,void t.hideHint();if(t.activeCellTopGroup)if(t.inUpGroupCell);else{var p=t.activeCellTopGroup.start,h=t.activeCellTopGroup.end;t.activeSide!==t.inSide?(t.ok=!0,e.offsetX>o/2||r?t.showHint("right"):t.showHint("left")):isNaN(t.inIndex)?t.hideHint():t.inIndex<p?e.offsetX>o/2?t.inIndex+1===p?t.hideHint():(t.ok=!0,t.showHint("right")):(t.ok=!0,t.showHint("left")):t.inIndex>h?e.offsetX<o/2?t.inIndex===h+1?t.hideHint():(t.ok=!0,t.showHint("left")):(t.ok=!0,t.showHint("right")):t.hideHint()}else if(t.inUpGroupCell){var g=t.getGroupStartEnd();p=g.start,h=g.end;t.activeSide!==t.inSide?(t.ok=!0,e.offsetX>o/2||r?t.showHint("right"):t.showHint("left")):e.offsetX>o/2?t.activeIndex>h&&t.activeIndex-1===h?t.hideHint():(t.ok=!0,t.showHint("right")):t.activeIndex<p&&t.activeIndex+1===p?t.hideHint():(t.ok=!0,t.showHint("left"))}else if(t.activeSide!==t.inSide)t.ok=!0,e.offsetX>o/2||r?t.showHint("right"):t.showHint("left");else if(t.activeIndex===t.inIndex)t.ok=!1;else if(t.activeIndex<t.inIndex){if(e.offsetX>o/2||r)c[t.inIndex].disallowAfterDrop||(t.ok=!0,t.showHint("right"));else e.offsetX<o/2&&t.activeIndex+1!==t.inIndex?(t.ok=!0,t.showHint("left")):t.activeIndex+1===t.inIndex&&(a||u)?(t.ok=!0,t.showHint("left")):(t.ok=!1,t.hideHint())}else t.activeIndex>t.inIndex&&(e.offsetX<o/2?r?a||u?(t.ok=!0,t.showHint("right")):t.activeIndex-1===t.inIndex||t.inUpGroupCell?(t.ok=!1,t.hideHint()):(t.ok=!0,t.showHint("right")):(t.ok=!0,t.showHint("left")):e.offsetX>o/2?t.activeIndex-1===t.inIndex&&(a||u)?(t.ok=!0,t.showHint("right")):t.activeIndex-1!==t.inIndex||t.activeUnderGroup?(t.ok=!0,t.showHint("right")):(t.ok=!1,t.hideHint()):(t.ok=!1,t.hideHint()))},showHint(t){const n=this,o=n.widget,s=o.cellHeaderHeight,d=n.inCell,l=n.topEl,r=n.bottomEl,a=d.offset(),u=parseInt(d.css("width")),c=parseInt(d.css("height"));n.okPosition=t,l.removeCls(i),r.removeCls(i);var p=0;"right"===t&&(p+=u),l.css({left:a.left+p-Math.ceil(parseInt(l.css("width"))/2),top:a.top-parseInt(l.css("height"))});var h=a.top+c;if(n.inUpGroupCell){const e=o.header.calcRows();h=a.top+e*s}if(r.css({left:a.left+p-Math.ceil(parseInt(r.css("width"))/2),top:h}),o.window){const t=1e3+e.zIndex++;l.css("z-index",t),r.css("z-index",t)}},hideHint(){this.topEl.addCls(i),this.bottomEl.addCls(i)},initHint(){const t=this.widget,n=Fancy.getThemeCSSCls(t.theme),o=e.get(document.body).dom,s=e.newEl("div"),d=e.newEl("div");s.addCls("fancy-drag-hint-top",i,n),d.addCls("fancy-drag-hint-bottom",i,n),this.topEl=e.get(o.appendChild(s.dom)),this.bottomEl=e.get(o.appendChild(d.dom))},dragColumn(e){var t=this,i=t.widget,n=i.getHeader(e),o=i.getBody(e),s=t.activeIndex,d=t.inIndex,l=t.okPosition,r=i.getColumns(e),a=r[s],u=n.calcRows();if(t.activeCellTopGroup){const n=t.activeCellTopGroup.start,o=t.activeCellTopGroup.end,s=r.splice(n,o-n+1);d=t.inIndex,"right"===l&&d++,r=t.inIndex<n?Fancy.Array.insert(r,d,s):Fancy.Array.insert(r,d-s.length,s),i.setColumnsLinksToSide(r,e)}else if(t.inUpGroupCell){const e=t.getGroupStartEnd();d=e.start,"right"===l&&(d=e.end+1)}else if("right"===l)if(t.inUnderGroup){const e=r[d].grouping,t=r[d+1];t&&t.grouping===e&&d++}else d++;if(i.groupheader&&!t.activeCellTopGroup){const e=r[d];e&&e.grouping&&t.inUnderGroup?(a.grouping=e.grouping,a.filter&&a.filter.header&&u<3&&delete a.filter):delete a.grouping}t.activeCellTopGroup||(r.splice(s,1),s<d&&d--,r.splice(d,0,a)),o.clearColumnsStyles(),n.updateTitles(),n.updateCellsSizes(),n.reSetCheckBoxes(),setTimeout(()=>{i.groupheader&&(i.header.fixGroupHeaderSizing(),i.leftColumns&&i.leftHeader.fixGroupHeaderSizing(),i.rightColumns&&i.rightHeader.fixGroupHeaderSizing(),n.reSetGroupIndexes()),n.reSetColumnsAlign(),n.reSetColumnsCls(),o.reSetColumnsAlign(),o.reSetColumnsCls(),o.updateColumnsSizes()},100),i.update()},getGroupStartEnd(t,i){const n=this.widget.getHeader(i||this.inSide),o=(t||this.inUpGroupCell).attr("index"),s=[];return n.el.select(`[group-index="${o}"]`).each(e=>{s.push(Number(e.attr("index")))}),{start:e.Array.min(s),end:e.Array.max(s)}},clearColumnMenus(){const t=this.widget;e.each(t.columns,t=>{e.isObject(t.menu)&&t._menu&&(t.menu=t._menu,delete t._menu)})},updateColumnHeaderLImages(){const e=this.widget;e.header&&(e.header.updateLImages(),e.leftColumns.length&&e.leftHeader.updateLImages(),e.rightColumns.length&&e.rightHeader.updateLImages())}})}();