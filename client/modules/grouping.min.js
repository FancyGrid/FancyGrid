Fancy.Mixin("Fancy.store.mixin.Grouping",{expand:function(a,b){var c=this,d=c.data,e=0,f=d.length,g=[],h={},i={};for(c.filteredData&&(d=c.filteredData,f=d.length),c.expanded=c.expanded||{},c.expanded[b]=!0;e<f;e++){var j=d[e];c.expanded[j.data[a]]&&(g.push(j),h[j.id]=g.length-1,i[g.length-1]=e)}c.dataView=g,c.dataViewMap=h,c.dataViewIndexes=i},collapse:function(a,b){var c=this,d=c.data,e=0,f=d.length,g=[],h={},i={};for(c.expanded=c.expanded||{},delete c.expanded[b];e<f;e++){var j=d[e];c.expanded[j.data[a]]&&(g.push(j),h[j.id]=g.length-1,i[g.length-1]=e)}c.dataView=g,c.dataViewMap=h,c.dataViewIndexes=i},changeOrderByGroups:function(a,b){var c=this,d={},e=[];Fancy.each(a,function(a){d[a]=[]}),Fancy.isArray(c.data)&&Fancy.each(c.data,function(a){var c=a.data[b];d[c]&&d[c].push(a)}),Fancy.each(a,function(a){e=e.concat(d[a])}),c.grouping={by:b},c.data=e},getColumnOriginalValuesByGroup:function(a,b,c){var d=this,e=d.data,f=0,g=e.length,h=[],i=[],j=e[0].data[b];if(c&&c.format&&"date"===c.type)for(;f<g;f++)e[f].data[b]===j?i.push(Fancy.Date.parse(e[f].data[a],c.format,c.mode)):(h.push({values:i,groupName:j}),i=[],j=e[f].data[b],f--);else for(;f<g;f++)e[f].data[b]===j?i.push(e[f].data[a]):(h.push({values:i,groupName:j}),i=[],j=e[f].data[b],f--);return g>0&&h.push({values:i,groupName:j}),h},initGroups:function(a){var b=this,c=b.widget,d=c.grouping,a=a||"data",e=d.by;if(!e)throw new Error("[FancyGrid Error] - not set by param in grouping");var f=b.getColumnOriginalValues(e,{dataProperty:a,groupMap:!0}),g={};Fancy.each(f,function(a){void 0===g[a]&&(g[a]=0),g[a]++});var h=[];for(var i in g)h.push(i);return{groups:h,_groups:g}},orderDataByGroupOnStart:function(){var a=this,b=a.widget.grouping,c=a.initGroups(),d=c.groups,e={},f=[];Fancy.each(d,function(a){var b=a.toLocaleUpperCase();e[b]=a,f.push(b)}),f=f.sort();for(var g=0,h=d.length;g<h;g++)d[g]=e[f[g]];a.changeOrderByGroups(d,b.by),a.expanded={},b.collapsed?a.collapsed=!0:Fancy.each(d,function(c){b.expanded&&void 0!==b.expanded[c]||(a.expanded[c]=!0)}),a.changeDataView({doNotFired:!0})},getItemsByGroup:function(a){var b=this;return b.findItem(b.grouping.by,a)}}),function(){var a=Fancy,b=Fancy.each,c=a.GRID_ROW_GROUP_INNER_CLS,d=a.GRID_ROW_GROUP_CLS,e=a.GRID_ROW_GROUP_COLLAPSED_CLS,f=a.GRID_CELL_CLS;a.define("Fancy.grid.plugin.Grouping",{extend:a.Plugin,ptype:"grid.grouping",inWidgetName:"grouping",tpl:"{text}:{number}",_renderFirstTime:!0,constructor:function(a){this.Super("const",arguments)},init:function(){var a=this,b=a.widget;a.Super("init",arguments),a._expanded={},a.initTpl(),a.initGroups(),a.initOrder(),a.calcPlusScroll(),a.configParams(),a.ons(),!a.collapsed&&b.store.data&&setTimeout(function(){b.store.changeDataView({doNotFired:!0}),b.update()},100)},ons:function(){var a=this,b=a.widget,c=b.store;b.once("render",function(){a.renderGroupedRows(),a.update(),b.el.on("click",a.onClick,a,"div."+d),b.el.on("mousedown",a.onMouseDown,a,"div."+d),b.on("scroll",a.onScroll,a),b.on("columnresize",a.onColumnResize,a),c.on("insert",a.onInsert,a),c.on("remove",a.onRemove,a),b.on("columndrag",a.onColumnDrag,a)})},onInsert:function(){this.reGroup()},onRemove:function(){var a=this,c=a.widget,d=c.store,e=a.groups;if(a.initGroups(),a.update(),a.updateGroupRowsText(),e.length>a.groups.length){var f;b(e,function(b,c){if(b!==a.groups[c])return f=b,!0}),delete d.expanded[f],delete a.expanded[f],delete a._expanded[f]}},initGroups:function(a){var b=this,c=b.widget,d=c.store,e=d.initGroups(a);b.groups=e.groups,b.groupsCounts=e._groups},getGroupById:function(a){return this.widget.store.groupMap[a]},getGroupOrderIndex:function(a){for(var b=this.groups,c=0,d=b.length;c<d;c++)if(b[c]===a)return c},initOrder:function(){var c,d,e=this,f=e.widget,g=f.store,h=[],i={},j=[];if(e.order&&0!==e.order.length)a.typeOf(e.order);else for(h=e.groups,c=0,d=h.length,b(h,function(a){var b=a.toLocaleUpperCase();i[b]=a,j.push(b)}),j=j.sort();c<d;c++)h[c]=i[j[c]];e.groups=h,g.changeOrderByGroups(h,e.by)},calcPlusScroll:function(){var a=this.widget;this.plusScroll=this.groups.length*a.groupRowHeight},configParams:function(){var a=this,c=a.widget,d=c.store;a.expanded=a.expanded||{},d.expanded=d.expanded||{},a.collapsed?d.collapsed=!0:b(a.groups,function(b){void 0===a.expanded[b]&&(d.expanded[b]=!0,a.expanded[b]=!0,a._expanded[b]=!0)})},renderGroupedRows:function(){var a,c=this,d=c.widget,e=d.body,f=d.leftBody,g=d.rightBody,h=d.getCenterFullWidth(),i=d.getLeftFullWidth(),j=d.getRightFullWidth(),k=0;b(c.groups,function(b){var l=c.groupsCounts[b];i?(a=c.generateGroupRow(b,l,!0,k),a.css("width",i),f.el.dom.appendChild(a.dom),a=c.generateGroupRow(b,l,!1,k),a.css("width",h),e.el.dom.appendChild(a.dom)):(a=c.generateGroupRow(b,l,!0,k),a.css("width",h),e.el.dom.appendChild(a.dom)),j&&(a=c.generateGroupRow(b,l,!1,k),a.css("width",j),g.el.dom.appendChild(a.dom)),c.collapsed&&(k+=d.groupRowHeight)})},softRenderGroupedRows:function(a){var f,g,h,i=this,j=i.widget,k=j.body,l=j.leftBody,m=j.rightBody;switch(a){case"left":if(l.el.select("."+d).length){var n=k.el.select("."+c);return void(n.length&&n.destroy())}h=k.el.select("."+d),f=j.getLeftFullWidth(),b(i.groups,function(a,b){var d=i.groupsCounts[a],g=h.item(b),j=parseInt(g.css("top")),k=i.generateGroupRow(a,d,!0,j);g.hasClass(e)||k.removeCls(e),g.select("."+c).destroy(),k.css("width",f),l.el.dom.appendChild(k.dom)});break;case"right":if(m.el.select("."+d).length)return;g=j.getRightFullWidth(),h=k.el.select("."+d),b(i.groups,function(a,b){var c=i.groupsCounts[a],d=h.item(b),e=parseInt(d.css("top")),f=i.generateGroupRow(a,c,!1,e);f.css("width",g),m.el.dom.appendChild(f.dom)})}},removeGroupRows:function(){var a=this,b=a.widget,c=b.columns,e=b.leftColumns,f=b.rightColumns,g=b.body,h=b.leftBody,i=b.rightBody;c.length&&g.el.select("."+d).remove(),e.length&&h.el.select("."+d).remove(),f.length&&i.el.select("."+d).remove()},removeLastGroupRow:function(){var a=this,b=a.widget,c=b.columns,e=a.groups,f=e.length,g=b.leftColumns,h=b.rightColumns,i=b.body,j=b.leftBody,k=b.rightBody;if(c.length){i.el.select("."+d).item(f).remove()}g.length&&j.el.select("."+d).item(f).remove(),h.length&&k.el.select("."+d).item(f).remove()},removeCells:function(){var a=this,b=a.widget,c=b.columns,d=b.leftColumns,e=b.rightColumns,g=b.body,h=b.leftBody,i=b.rightBody;c.length&&g.el.select("."+f).remove(),d.length&&h.el.select("."+f).remove(),e.length&&i.el.select("."+f).remove()},generateGroupRow:function(b,f,g,h){var i=this,j=a.get(document.createElement("div"));if(j.addCls(d),j.attr("group",b),g){var k=i.tpl.getHTML({text:b,number:f});j.update('<div class="'+c+'"> '+k+"</div>")}return i.collapsed?(j.css("top",h+"px"),j.addCls(e)):j.css("top","0px"),j},insertGroupEls:function(){var a=this,b=a.widget,e=b.leftBody,f=b.body;b.leftColumns.length?e.el.select("."+d).each(function(b){var d=a.groups[i];b.update('<div class="'+c+'">'+d+"</div>")}):f.el.select("."+d).each(function(b,d){var e=a.groups[d],f=a.groupsCounts[e],g=a.tpl.getHTML({text:e,number:f});b.update('<div class="'+c+'">'+g+"</div>")})},onClick:function(b){var c,f=this,g=f.widget,h=a.get(b.currentTarget),i=h.attr("group");g.el.select("."+d+'[group="'+i+'"]').toggleCls(e),c=h.hasCls(e),c?f.collapse(f.by,i):f.expand(f.by,i),f.update()},fastCollapse:function(){},onMouseDown:function(a){a.preventDefault()},onScroll:function(){this.setPositions()},collapse:function(a,b){var c=this,d=c.widget;d.store.collapse(a,b),delete c._expanded[b],delete c.expanded[b],d.fire("collapse",a,b)},expand:function(a,b){var c=this,d=c.widget;d.store.expand(a,b),c._expanded[b]=!0,c.expanded[b]=!0,d.fire("expand",a,b)},setPositions:function(){var a=this,c=a.widget,e=c.store,f=-c.scroller.scrollTop||0,g=c.leftBody.el.select("."+d),h=c.body.el.select("."+d),i=c.rightBody.el.select("."+d);b(a.groups,function(b,d){if(g.length&&g.item(d).css("top",f+"px"),h.length&&h.item(d).css("top",f+"px"),i.length&&i.item(d).css("top",f+"px"),c.expander){var j=c.expander.expandedGroups[b];for(var k in j){var l=j[k];f+=parseInt(l.el.css("height"))}}if(f+=c.groupRowHeight,!0===a._expanded[b])if(c.rowheight){var m=e.getItemsByGroup(b),n=c.rowheight.getRowsHeight(m);if(isNaN(f))return!0;f+=n}else f+=a.groupsCounts[b]*c.cellHeight})},setCellsPosition:function(a,c){for(var d,e,f=this,g=f.widget,h=0,i=f.groups.length,j=0,k=g.body,l=g.leftBody,m=g.rightBody,n=0,o=g.groupRowHeight,p=[],q={},r={},s=f.by;h<i;h++){var t=f.groups[h];if(!0===f._expanded[t]){if(p.push(n),q[n]=!0,void 0===c||"center"===c)if(j=0,d=g.columns.length,void 0!==a&&(j=a,d=a+1),g.expander){var u=g.get(n),v=u.get(s),w=g.expander.expandedGroups,x=f.getGroupOrderIndex(t),y=0;for(var z in w){var A=f.getGroupOrderIndex(z);if(!(x<=A)){var B=w[z];for(var C in B){var D=B[C];if("none"!==D.el.css("display")&&!r[C]){var E=n-1;n<0&&(n=0),E=g.get(E);var F=E.get(s);v!==F?E.id===C&&(r[C]=!0,y+=parseInt(D.el.css("height"))):(r[C]=!0,y+=parseInt(D.el.css("height")))}}}}for(o+=y,e=k.getCell(n,j);j<d;j++)e=k.getCell(n,j),e.css("margin-top",o+"px")}else for(;j<d;j++)e=k.getCell(n,j),e.css("margin-top",o+"px");if(void 0===c||"left"===c)for(j=0,d=g.leftColumns.length,void 0!==a&&(j=a,d=a+1);j<d;j++)e=l.getCell(n,j),e.css("margin-top",o+"px");if(void 0===c||"right"===c)for(j=0,d=g.rightColumns.length,void 0!==a&&(j=a,d=a+1);j<d;j++)e=m.getCell(n,j),e.css("margin-top",o+"px");n+=f.groupsCounts[t],o=g.groupRowHeight}else o+=g.groupRowHeight}if(f._renderFirstTime)f._renderFirstTime=!1;else{var G=[];b(f.prevRows,function(a){!0!==q[a]&&G.push(a)}),f.clearMargins(G)}f.prevRows=p},setExpanderCellsPosition:function(){var a,c,d=this,e=d.widget,f=e.store,g=f.dataView,h=e.body,i=e.leftBody,j=e.rightBody,k=e.expander.expandedGroups,l=d.groupsCounts,m=e.groupRowHeight,n=0,o=0;b(d.groups,function(f){if(!0===d._expanded[f]){for(var p=n+l[f];n<p;n++)if(c=g[n]){var q=c.id,r=k[f][q];o&&(m+=o,o=0),r&&(o=parseInt(r.el.css("height"))),b(e.columns,function(b,c){a=h.getCell(n,c),a.css("margin-top",m+"px")}),b(e.leftColumns,function(b,c){a=i.getCell(n,c),a.css("margin-top",m+"px")}),b(e.rightColumns,function(b,c){a=j.getCell(n,c),a.css("margin-top",m+"px")}),m=0}m=e.groupRowHeight}else m+=e.groupRowHeight})},clearMargins:function(a){var c=this,a=a||c.prevRows;if(void 0!==a){var d,e=c.widget,f=e.body,g=e.leftBody,h=e.rightBody;b(a,function(a){b(e.columns,function(b,c){if(d=f.getCell(a,c),void 0===d.dom)return!0;d.css("margin-top","0px")}),b(e.leftColumns,function(b,c){if(d=g.getCell(a,c),void 0===d.dom)return!0;d.css("margin-top","0px")}),b(e.rightColumns,function(b,c){if(d=h.getCell(a,c),void 0===d.dom)return!0;d.css("margin-top","0px")})})}},onColumnResize:function(){this.updateGroupRows()},updateGroupRows:function(){var a=this,b=a.widget,c=b.leftColumns,e=b.rightColumns,f=b.body,g=b.leftBody,h=b.rightBody,i=0;i+=b.getCenterFullWidth(),f.el.select("."+d).css("width",i+"px"),i+=b.getLeftFullWidth(),c.length&&g.el.select("."+d).css("width",i+"px"),i+=b.getRightFullWidth(),e.length&&h.el.select("."+d).css("width",i+"px")},update:function(a){var b=this,c=b.widget,d=c.store;a||!0!==d.loading&&!1!==d.autoLoad||d.data.length?a&&d.data.length&&d.loadedTimes>1?b.reGroup():(b.setPositions(),c.update(),c.scroller.update(),b.setCellsPosition(),c.setSidesHeight()):d.on("load",function(){b.initGroups(),b.initOrder(),b.calcPlusScroll(),b.configParams(),d.changeDataView({doNotFired:!0}),b.renderGroupedRows(),b.update(!0)},b)},getOffsetForRow:function(a){var c=this,d=c.widget,e=0,f=0;return b(c.groups,function(b){if(e+=d.groupRowHeight,!0===c._expanded[b]&&(f+=c.groupsCounts[b]),a<f)return!0}),e},getSpecialRowsUnder:function(a){var c=this,d=c.widget,e=0,f=0,g=0;return b(c.groups,function(b){a<f&&g++,e+=d.groupRowHeight,!0===c._expanded[b]&&(f+=c.groupsCounts[b])}),g},getSpecialRowsAbove:function(a){var b=this,c=b.widget,d=c.get(a),e=b.getGroupById(d.id),f=0;return Fancy.each(b.groups,function(a){if(f++,e===a)return!0}),f},reGroup:function(){var a=this,b=a.widget,c=b.store,d="data";a.expanded={},a._expanded={},b.store.expanded={},b.store.dataView=[],a.collapsed=!0,b.store.filteredData&&(d="filteredData"),a.removeGroupRows(),a.removeCells(),a.initGroups(d),c.remoteFilter&&a.initOrder(),a.calcPlusScroll(),a.configParams(),a.renderGroupedRows(),b.setSidesHeight()},scrollLeft:function(a){this.widget.body.el.select("."+d).css("left",a)},updateGroupRowsText:function(){var a=this,f=a.widget,g=a.groups,h=f.leftBody,i=f.body,j=f.rightBody,k=h.el.select("."+c),l=i.el.select("."+c),m=h.el.select("."+d),n=i.el.select("."+d),o=j.el.select("."+d);b(g,function(b,c){var d,g=a.groupsCounts[b],h=a.tpl.getHTML({text:b,number:g});f.leftColumns.length?(k.item(c).update(h),d=m.item(c),d.attr("group",b),a.expanded[b]?d.removeClass(e):d.addClass(e)):(l.item(c).update(h),d=n.item(c),a.expanded[b]?d.removeClass(e):d.addClass(e)),n.item(c).attr("group",b),f.rightColumns.length&&o.item(c).attr("group",b)}),g.length<i.el.select("."+d).length&&setTimeout(function(){a.removeLastGroupRow()},10)},onColumnDrag:function(){var a=this,b=a.widget,c=b.el.select("."+d),f=b.el.select("."+d+":not(."+e+")"),g={};if(f.each(function(a){g[a.attr("group")]=!0}),!b.leftColumns.length&&c.length){c.destroy(),a.renderGroupedRows(),a.update();for(var h in g){b.el.select("."+d+'[group="'+h+'"]').removeCls(e)}}},getGroupRowsHeight:function(){var b=this,c=b.widget,d=0;return a.each(b.groupsCounts,function(a){a&&d++}),d*c.groupRowHeight}})}();