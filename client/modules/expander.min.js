Fancy.modules.expander=!0,function(){const e=Fancy,t=e.get,d=e.GRID_CELL_CLS,n=e.GRID_COLUMN_CLS,o=e.GRID_ROW_EXPAND_CLS,s=e.GRID_ROW_EXPAND_OVER_CLS,i=e.GRID_ROW_EXPAND_SELECTED_CLS,l=e.GRID_ROW_OVER_CLS;e.define("Fancy.grid.plugin.Expander",{extend:e.Plugin,ptype:"grid.expander",inWidgetName:"expander",plusScroll:0,enabledCollapse:!0,constructor:function(){this.Super("const",arguments)},init(){const e=this;e.Super("init",arguments),e._expanded={},e._expandedIds={},e.expandedGroups={},e.initTpl(),e.ons()},ons(){const e=this,t=e.widget,d=t.store;t.on("scroll",e.onScroll,e),t.on("beforesort",e.onBeforeSort,e),t.on("changepage",e.onChangePage,e),t.on("filter",e.onFilter,e),t.on("columnresize",e.onColumnReSize,e),t.on("rowdblclick",e.onRowDBlClick,e),t.on("rowtrackenter",e.onRowTrackOver,e),t.on("rowtrackleave",e.onRowTrackLeave,e),t.on("collapse",e.onGroupCollapse,e),t.on("expand",e.onGroupExpand,e),t.on("remove",e.onRemove,e),t.on("render",function(){t.el.on("mouseenter",e.onExpandRowMouseEnter,e,"div."+o),t.el.on("mouseleave",e.onExpandRowMouseLeave,e,"div."+o)}),t.on("select",e.onSelect,e),t.on("clearselect",e.onClearSelect,e),d.on("beforeinsert",e.onBeforeInsert,e),t.on("columndrag",e.onColumnDrag,e),t.on("lockcolumn",e.onLockColumn,e),t.on("rightlockcolumn",e.onRightLockColumn,e),t.on("unlockcolumn",e.onUnLockColumn,e),e.expanded&&(d.proxyType?t.once("load",()=>e.expandAll()):t.on("init",()=>e.expandAll()))},expand(t){const o=this,s=o.widget,i=s.get(t).id;void 0===o._expandedIds[i]?(o._expandedIds[i]={},o.expandRow(Number(t),i),o.addMargin(Number(t)+1,i)):o.showRow(Number(t),i),delete o._expandedIds[i].hidden,o.reSetTop(),o.reSetPlusScroll();for(var l=s.el.select("."+n+'[grid="'+s.id+'"] .'+d+'[index="'+t+'"] .fancy-checkbox-expander'),r=0,a=l.length;r<a;r++){const t=e.getWidget(l.item(r).attr("id"));!1===t.get()&&t.set(!0,!1)}o.changeSidesSize(),o.onSelect()},collapse(e){const t=this,d=t.widget,n=d.scroller,o=d.get(e).id;t.collapseRow(Number(e),o),t.clearMargin(Number(e)+1,o),t._expandedIds[o].hidden=!0,t.reSetTop(),t.reSetPlusScroll(),t.changeSidesSize(),n.scrollDelta(1),n.scrollRightKnob()},collapseRow(t,o){const s=this,i=s.widget,l=s._expandedIds[o];if(!s._expandedIds[o])return!1;s._expandedIds[o].timeOutCheckHeight1&&(clearTimeout(s._expandedIds[o].timeOutCheckHeight1),delete s._expandedIds[o].timeOutCheckHeight1),s._expandedIds[o].timeOutCheckHeight2&&(clearTimeout(s._expandedIds[o].timeOutCheckHeight2),delete s._expandedIds[o].timeOutCheckHeight2),s._expandedIds[o].timeOutCheckHeight3&&(clearTimeout(s._expandedIds[o].timeOutCheckHeight3),delete s._expandedIds[o].timeOutCheckHeight3),s._expandedIds[o].timeOutCheckHeight4&&(clearTimeout(s._expandedIds[o].timeOutCheckHeight4),delete s._expandedIds[o].timeOutCheckHeight4),l.el.hide(),l.hidden=!0,i.leftColumns&&l.leftEl.hide(),i.rightColumns&&l.rightEl.hide();for(var r=i.el.select("."+n+'[grid="'+i.id+'"] .'+d+'[index="'+t+'"] .fancy-checkbox-expander'),a=0,c=r.length;a<c;a++){const t=e.getWidget(r.item(a).attr("id"));!0===t.get()&&(t.set(!1,!1),t.collapsedTime=new Date)}},_hideAllSideExpandedRow(){const e=this,t=e.widget;for(const d in e._expandedIds){const n=e._expandedIds[d];n.el.hide(),n.hidden=!0,t.leftColumns&&n.leftEl.hide(),t.rightColumns&&n.rightEl.hide()}},expandAll(){for(var e=this.widget.getViewTotal(),t=0;t<e;t++)this.expand(t)},expandRow(e,d){var n,s,i=this,l=i.widget,r=t(document.createElement("div")),a=l.getById(d),c=i.prepareData(a),h=-l.scroller.scrollLeft||0,p=l.getCenterFullWidth();if(i.tpl&&(n=i.tpl.getHTML(c),r.update(n)),r.addCls(o),r.css({left:h,width:p}),r.attr("index",e),l.body.el.dom.appendChild(r.dom),i.render){i.render(r.dom,c,l.getCenterFullWidth());const t=function(){const t=parseInt(r.css("height"));s!==t&&i._expandedIds[d]&&(i._expandedIds[d].height=t,g.css("height",t),u.css("height",t),i.addMargin(Number(e)+1,d))};i._expandedIds[d].timeOutCheckHeight1=setTimeout(t,100),i._expandedIds[d].timeOutCheckHeight2=setTimeout(t,500),i._expandedIds[d].timeOutCheckHeight3=setTimeout(t,1e3),i._expandedIds[d].timeOutCheckHeight4=setTimeout(t,3e3)}if(s=parseInt(r.css("height")),i._expandedIds[d].rowIndex=e,i._expandedIds[d].el=r,i._expandedIds[d].height=s,i._expandedIds[d].width=p,l.leftColumns){var g=t(document.createElement("div"));g.css("left","0px"),g.css("height",s),g.css("width",l.getLeftFullWidth()),g.attr("index",e),g.addCls(o),l.leftBody.el.dom.appendChild(g.dom),i._expandedIds[d].leftEl=g}if(l.rightColumns){var u=t(document.createElement("div"));u.css("left","0px"),u.css("height",s),u.css("width",l.getRightFullWidth()),u.attr("index",e),u.addCls(o),l.rightBody.el.dom.appendChild(u.dom),i._expandedIds[d].rightEl=u}setTimeout(()=>{l.scroller.update()},100)},addMargin(e,t){const o=this.widget,s=this._expandedIds[t].height;o.el.select("."+n+'[grid="'+o.id+'"] .'+d+'[index="'+e+'"]').css("margin-top",s)},clearMargin(e){const t=this.widget;t.el.select("."+n+'[grid="'+t.id+'"] .'+d+'[index="'+e+'"]').css("margin-top","0")},onBeforeSort(){this.reSet()},onChangePage(){this.reSet()},onFilter(){this.reSet()},onRemove(){this.reSet()},reSet(){const e=this,t=e.widget;if(!1!==e.enabledCollapse){for(const t in e._expandedIds){const d=e._expandedIds[t];d.el.destroy(),e.clearMargin(Number(d.rowIndex)+1,t)}e._hideAllSideExpandedRow(),e._expandedIds={},e.reSetTop(),e.reSetPlusScroll(),e.changeSidesSize(),t.scroller.scrollDelta(1),t.setSidesHeight(),setTimeout(()=>{t.setSidesHeight()},100)}},showRow(e,t){const d=this.widget,n=this._expandedIds[t];n.el.show(),d.leftColumns&&n.leftEl.show(),d.rightColumns&&n.rightEl.show(),this.addMargin(e+1,t)},getBeforeHeight(e){var t=0;for(const d in this._expandedIds){const n=this._expandedIds[d];n.rowIndex<e&&!n.hidden&&"none"!==n.el.css("display")&&(t+=n.height)}return t},reSetTop(e){const t=this,d=t.widget,n=d.cellHeight,o=-d.scroller.scrollTop||0,s=-d.scroller.scrollLeft||0;if(d.isGroupable()){t.expandedGroups={};const e=d.grouping.expanded;for(var i in e)t.expandedGroups[i]=t.expandedGroups[i]||{}}for(var i in t._expandedIds){var l=t._expandedIds[i];if("none"!==l.el.css("display")){var r=t.getBeforeHeight(l.rowIndex),a=o+t.getDisplayedRowsBefore(l,i)*n+r;if(d.isGroupable()){var c=i,h=d.grouping.getGroupById(c),p=d.grouping.getGroupOrderIndex(h);"none"!==l.el.css("display")&&(t.expandedGroups[h]=t.expandedGroups[h]||{},t.expandedGroups[h][i]=l,a+=(p+1)*d.groupRowHeight)}l.el.css({top:a,left:s}),d.leftColumns&&l.leftEl.css("top",a),d.rightColumns&&l.rightEl.css("top",a)}}d.isGroupable()&&!1!==e&&(d.grouping.setPositions(),d.grouping.setExpanderCellsPosition())},getDisplayedRowsBefore(e,t){const d=this.widget;if(d.isGroupable()){var n=0;return"none"!==e.el.css("display")&&(n=d.store.getRow(t)),n+1}return e.rowIndex+1},onScroll(){this.reSetTop()},reSetPlusScroll(){const e=this.widget;this.plusScroll=this.getPlusHeight(),e.scroller.setRightKnobSize(),setTimeout(()=>{!1===e.scroller.isRightScrollable()&&e.scroller.scroll(0)},1)},getPlusHeight(){var e=0;for(const t in this._expandedIds){const d=this._expandedIds[t];d.hidden||"none"===d.el.css("display")||(e+=d.height)}return this.plusHeight=e,this.plusHeight},onColumnReSize(){const e=this,t=e.widget;for(const d in e._expandedIds){const n=e._expandedIds[d],o=t.getCenterFullWidth();n.el.css("width",o)}},prepareData(e){var t=this.widget,d=e.data;return this.dataFn&&(d=this.dataFn(t,d)),d},changeSidesSize(){const e=this.widget;e.setSidesHeight(),e.scroller.checkRightScroll()},onRowDBlClick(e,t){const d=this,n=d.widget,o=Number(t.rowIndex),s=t.id,i=d._expandedIds[s];n.edit?n.un("rowdblclick",d.onRowDBlClick,d):void 0===i?d.expand(o):!0===i.hidden&&"none"===i.el.css("display")?d.expand(o):d.collapse(o)},onRowTrackOver(e,t){const d=this.widget,n=this._expandedIds[t.id];n&&(n.el.addCls(s),d.leftColumns&&n.leftEl.addCls(s),d.rightColumns&&n.rightEl.addCls(s))},onRowTrackLeave(e,t){const d=this.widget,n=this._expandedIds[t.id];n&&(n.el.removeCls(s),d.leftColumns&&n.leftEl.removeCls(s),d.rightColumns&&n.rightEl.removeCls(s))},onExpandRowMouseEnter(e){const i=this.widget,r=i.scroller,a=t(e.currentTarget).attr("index");i.el.select("."+o+'[index="'+a+'"]').addCls(s),!i.trackOver||r.bottomKnobDown||r.rightKnobDown||i.el.select("."+n+'[grid="'+i.id+'"] .'+d+'[index="'+a+'"]').addCls(l)},onExpandRowMouseLeave(e){const i=this.widget,r=i.scroller,a=t(e.currentTarget).attr("index");i.el.select(`.${o}[index="${a}"]`).removeCls(s),!i.trackOver||r.bottomKnobDown||r.rightKnobDown||i.el.select("."+n+'[grid="'+i.id+'"] .'+d+'[index="'+a+'"]').removeCls(l)},onSelect(){const e=this.widget,t=e.selection;t&&(t.row||t.rows)&&(this.onClearSelect(),e.getSelection(!0).rows.forEach(t=>{e.el.select(`.${o}[index="${t}"]`).addCls(i)}))},onClearSelect(){var e=this.widget,t=e.selection;if(t.row||t.rows){for(var d={},n=(t=e.getSelection(!0)).rows,s=0,l=n.length;s<l;s++)d[n[s]]=!0;var r=e.el.select(`.${i}`);for(s=0,l=r.length;s<l;s++){const t=r.item(s).attr("index");d[t]||e.el.select("."+o+'[index="'+t+'"]').removeCls(i)}}},onGroupCollapse(e,t,d){var n=this,o=n.widget,s=n.expandedGroups;if(s[d]){var i=s[d];for(var l in i){var r=i[l];n._expandedIds[l]&&delete n._expandedIds[l],r.el.hide(),r.leftEl.dom&&r.leftEl.hide(),r.rightEl.dom&&r.rightEl.hide()}}n.reSetTop(!1),n.reSetIndexes(),setTimeout(()=>{o.grouping.setExpanderCellsPosition()},1)},onGroupExpand(){const e=this.widget;this.reSetTop(!1),this.reSetIndexes(),setTimeout(()=>{e.grouping.setExpanderCellsPosition()},1)},reSetIndexes(){const e=this,t=e.widget.store;for(const d in e._expandedIds)e._expandedIds[d].rowIndex=t.getRow(d)},onAdd(){this.reSet()},onBeforeInsert(){this.reSet()},onColumnDrag(){this.reSet(),this.clearExpandedCheckBoxes()},onLockColumn(){this.reSet(),this.clearExpandedCheckBoxes()},onRightLockColumn(){this.reSet(),this.clearExpandedCheckBoxes()},onUnLockColumn(){this.reSet(),this.clearExpandedCheckBoxes()},clearExpandedCheckBoxes(){this.widget.el.select(".fancy-checkbox-expander.fancy-checkbox-on").each(e=>{const t=e.attr("id");Fancy.getWidget(t).setValue(!1,!1)})},collapseAll(){this.reSet(),this.clearExpandedCheckBoxes()}})}();