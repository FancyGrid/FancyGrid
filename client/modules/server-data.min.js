Fancy.modules["server-data"]=!0,Fancy.Mixin("Fancy.store.mixin.Proxy",{pageParam:"page",startParam:"start",limitParam:"limit",sortParam:"sort",directionParam:"dir",keyParam:"key",valueParam:"value",filterParam:"filter",autoLoad:!0,autoSave:!0,saveOrder:["create","update","destroy"],batch:!0,filterOperators:{"<":"lt",">":"gt","<=":"lteq",">=":"gteq","=":"eq","==":"eq","===":"stricteq","!=":"noteq","!==":"notstricteq","":"like","*":"likeor","|":"or"},loadedTimes:0,initProxy(){const e=this,r=e.widget;e.proxy=e.data.proxy||{};const a=e.proxy;if(a.words)for(const e in a.words)this[e+"Param"]=a.words[e];void 0!==a.autoLoad&&(e.autoLoad=a.autoLoad),void 0!==a.autoSave&&(e.autoSave=a.autoSave),void 0!==a.batch&&(e.batch=a.batch),e.initReader(),e.initWriter(),"rest"===e.proxy.type?e.initRest():(e.initServerAPI(),e.initActionMethods(),e.checkProxy()),e.autoLoad&&((r.stateful||r.state)&&(e.remoteFilter||e.remoteSort)?(r.WAIT_FOR_STATE_TO_LOAD=!0,r.SERVER_FILTER_SORT=!0):e.loadData())},checkProxy(){void 0===this.proxy.api.read&&Fancy.error("In data proxy there is not url")},checkUrl(){if(void 0===this.proxy.url)throw new Error("[FancyGrid Error] - in data proxy there is not url")},initServerAPI(){const e=this,r=e.proxy;r.api=r.api||{},r.url&&(r.api.read=r.url),(r.api.update||r.api.read||r.api.create&&r.api.destroy)&&(e.proxyType="server")},initActionMethods(){const e=this.proxy,r=e.methods||{},a=e.method||"GET";r.create=r.create||a,r.read=r.read||a,r.update=r.update||a,r.destroy=r.destroy||a,e.methods=r},loadData(e){var r,a=this,t=a.proxy,i={},s=t.headers||{};if(document.activeElement&&(r=document.activeElement,document.activeElement.blur()),Fancy.apply(i,a.params),Fancy.applyIf(i,t.params),a.fire("beforeload"),"server"===a.pageType&&(i[a.pageParam]=a.showPage,i[a.limitParam]=a.pageSize,i[a.startParam]=a.showPage*a.pageSize),t.beforeRequest){const e=t.beforeRequest({type:"read",params:i,headers:s});i=e.params,s=e.headers}a.loading=!0,Fancy.Ajax({url:t.api.read,method:t.methods.read,params:i,getJSON:!0,headers:s,success(i,s,o){if(r&&r.focus(),t.afterRequest){i=t.afterRequest({type:"read",response:i}).response}if(a.loadedTimes++,a.loading=!1,!1===t.wrapper||void 0===i[a.readerRootProperty]?a.defineModel(i):a.defineModel(i[a.readerRootProperty]),a.widget.isTreeData)return!1===t.wrapper||void 0===i[a.readerRootProperty]?a.data=i:a.data=i[a.readerRootProperty],a.initTreeData(),a.widget.setSidesHeight(),a.fire("change"),a.fire("load"),a.fire("serversuccess",i,o),void(e&&e());a.paging?a.processPagingData(i):(!1===t.wrapper||void 0===i[a.readerRootProperty]?a.setData(i):a.setData(i[a.readerRootProperty]),a.widget.setSidesHeight()),a.fire("change"),a.fire("load"),a.fire("serversuccess",i,o),e&&e(),a.widget.lightStartUpdate(),a.widget._setColumnsAutoWidth()},error(e,r,t){a.fire("servererror",r,t,e)}})},proxyCRUD(e,r,a,t){const i=this;switch(e){case"UPDATE":i.proxyServerUpdate(r,a,t);break;case"DESTROY":i.proxyServerDestroy(r,a);break;case"CREATE":i.proxyServerCreate(r,a)}},proxyServerUpdate(e,r,a){var t=this,i=t.proxy,s={},o=i.headers||{},d="json"===t.writerType;if(Fancy.apply(s,t.params),Fancy.applyIf(s,i.params),i.api.update){if(d?s=Fancy.isArray(e)&&void 0===r&&void 0===a?e:t.prepareWriterJSONParams(e,r,a):(s.id=e,s[t.keyParam]=r,s[t.valueParam]=a,s.action="update"),i.beforeRequest){const e=i.beforeRequest({type:"update",params:s,headers:o});s=e.params,o=e.headers}t.loading=!0,t.fire("beforeupdate",e,r,a),Fancy.Ajax({url:i.api.update,method:i.methods.update,params:s,sendJSON:d,headers:o,success(s,o,d){if(i.afterRequest){s=i.afterRequest({type:"update",response:s}).response}t.loading=!1,t.fire("update",e,r,a),t.fire("serversuccess",s,d)},error(e,r,a){t.fire("servererror",r,a,e)}})}},proxyServerDestroy(e,r){var a=this,t=a.proxy,i={},s=t.headers||{},o="json"===a.writerType||!1===a.autoSave;if(Fancy.apply(i,a.params),Fancy.applyIf(i,t.params),o&&Fancy.isArray(e)?i=e:r?i=r:i.id=e,a.loading=!0,a.fire("beforedestroy"),t.beforeRequest){var d=t.beforeRequest({type:"destroy",params:i,headers:s});i=d.params,s=d.headers}Fancy.Ajax({url:t.api.destroy,method:t.methods.destroy,params:i,sendJSON:o,headers:s,success(r,i,s){if(t.afterRequest){r=t.afterRequest({type:"destroy",response:r}).response}a.loading=!1,a.fire("destroy",e,r),a.fire("serversuccess",r,s)},error(e,r,t){a.fire("servererror",r,t,e)}})},proxyServerCreate(e,r){var a=this,t=a.proxy,i={},s=t.headers||{},o="json"===a.writerType||!1===a.autoSave;if(Fancy.isObject(e)&&(r=e,e=e.id),Fancy.apply(i,a.params),Fancy.applyIf(i,t.params),o&&Fancy.isArray(e)?i=e:r?i=r:(i.id=e,void 0===i.id&&delete i.id),a.loading=!0,a.fire("beforecreate"),t.beforeRequest){var d=t.beforeRequest({type:"create",params:i,headers:s});i=d.params,s=d.headers}Fancy.Ajax({url:t.api.create,method:t.methods.create,params:i,sendJSON:o,headers:s,success(r,i,s){if(t.afterRequest){r=t.afterRequest({type:"create",response:r}).response}if(a.loading=!1,Fancy.isObject(r.data)&&String(e)!==String(r.data.id))a.changeItemId(e,r.data.id);else if(Fancy.isArray(r.data))for(var o=0,d=e.length;o<d;o++)String(e[o].id)!==String(r.data[o].id)&&a.changeItemId(String(e[o].id),String(r.data[o].id));a.fire("create",r.data),a.fire("serversuccess",r,s)},error(e,r,t){a.fire("servererror",r,t,e)}})},save(){var e=this,r=e.removed,a=e.changed,t=e.inserted,i=0,s=e.saveOrder.length;for(const e in t)"length"!==e&&void 0!==a[e]&&(delete a[e],a.length--);for(;i<s;i++)switch(e.saveOrder[i]){case"create":e.saveInsertActions(t);break;case"update":e.saveChangeActions(a);break;case"destroy":e.saveRemoveActions(r)}e.changed={length:0},e.removed={length:0},e.inserted={length:0}},saveChangeActions(e){const r=this;if(e.length)if(r.batch){var a=[];for(var t in e)if("length"!==t){var i=e[t],s={id:t};if(r.writeAllFields)s=r.getById(t).data;else for(var o in i)"length"!==o&&(s[o]=i[o].value);a.push(s)}1===a.length?(a=a[0],r.proxyCRUD("UPDATE",a.id,a)):r.proxyCRUD("UPDATE",a)}else for(var t in e)if("length"!==t){i=e[t],a={};if(r.writeAllFields)a=r.getById(t).data;else for(var o in i)"length"!==o&&(a[o]={id:i.id});r.proxyCRUD("UPDATE",t,a)}},saveRemoveActions(e){const r=this;if(0!==e.length)if(r.batch){var a=[];for(var t in e)if("length"!==t){var i=e[t],s={id:t};if(r.writeAllFields)s=e[t];else for(var o in i)"length"!==o&&(s={id:i.id});a.push(s)}1===a.length?(a=a[0],r.proxyCRUD("DESTROY",a.id,a)):r.proxyCRUD("DESTROY",a)}else for(var t in e)if("length"!==t){i=e[t],a={};if(r.writeAllFields)a=i;else for(var o in i)"length"!==o&&(a[o]=i[o].value);r.proxyCRUD("DESTROY",t,a)}},saveInsertActions(e){const r=this;if(0!==e.length)if(r.batch){var a=[];for(var t in e)if("length"!==t){var i=e[t],s={id:t};if(r.writeAllFields)s=r.getById(t).data;else for(var o in i.data)s[o]=i.data[o];a.push(s)}1===a.length?(a=a[0],r.proxyCRUD("CREATE",a.id,a)):r.proxyCRUD("CREATE",a)}else for(var t in e)if("length"!==t){i=e[t],a={};if(r.writeAllFields)a=i;else for(var o in i)"length"!==o&&(a[o]=i[o].value);r.proxyCRUD("CREATE",t,a)}}}),Fancy.Mixin("Fancy.store.mixin.Rest",{initRest(){this.proxyType="server",this.checkUrl(),this.initRestServerAPI(),this.initRestActionMethods()},initRestServerAPI(){const e=this.proxy,r=e.url;e.api=e.api||{},e.api.create=r,e.api.read=r,e.api.update=r,e.api.destroy=r},initRestActionMethods(){const e=this.proxy,r=e.methods||{};r.create=r.create||e.method||"POST",r.read=r.read||e.method||"GET",r.update=r.update||e.method||"PUT",r.destroy=r.destroy||e.method||"DELETE",e.methods=r}}),Fancy.Mixin("Fancy.store.mixin.Reader",{readerType:"json",readerRootProperty:"data",initReader(){const e=this,r=e.proxy;r.reader&&e.configReader(r.reader)},configReader(e){const r=this;switch(Fancy.typeOf(e)){case"string":switch(e){case"json":r.readerType=e;break;default:throw new Error(`[FancyGrid Error] - reader ${e} does not exist`)}break;case"object":switch(e.type){case void 0:r.readerType="json";break;case"json":r.readerType=e.type;break;default:throw new Error(`[FancyGrid Error] - reader ${e.type} does not exist`)}e.root&&(r.readerRootProperty=e.root)}}}),Fancy.Mixin("Fancy.store.mixin.Writer",{writerType:"string",writeAllFields:!1,initWriter(){const e=this,r=e.proxy;r.writer&&e.configWriter(r.writer)},configWriter(e){const r=this;switch(e.allFields&&(r.writeAllFields=e.allFields,e.writeAllFields=e.allFields),Fancy.typeOf(e)){case"string":switch(e){case"json":case"string":r.writerType=e;break;default:Fancy.error(`writer ${e.type} does not exist`)}break;case"object":switch(e.type){case void 0:r.writerType="string";break;case"json":case"string":r.writerType=e.type;break;default:Fancy.error(`writer ${e.type} does not exist`)}e.writeFields&&(r.writeFields=!0),e.root&&(r.writerRootProperty=e.root)}},prepareWriterJSONParams(e,r,a){var t=this,i=t.params||{},s={};return s.id=e,t.writeAllFields?Fancy.applyIf(s,t.getById(e).data):void 0===a&&Fancy.isObject(r)?Fancy.applyIf(s,r):void 0===a&&Fancy.isArray(r)?s=r:s[r]=a,t.rootProperty?(i[t.rootProperty]=s,i):s}});