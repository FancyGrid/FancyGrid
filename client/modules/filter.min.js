Fancy.Mixin("Fancy.store.mixin.Filter",{filterCheckItem:function(a){var b=this,c=b.filters,d=!0,e=!1;for(var f in c){var g=c[f],h=a.data[f];if(/\./.test(f))var i=f.split("."),h=a.data[i[0]][i[1]];"date"===g.type&&(h=Number(Fancy.Date.parse(h,g.format.read,g.format.mode)));for(var j in g){switch(j){case"type":case"format":continue}var k=g[j];switch(j){case"<":d=Number(h)<k;break;case">":d=Number(h)>k;break;case"<=":d=Number(h)<=k;break;case">=":d=Number(h)>=k;break;case"=":case"==":Fancy.isArray(k)?(h=String(h),d=-1!==k.indexOf(h)):d=h==k;break;case"===":Fancy.isArray(k)?(h=String(h),d=-1!==k.indexOf(h)):d=h===k;break;case"!==":d=h!==k;break;case"!=":d=h!=k;break;case"":d=new RegExp(String(k).toLocaleLowerCase()).test(String(h).toLocaleLowerCase());break;case"*":d=new RegExp(String(k).toLocaleLowerCase()).test(String(h).toLocaleLowerCase()),e=!0;break;case"|":d=!0===k[String(h).toLocaleLowerCase()];break;default:throw new Error("FancyGrid Error 5: Unknown filter "+j)}if(!0===e){if(!0===d)return!0}else if(!1===d)return!1}}return!0!==e||!1!==d},filterData:function(){var a=this,b=a.data,c=[],d=0,e=b.length,f=[],g=[];for(a.remoteFilter&&a.serverFilter();d<e;d++)a.order?(f.push(a.order[d]),g=b[a.order[d]]):(f.push(d),g=b[d]),a.filterCheckItem(g)&&c.push(g);a.filterOrder=f,a.filteredData=c,a.paging&&a.calcPages(),a.fire("filter")},serverFilter:function(){var a=this,b="[",c=a.filters||{};for(var d in c){var e=c[d];for(var f in e){switch(f){case"type":case"format":continue}var g=a.filterOperators[f];if("or"===g){var h=[];for(var i in e[f])h.push(i);b+='{"operator":"'+g+'","value":"'+h.join(", ")+'","property":"'+d+'"},'}else b+='{"operator":"'+g+'","value":"'+e[f]+'","property":"'+d+'"},'}}b=b.replace(/\,$/,""),b+="]",a.params=a.params||{},"[]"===b?(b="",delete a.params[a.filterParam]):a.params[a.filterParam]=encodeURIComponent(b),a.loadData()}}),Fancy.define("Fancy.grid.plugin.Filter",{extend:Fancy.Plugin,ptype:"grid.filter",inWidgetName:"filter",autoEnterDelay:500,constructor:function(a){var b=this;b.filters={},b.Super("const",arguments)},init:function(){var a=this;a.Super("init",arguments),a.ons()},ons:function(){var a=this,b=a.widget;b.store;b.once("render",function(){a.render()}),b.on("columnresize",a.onColumnResize,a),b.on("filter",a.onFilter,a),b.on("lockcolumn",a.onLockColumn,a),b.on("rightlockcolumn",a.onRightLockColumn,a),b.on("unlockcolumn",a.onUnLockColumn,a)},render:function(){var a=this,b=a.widget;a._renderSideFields(b.header,b.columns),a._renderSideFields(b.leftHeader,b.leftColumns),a._renderSideFields(b.rightHeader,b.rightColumns)},_renderSideFields:function(a,b){for(var c,d,e=this,f=e.widget,g=0,h=b.length,i=f.cellHeaderTripleCls,j=f.cellHeaderDoubleCls;g<h;g++)d=b[g],c=a.getCell(g),d.filter&&d.filter.header?(e.renderFilter(d.type,d,c),e.groupHeader&&!d.grouping&&c.addClass(i),c.addClass(f.filterHeaderCellCls)):e.header&&(e.groupHeader&&!d.grouping?c.addClass(i):d.grouping&&e.groupHeader?c.addClass(j):d.grouping||c.addClass(j))},_clearColumnsFields:function(a,b,c,d){for(var e,f=0,g=a.length;f<g;f++)if(e=a[f],e.filter&&e.filter.header){if(c&&e.index!==c)continue;switch(e.type){case"date":var h=b.getCell(f).select(".fancy-field"),i=Fancy.getWidget(h.item(0).attr("id")),j=Fancy.getWidget(h.item(1).attr("id"));i.clear(),j.clear();break;default:var k=b.getCell(f).select(".fancy-field").attr("id"),l=Fancy.getWidget(k);if(d){var m=l.get().split(",");if(m.length<2&&!d)l.clear();else{for(var n=0,o=m.length,p="";n<o;n++){var q=m[n];new RegExp(d).test(q)||(p+=q)}l.set(p)}}else l.clear()}}},clearColumnsFields:function(a,b){var c=this,d=c.widget;this._clearColumnsFields(d.columns,d.header,a,b),this._clearColumnsFields(d.leftColumns,d.leftHeader,a,b),this._clearColumnsFields(d.rightColumns,d.rightHeader,a,b)},_addValuesInColumnFields:function(a,b,c,d,e){for(var f,g=0,h=a.length;g<h;g++)if(f=a[g],f.index===c&&f.filter&&f.filter.header)switch(f.type){case"date":var i=b.getCell(g).select(".fancy-field"),j=Fancy.getWidget(i.item(0).attr("id")),k=Fancy.getWidget(i.item(1).attr("id"));j.clear(),k.clear();break;default:var l=b.getCell(g).select(".fancy-field").attr("id"),m=Fancy.getWidget(l),n=m.get(),o=m.get().split(",");if(1===o.length&&""===o[0])m.set((e||"")+d);else if(1===o.length)new RegExp(e).test(n)?m.set((e||"")+d):m.set(n+","+(e||"")+d);else{for(var p=0,q=o.length,r="";p<q;p++){var s=o[p];new RegExp(e).test(s)?(0!==r.length&&(r+=","),r+=(e||"")+d):(0!==r.length&&(r+=","),r+=s)}m.set(r)}}},addValuesInColumnFields:function(a,b,c){var d=this,e=d.widget;this._addValuesInColumnFields(e.columns,e.header,a,b,c),this._addValuesInColumnFields(e.leftColumns,e.leftHeader,a,b,c),this._addValuesInColumnFields(e.rightColumns,e.rightHeader,a,b,c)},renderFilter:function(a,b,c){var d,e=this,f=e.widget,g={position:"absolute",bottom:"3px"},h=b.filter,i=f.theme,j=h.tip;switch(a){case"date":var k=[];k.push({change:e.onDateChange,scope:e});if(Fancy.isString(b.format))switch(b.format){case"date":b.format}d=new Fancy.DateRangeField({renderTo:c.dom,value:new Date,format:b.format,label:!1,padding:!1,style:g,events:k,width:b.width-8,emptyText:h.emptyText,dateImage:!1,theme:i});break;case"string":var k=[{enter:e.onEnter,scope:e}];!1!==e.autoEnterDelay&&k.push({key:e.onKey,scope:e}),d=new Fancy.StringField({renderTo:c.dom,label:!1,padding:!1,style:g,events:k,emptyText:h.emptyText,tip:j});break;case"number":case"grossloss":case"progressbar":case"progressdonut":var k=[{enter:e.onEnter,scope:e}];!1!==e.autoEnterDelay&&k.push({key:e.onKey,scope:e}),d=new Fancy.NumberField({renderTo:c.dom,label:!1,padding:!1,style:g,emptyText:h.emptyText,events:k,tip:j});break;case"combo":var l,m="text",n="text";void 0!==b.displayKey&&(m=b.displayKey,n=m),l=Fancy.isObject(b.data)||Fancy.isObject(b.data[0])?b.data:e.configComboData(b.data),d=new Fancy.Combo({renderTo:c.dom,label:!1,padding:!1,style:g,width:b.width-8,displayKey:m,valueKey:n,value:"",height:28,emptyText:h.emptyText,theme:i,tip:j,multiSelect:b.multiSelect,itemCheckBox:b.itemCheckBox,minListWidth:b.minListWidth,events:[{change:e.onEnter,scope:e},{empty:function(){this.set(-1)}}],data:l});break;case"checkbox":d=new Fancy.Combo({renderTo:c.dom,label:!1,padding:!1,style:g,displayKey:"text",valueKey:"value",width:b.width-8,emptyText:h.emptyText,value:"",editable:!1,events:[{change:e.onEnter,scope:e}],data:[{value:"",text:""},{value:"false",text:f.lang.no},{value:"true",text:f.lang.yes}]});break;default:var k=[{enter:e.onEnter,scope:e}];!1!==e.autoEnterDelay&&k.push({key:e.onKey,scope:e}),d=new Fancy.StringField({renderTo:c.dom,label:!1,style:g,padding:!1,emptyText:h.emptyText,events:k})}switch(d.filterIndex=b.index,d.column=b,"date"!==a&&(d.el.css("padding-left","4px"),d.el.css("padding-top","0px")),a){case"checkbox":case"combo":case"date":break;default:d.setInputSize({width:b.width-8})}b.filterField=d},onEnter:function(a,b,c){var d=this,e=d.widget,f=e.store,g=a.filterIndex;if(c=c||{},d.intervalAutoEnter&&(clearInterval(d.intervalAutoEnter),d.intervalAutoEnter=!1),delete d.intervalAutoEnter,0===b.length)return d.filters[a.filterIndex]={},d.updateStoreFilters(),void(e.grouping&&e.grouping.reGroup());var h=d.processFilterValue(b,a.column.type),i=0,j=h.length;for(d.filters[g]={};i<j;i++){var k=h[i];d.filters[g][k.operator]=k.value,k.operator,"date"===a.column.type&&Fancy.apply(d.filters[g],c)}f.remoteFilter?(f.filters=d.filters,f.serverFilter()):d.updateStoreFilters(),e.grouping&&(f.remoteSort?f.once("load",function(){e.grouping.reGroup(),e.fire("filter",d.filters)}):e.grouping.reGroup()),e.setSidesHeight()},processFilterValue:function(a,b){var c,d,e,f,g,h={"<":!0,">":!0,"!":!0,"=":!0,"|":!0},i=0,j=3,k=[];if(Fancy.isArray(a))return d={},Fancy.Array.each(a,function(a,b){d[String(a).toLocaleLowerCase()]=!0}),k.push({operator:"|",value:d}),k;for(e=a.split(","),f=0,g=e.length;f<g;f++){for(i=0,c="",d=e[f];i<j;i++)h[d[i]]&&(c+=d[i]);if(d=d.replace(new RegExp("^"+c),""),!(d.length<1)){switch(b){case"number":d=Number(d);break;case"combo":c="="}k.push({operator:c,value:d})}}return k},updateStoreFilters:function(){var a=this,b=a.widget,c=b.store;c.filters=a.filters,c.changeDataView(),b.update(),b.fire("filter",a.filters)},onColumnResize:function(a,b){var c,d=this,e=(d.widget,Fancy.get(b.cell)),f=b.width,g=e.select(".fancy-field");0===g.length||(2===g.length?(c=Fancy.getWidget(g.item(0).dom.id),c.setWidth((f-8)/2),c=Fancy.getWidget(g.item(1).dom.id),c.setWidth((f-8)/2)):(c=Fancy.getWidget(g.dom.id),"field.combo"===c.wtype?(c.size({width:f-8}),c.el.css("width",f-8+5)):c.setInputSize({width:f-8})))},onKey:function(a,b,c){var d=this;d.autoEnterTime||new Date;c.keyCode!==Fancy.key.ENTER&&(d.autoEnterTime=+new Date,d.intervalAutoEnter||(d.intervalAutoEnter=setInterval(function(){var c=new Date;d.intervalAutoEnter&&c-d.autoEnterTime>d.autoEnterDelay&&(clearInterval(d.intervalAutoEnter),delete d.intervalAutoEnter,b=a.getValue(),d.onEnter(a,b))},200)))},onDateChange:function(a,b){var c,d,e,f=this,g=f.widget,h=a.format,i=g.store,j=a.dateField1.getDate(),k=a.dateField2.getDate(),l="Invalid Date"!==j.toString()&&Fancy.isDate(j),m="Invalid Date"!==k.toString()&&Fancy.isDate(k),n=i.remoteFilter;l&&(j=new Date(j.getFullYear(),j.getMonth(),j.getDate())),m&&(k=new Date(k.getFullYear(),k.getMonth(),k.getDate())),l&&m?(!0!==n?(d=Number(j),e=Number(k)):(d=Fancy.Date.format(j,h.edit,h.mode),e=Fancy.Date.format(k,h.edit,h.mode)),c=">="+d+",<="+e):l?(c=!0!==n?">="+Number(j):">="+Fancy.Date.format(j,h.edit,h.mode),f.clearFilter(a.filterIndex,"<=",!1)):m?(c=!0!==n?"<="+Number(k):"<="+Fancy.Date.format(j,h.edit,h.mode),f.clearFilter(a.filterIndex,">=",!1)):f.clearFilter(a.filterIndex),c&&f.onEnter(a,c,{type:"date",format:a.format})},clearFilter:function(a,b,c){var d=this;void 0===b?delete d.filters[a]:d.filters[a]&&delete d.filters[a][b],!1!==c&&d.updateStoreFilters()},onFilter:function(){this.widget.scroll(0)},configComboData:function(a){var b=0,c=a.length,d=[];if(Fancy.isObject(a))return a;for(;b<c;b++)d.push({value:b,text:a[b]});return d},onLockColumn:function(){this.render()},onUnLockColumn:function(){this.render()},onRightLockColumn:function(){this.render()}}),Fancy.define("Fancy.grid.plugin.Search",{extend:Fancy.Plugin,ptype:"grid.search",inWidgetName:"searching",autoEnterDelay:500,constructor:function(a){var b=this;b.searches={},b.Super("const",arguments)},init:function(){var a=this;a.Super("init",arguments),a.ons()},ons:function(){var a=this,b=a.widget;b.store;b.once("init",function(){a.generateKeys()})},search:function(a,b){var c=this,d=c.widget,e=d.store;if(c.searches={},!a&&!b)return c.clear(),c.updateStoreSearches(),void(d.grouping&&d.grouping.reGroup());!1!==Fancy.isArray(a)||b||(c.searches=a),c.setFilters(),e.remoteSort?e.serverFilter():c.updateStoreSearches(),d.grouping&&(e.remoteSort?e.once("load",function(){d.grouping.reGroup()}):d.grouping.reGroup())},updateStoreSearches:function(){var a=this,b=a.widget;b.store.changeDataView(),b.update()},setKeys:function(a){var b=this;b.keys=a,b.setFilters(),b.updateStoreSearches()},generateKeys:function(){var a=this,b=a.widget;b.store;if(!a.keys){a.keys={};var c=[];b.columns&&(c=c.concat(b.columns)),b.leftColumns&&(c=c.concat(b.leftColumns)),b.rightColumns&&(c=c.concat(b.rightColumns));for(var d=[],e=0,f=c.length;e<f;e++){var g=c[e],h=g.index||g.key;if(!1!==g.searchable){switch(g.type){case"color":case"combo":case"date":case"number":case"string":case"text":case"currency":break;default:continue}h&&d.push(h)}}for(e=0,f=d.length;e<f;e++)"$selected"!==d[e]&&(a.keys[d[e]]=!0)}return a.keys},setFilters:function(){var a=this,b=a.widget,c=b.store,d=c.filters||{};if(void 0===a.searches||Fancy.isObject(a.searches))return void a.clear();for(var e in a.keys)!1!==a.keys[e]?(d[e]=d[e]||{},d[e]["*"]=a.searches):d[e]&&delete d[e]["*"];a.filters=d,c.filters=d},clear:function(){var a=this,b=a.widget,c=b.store,d=c.filters||{};for(var e in a.keys)void 0!==d[e]&&delete d[e]["*"];a.filters=d,c.filters=d,delete a.searches}});