Fancy.define("Fancy.grid.plugin.GridToGrid",{extend:Fancy.Plugin,ptype:"grid.dragdrop",inWidgetName:"dragdrop",dropOK:!1,cellMaskCls:"fancy-drop-cell-mask",dropZoneCls:"fancy-drop-zone-active",dropOkCls:"fancy-drop-ok",dropNotOkCls:"fancy-drop-not-ok",dropHeaderMaskCls:"fancy-drop-header-mask",droppable:!0,dropZoneOverClass:"fancy-grid-body",constructor:function(a){this.Super("const",arguments)},init:function(){var a=this;a.addEvents("drop"),a.Super("init",arguments),a.initDropCls(),a.initEnterLeave(),a.ons()},initDropCls:function(){var a=this,b="."+a.dropGroup;b+=" ."+a.dropZoneOverClass,a.dropCls=b},addDragDropCls:function(){var a=this;a.widget.el.addCls(a.dragGroup)},ons:function(){var a=this,b=a.widget;b.on("render",function(){a.addDragDropCls()}),a.dropGroup&&(b.on("beforecellmousedown",a.onBeforeCellMouseDown,a),b.on("cellmousedown",a.onCellMouseDown,a),b.on("cellleave",a.onCellLeave,a),b.on("cellenter",a.onCellEnter,a)),a.on("drop",a.onDropItems,a)},onDropItems:function(a,b){var c=this,d=c.widget,e=c.dropGrid,f=void 0===e.activeRowEnterIndex?e.getViewTotal():e.activeRowEnterIndex;d.fire("dropitems",b,f),c.onDrop&&c.onDrop.apply(d,[b,f])},onBeforeCellMouseDown:function(a,b){var c=this,d=c.widget,e=d.lang,f=Fancy.get(document),g=d.getSelection();if((!b.e.ctrlKey||!0!==d.multiSelect)&&g.length>1){var h=!1;if(Fancy.each(g,function(a){if(a.id===b.id)return h=!0,!0}),!1===h)return;d.stopSelection(),f.once("mouseup",c.onDocMouseUp,c),f.on("mousemove",c.onDocMouseMove,c),f.once("mouseup",function(){d.enableSelection()},c),g=d.getSelection();var i=Fancy.String.format(e.dragText,[g.length,g.length>1?"s":""]);c.initTip(i),c.dragItems=d.getSelection(),c.cellMouseDown=!0}},onCellMouseDown:function(a,b){var c=this,d=c.widget,e=Fancy.get(document);if(!1!==d.selection.enabled){b.e.ctrlKey&&!0===d.multiSelect||("$selected"===b.column.index||d.clearSelection(),e.once("mouseup",c.onDocMouseUp,c),e.on("mousemove",c.onDocMouseMove,c),c.cellMouseDown=!0,c.activeRowIndex=b.rowIndex)}},initEnterLeave:function(){var a=this,b=Fancy.select(a.dropCls);if(0===b.length)return void setTimeout(function(){a.initEnterLeave()},500);b.on("mouseenter",a.onMouseEnterDropGroup,a),b.on("mouseleave",a.onMouseLeaveDropGroup,a)},onMouseEnterDropGroup:function(a){var b=this;if(b.cellMouseDown){var c=Fancy.get(a.currentTarget);if(b.dropGrid=Fancy.getWidget(c.closest("."+Fancy.gridCls).attr("id")),b.dropGrid&&b.dropGrid.dragdrop&&!1===b.dropGrid.dragdrop.droppable)return b.dropOK=!1,void(b.tip&&b.tip.el.replaceClass(b.dropOkCls,b.dropNotOkCls));b.setDropGridCellsMask(),b.dropGridEventInited||b.onsDropGrid(),c.addCls(b.dropZoneCls),b.dropOK=!0,b.tip&&b.tip.el.replaceClass(b.dropNotOkCls,b.dropOkCls)}},onMouseLeaveDropGroup:function(a){var b=this;b.cellMouseDown&&(Fancy.get(a.currentTarget).removeCls(b.dropZoneCls),b.dropOK=!1,b.tip.el.replaceClass(b.dropOkCls,b.dropNotOkCls),b.clearCellsMask())},setDropGridCellsMask:function(){var a,b=this,c=b.widget,d=b.dropGrid;d&&b.cellMouseDown&&(a=d.getTotal(),0===a?d.el.addCls(b.dropHeaderMaskCls):d.el.select("."+c.cellCls+'[index="'+(a-1)+'"]').addCls(b.cellMaskCls))},onsDropGrid:function(){var a=this;a.dropGrid.on("rowenter",a.onDropGridRowEnter,a),a.dropGrid.on("rowleave",a.onDropGridRowLeave,a),a.dropGridEventInited=!0},onDropGridRowEnter:function(a,b){var c=this;!1===c.cellMouseDown&&(c.dropGrid.un("rowenter",c.onDropGridRowEnter),c.dropGrid.un("rowleave",c.onDropGridRowLeave)),c.clearCellsMask(),0===b.rowIndex?a.el.addCls(c.dropHeaderMaskCls):a.el.select('.fancy-grid-cell[index="'+(b.rowIndex-1)+'"]').addCls(c.cellMaskCls),!1===c.cellMouseDown&&c.clearCellsMask(),c.dropGrid&&(c.dropGrid.activeRowEnterIndex=b.rowIndex)},onDropGridRowLeave:function(a,b){var c=this;c.clearCellsMask(),c.setDropGridCellsMask(),c.dropGrid&&delete c.dropGrid.activeRowEnterIndex},clearCellsMask:function(){var a=this,b=a.cellMaskCls;a.dropGrid&&(a.dropGrid.el.removeCls(a.dropHeaderMaskCls),a.dropGrid.el.select("."+b).removeCls(b))},onDocMouseUp:function(a){var b=this,c=b.widget,d=Fancy.get(document);b.cellMouseDown=!1,b.tip&&b.tip.hide(),c.enableSelection(),d.un("mousemove",b.onDocMouseMove),!0===b.dropOK&&(c.clearSelection(),b.dropGrid.clearSelection(),b.fire("drop",b.dragItems)),delete b.dragItems,b.dropOK=!1,Fancy.select("."+b.dropZoneCls).removeCls(b.dropZoneCls),b.clearCellsMask(),b.dropGrid&&(b.dropGrid.un("rowenter",b.onDropGridRowEnter),b.dropGrid.un("rowleave",b.onDropGridRowLeave)),delete b.dropGridEventInited},onDocMouseMove:function(a){var b=this;b.dragItems&&b.tip.show(a.pageX+20,a.pageY+20)},onCellLeave:function(a,b){var c=this,d=c.widget,e=d.lang;setTimeout(function(){if(c.onceStopDrag)return void(c.onceStopDrag=!1);if(!0===c.cellMouseDown&&!c.dragItems){var a=d.getSelection(),f=Fancy.String.format(e.dragText,[a.length,a.length>1?"s":""]);d.stopSelection(),c.initTip(f,b.e),c.tip.show(),c.tip.el.css("display","block"),c.dragItems=a}},1)},onCellEnter:function(a,b){var c=this;!0!==c.cellMouseDown||c.dragItems||b.rowIndex!==c.activeRowIndex&&(c.onceStopDrag=!0,c.activeRowIndex=b.rowIndex)},initTip:function(a,b){var c=this,d=c.dropNotOkCls;c.tip||(c.tip=new Fancy.ToolTip({cls:d,text:a})),b&&c.tip.show(b.pageX+20,b.pageY+20),c.tip.update(a),c.tip.el.replaceClass(c.dropOkCls,d)}});