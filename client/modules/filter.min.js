Fancy.Mixin("Fancy.store.mixin.Filter",{filterCheckItem:function(a){var b=this,c=b.widget,d=c.filter.caseSensitive,e=b.filters,f=!0,g=!1;if(b.isTree){var h=a.get("child");a.get("expanded");if(h){var i=[];if(Fancy.each(h,function(a,c){var d=a.data?a:new b.model(a);b.filterCheckItem(d)&&i.push(a)}),a.set("filteredChild",i),i.length)return!0}}for(var j in e){var k=c.getColumnByIndex(j),l=e[j],m=a.data[j];if(k&&k.filter&&k.filter.fn)return k.filter.fn(m,e,a);if(b.smartIndexes&&b.smartIndexes[j])m=b.smartIndexes[j](a.data);else if(/\./.test(j)){var n=j.split(".");m=a.data[n[0]][n[1]]}"date"===l.type&&(m=null===m?Math.NEGATIVE_INFINITY:Number(Fancy.Date.parse(m,l.format.read,l.format.mode))),!d&&Fancy.isString(m)&&(m=m.toLocaleLowerCase());for(var o in l){switch(o){case"type":case"format":continue}var p=l[o];switch(!d&&Fancy.isString(p)&&(p=p.toLocaleLowerCase()),o){case"<":f=Number(m)<p;break;case">":f=Number(m)>p;break;case"<=":f=Number(m)<=p;break;case">=":f=Number(m)>=p;break;case"=":case"==":Fancy.isArray(p)?(Fancy.each(p,function(a,b){p[b]=String(a)}),m=String(m),f=-1!==p.indexOf(m)):f=m==p;break;case"===":Fancy.isArray(p)?(m=String(m),f=-1!==p.indexOf(m)):f=m===p;break;case"!==":f=m!==p;break;case"!=":Fancy.isArray(p)?(Fancy.each(p,function(a,b){p[b]=String(a)}),m=String(m),f=-1===p.indexOf(m)):f=m!=p;break;case"":var q=function(a,b){return a=String(a).toLocaleLowerCase(),b=String(b).toLocaleLowerCase(),a=a.replace(/\(/g,"bracketleft"),a=a.replace(/\)/g,"bracketright"),a=a.replace(/\+/g,"plus"),a=a.replace(/\-/g,"minus"),b=b.replace(/\(/g,"bracketleft"),b=b.replace(/\)/g,"bracketright"),b=b.replace(/\+/g,"plus"),b=b.replace(/\-/g,"minus"),new RegExp(a).test(b)};if(Fancy.isArray(p))for(var r=0,s=p.length;r<s&&!1!==(f=q(p[r],m));r++);else f=q(p,m);break;case"*":p=String(p).toLocaleLowerCase(),f=new RegExp(p).test(String(m).toLocaleLowerCase()),g=!0;break;case"|":f=!0===p[String(m).toLocaleLowerCase()];break;default:throw new Error("FancyGrid Error 5: Unknown filter "+o)}if(!0===g){if(!0===f)return!0}else if(!1===f)return!1}}return!0!==g||!1!==f},filterData:function(){var a=this,b=a.data,c=[],d=0,e=b.length,f=[],g=[];if(a.remoteFilter)return void a.serverFilter();for(a.filteredDataMap={};d<e;d++)a.order?(f.push(a.order[d]),g=b[a.order[d]]):(f.push(d),g=b[d]),a.filterCheckItem(g)&&(c.push(g),a.filteredDataMap[g.id]=g);a.filterOrder=f,a.filteredData=c,a.paging&&a.calcPages(),a.fire("filter")},serverFilter:function(){var a=this,b="[",c=a.filters||{};for(var d in c){var e=c[d];for(var f in e){switch(f){case"type":case"format":continue}var g=a.filterOperators[f];if("or"===g){var h=[];for(var i in e[f])h.push(i);b+='{"operator":"'+g+'","value":"'+h.join(", ")+'","property":"'+d+'"},'}else b+='{"operator":"'+g+'","value":"'+e[f]+'","property":"'+d+'"},'}}b=b.replace(/\,$/,""),b+="]",a.params=a.params||{},"[]"===b?(b="",delete a.params[a.filterParam]):a.params[a.filterParam]=encodeURIComponent(b),a.loadData()}}),function(){var a=Fancy,b=a.FIELD_CLS,c=a.GRID_HEADER_CELL_DOUBLE_CLS,d=a.GRID_HEADER_CELL_TRIPLE_CLS,e=a.GRID_HEADER_CELL_FILTER_CLS,f=a.GRID_HEADER_CELL_FILTER_FULL_CLS,g=a.GRID_HEADER_CELL_FILTER_SMALL_CLS;a.define("Fancy.grid.plugin.Filter",{extend:a.Plugin,ptype:"grid.filter",inWidgetName:"filter",autoEnterDelay:500,caseSensitive:!0,constructor:function(a){this.filters={},this.Super("const",arguments)},init:function(){this.Super("init",arguments),this.ons()},ons:function(){var a=this,b=a.widget;b.once("render",function(){a.render()}),b.on("columnresize",a.onColumnResize,a),b.on("filter",a.onFilter,a),b.on("lockcolumn",a.onLockColumn,a),b.on("rightlockcolumn",a.onRightLockColumn,a),b.on("unlockcolumn",a.onUnLockColumn,a),b.on("columndrag",a.onColumnDrag,a)},render:function(){var a=this,b=a.widget;b.header&&(a._renderSideFields(b.header,b.columns),a._renderSideFields(b.leftHeader,b.leftColumns),a._renderSideFields(b.rightHeader,b.rightColumns))},_renderSideFields:function(a,b){for(var f,g,h=this,i=0,j=b.length;i<j;i++)g=b[i],f=a.getCell(i),g.filter&&g.filter.header?(h.renderFilter(g.type,g,f),h.groupHeader&&!g.grouping&&f.addCls(d),f.addCls(e)):h.header&&(h.groupHeader&&!g.grouping?f.addCls(d):g.grouping&&h.groupHeader?f.addCls(c):g.grouping||f.addCls(c))},_clearColumnsFields:function(c,d,e,f){for(var g,h=0,i=c.length;h<i;h++)if(g=c[h],g.filter&&g.filter.header){if(e&&g.index!==e)continue;switch(g.type){case"date":var j=d.getCell(h).select("."+b),k=a.getWidget(j.item(0).attr("id")),l=a.getWidget(j.item(1).attr("id"));k.clear(),l.clear();break;default:var m=d.getCell(h).select("."+b).attr("id"),n=a.getWidget(m);if(f){var o=n.get().split(",");if(o.length<2&&!f)n.clear();else{for(var p=0,q=o.length,r="";p<q;p++){var s=o[p];new RegExp(f).test(s)||(r+=s)}n.set(r)}}else n.clear()}}},clearColumnsFields:function(a,b){var c=this,d=c.widget;c._clearColumnsFields(d.columns,d.header,a,b),c._clearColumnsFields(d.leftColumns,d.leftHeader,a,b),c._clearColumnsFields(d.rightColumns,d.rightHeader,a,b)},_addValuesInColumnFields:function(c,d,e,f,g){for(var h,i=0,j=c.length;i<j;i++)if(h=c[i],h.index===e&&h.filter&&h.filter.header)switch(h.type){case"date":var k=d.getCell(i).select("."+b),l=a.getWidget(k.item(0).attr("id")),m=a.getWidget(k.item(1).attr("id"));l.clear(),m.clear();break;default:var n=d.getCell(i).select("."+b).attr("id"),o=a.getWidget(n),p=o.get(),q=o.get().split(",");if(1===q.length&&""===q[0])o.set((g||"")+f);else if(1===q.length)new RegExp(g).test(p)?o.set((g||"")+f):o.set(p+","+(g||"")+f);else{for(var r=0,s=q.length,t="";r<s;r++){var u=q[r];new RegExp(g).test(u)?(0!==t.length&&(t+=","),t+=(g||"")+f):(0!==t.length&&(t+=","),t+=u)}o.set(t)}}},addValuesInColumnFields:function(a,b,c){var d=this,e=d.widget;void 0!==b&&null!==b&&0!==b.length&&(d._addValuesInColumnFields(e.columns,e.header,a,b,c),d._addValuesInColumnFields(e.leftColumns,e.leftHeader,a,b,c),d._addValuesInColumnFields(e.rightColumns,e.rightHeader,a,b,c))},renderFilter:function(b,c,d){var e,f=this,g=f.widget,h={position:"absolute",bottom:"3px"},i=c.filter,j=g.theme,k=i.tip;if(Fancy.isObject(i.header)){var l=i.header;a.apply(l,{renderTo:d.dom,label:!1,style:h,theme:j,widget:g,tip:k,padding:!1});var m={combo:"Combo"};"combo"===l.type&&a.apply(l,{width:c.width-8,height:28,multiSelect:c.multiSelect,itemCheckBox:c.itemCheckBox,minListWidth:c.minListWidth,listItemTpl:c.listItemTpl});var n=m[l.type];e=new a[n](l)}else switch(b){case"date":var o=[];o.push({change:f.onDateChange,scope:f});if(a.isString(c.format))switch(c.format){case"date":c.format}e=new a.DateRangeField({renderTo:d.dom,value:new Date,format:c.format,label:!1,padding:!1,style:h,events:o,width:c.width-8,emptyText:i.emptyText,dateImage:!1,theme:j});break;case"string":var o=[{enter:f.onEnter,scope:f}];!1!==f.autoEnterDelay&&o.push({key:f.onKey,scope:f}),e=new a.StringField({renderTo:d.dom,label:!1,padding:!1,style:h,events:o,emptyText:i.emptyText,tip:k,widget:g});break;case"number":case"grossloss":case"progressbar":case"progressdonut":var o=[{enter:f.onEnter,scope:f}];!1!==f.autoEnterDelay&&o.push({key:f.onKey,scope:f}),e=new a.NumberField({renderTo:d.dom,label:!1,padding:!1,style:h,emptyText:i.emptyText,events:o,widget:g,tip:k});break;case"combo":var p,q="text",r="text";void 0!==c.displayKey&&(q=c.displayKey,r=q),p=a.isObject(c.data)||a.isObject(c.data[0])?c.data:f.configComboData(c.data);var s;c.filter&&c.filter.selectAll&&(s=c.filter.selectAll),e=new a.Combo({renderTo:d.dom,label:!1,padding:!1,style:h,width:c.width-8,displayKey:q,valueKey:r,value:"",height:28,emptyText:i.emptyText,theme:j,widget:g,tip:k,multiSelect:c.multiSelect,itemCheckBox:c.itemCheckBox,minListWidth:c.minListWidth,listItemTpl:c.listItemTpl,selectAllText:s,subSearch:c.subSearch,events:[{change:f.onEnter,scope:f},{empty:function(){this.set(-1)}}],data:p});break;case"select":g.selection&&/row/.test(g.selection.selModel)&&(e=new a.Combo({renderTo:d.dom,label:!1,padding:!1,style:h,displayKey:"text",valueKey:"value",width:c.width-8,emptyText:i.emptyText,value:"",editable:!1,events:[{change:f.onEnterSelect,scope:f}],data:[{value:"",text:""},{value:"false",text:g.lang.no},{value:"true",text:g.lang.yes}]}));break;case"checkbox":e=new a.Combo({renderTo:d.dom,label:!1,padding:!1,style:h,displayKey:"text",valueKey:"value",width:c.width-8,emptyText:i.emptyText,value:"",editable:!1,subSearch:!1,events:[{change:f.onEnter,scope:f}],data:[{value:"",text:""},{value:"false",text:g.lang.no},{value:"true",text:g.lang.yes}]});break;default:var o=[{enter:f.onEnter,scope:f}];!1!==f.autoEnterDelay&&o.push({key:f.onKey,scope:f}),e=new a.StringField({renderTo:d.dom,label:!1,style:h,padding:!1,emptyText:i.emptyText,events:o})}switch(e.filterIndex=c.index,e.column=c,"date"!==b&&(e.el.css("padding-left","4px"),e.el.css("padding-top","0px")),b){case"checkbox":case"combo":case"date":break;default:e.setInputSize({width:c.width-8})}c.filterField=e},onEnter:function(b,c,d){var e=this,f=e.widget,g=f.store,h=b.filterIndex;if(d=d||{},e.intervalAutoEnter&&(clearInterval(e.intervalAutoEnter),e.intervalAutoEnter=!1),delete e.intervalAutoEnter,0===c.length)return e.filters[b.filterIndex]={},e.clearFilter(b.filterIndex,void 0,!1),e.updateStoreFilters(),void(f.grouping&&f.grouping.reGroup());var i=e.processFilterValue(c,b.column.type),j=0,k=i.length;for(e.filters[h]={};j<k;j++){var l=i[j];""===l.operator&&b.column.filter&&b.column.filter.operator&&(l.operator=b.column.filter.operator),"&"===l.separator?a.isArray(e.filters[h][l.operator])?e.filters[h][l.operator].push(l.value):e.filters[h][l.operator]=[l.value]:e.filters[h][l.operator]=l.value,l.operator,"date"===b.column.type&&a.apply(e.filters[h],d)}g.remoteFilter?(g.filters=e.filters,g.once("serversuccess",function(){f.fire("filter",e.filters)}),g.serverFilter()):e.updateStoreFilters(),f.grouping&&(g.remoteSort?g.once("load",function(){f.grouping.reGroup(),f.fire("filter",e.filters)}):f.grouping.reGroup()),f.setSidesHeight()},onEnterSelect:function(a,b,c){var d=this,e=d.widget,f=e.getSelection(),g=[];Fancy.each(f,function(a){g.push(a.id)}),b===String(!0)?g.length?e.addFilter("id",g,"="):(e.clearFilter("id","="),e.clearFilter("id","!=")):b===String(!1)?(e.clearFilter("id","="),e.addFilter("id",g,"!=")):e.clearFilter("id")},processFilterValue:function(b,c){var d,e,f,g,h,i={"<":!0,">":!0,"!":!0,"=":!0,"|":!0},j=0,k=3,l=[];if(a.isArray(b))return e={},a.Array.each(b,function(a,b){e[String(a).toLocaleLowerCase()]=!0}),l.push({operator:"|",value:e}),l;var m=",";for(/\&/.test(b)&&(m="&"),f=b.split(m),g=0,h=f.length;g<h;g++){for(j=0,d="",e=f[g];j<k;j++)i[e[j]]&&(d+=e[j]);if(e=e.replace(new RegExp("^"+d),""),!(e.length<1)){switch(c){case"number":e=Number(e);break;case"combo":d="="}l.push({operator:d,value:e,separator:m})}}return l},updateStoreFilters:function(){var a=this,b=a.widget,c=b.store,d=!1;c.filters=a.filters;for(var e in c.filters){if(c.filters[e]){d=!0;break}}d||delete c.filteredData,c.changeDataView(),b.update(),b.fire("filter",a.filters),b.setSidesHeight(),d||delete c.filteredData},onColumnResize:function(c,d){var e,f=a.get(d.cell),g=d.width,h=f.select("."+b);0===h.length||(2===h.length?(e=a.getWidget(h.item(0).dom.id),e.setWidth((g-8)/2),e=a.getWidget(h.item(1).dom.id),e.setWidth((g-8)/2)):(e=a.getWidget(h.dom.id),"field.combo"===e.wtype?(e.size({width:g-8}),e.el.css("width",g-8+5)):e.setInputSize({width:g-8})))},onKey:function(b,c,d){var e=this;d.keyCode!==a.key.ENTER&&(e.autoEnterTime=+new Date,e.intervalAutoEnter||(e.intervalAutoEnter=setInterval(function(){var a=new Date;e.intervalAutoEnter&&a-e.autoEnterTime>e.autoEnterDelay&&(clearInterval(e.intervalAutoEnter),delete e.intervalAutoEnter,c=b.getValue(),e.onEnter(b,c))},200)))},onDateChange:function(b,c){var d,e,f,g=this,h=g.widget,i=b.format,j=h.store,k=b.dateField1.getDate(),l=b.dateField2.getDate(),m="Invalid Date"!==k.toString()&&a.isDate(k),n="Invalid Date"!==l.toString()&&a.isDate(l),o=j.remoteFilter;m&&(k=new Date(k.getFullYear(),k.getMonth(),k.getDate())),n&&(l=new Date(l.getFullYear(),l.getMonth(),l.getDate())),m&&n?(!0!==o?(e=Number(k),f=Number(l)):(e=a.Date.format(k,i.edit,i.mode),f=a.Date.format(l,i.edit,i.mode)),d=">="+e+",<="+f):m?(d=!0!==o?">="+Number(k):">="+a.Date.format(k,i.edit,i.mode),g.clearFilter(b.filterIndex,"<=",!1)):n?(d=!0!==o?"<="+Number(l):"<="+a.Date.format(k,i.edit,i.mode),g.clearFilter(b.filterIndex,">=",!1)):g.clearFilter(b.filterIndex),d&&g.onEnter(b,d,{type:"date",format:b.format})},clearFilter:function(a,b,c){var d=this;d.widget;void 0===b?delete d.filters[a]:d.filters[a]&&delete d.filters[a][b],!1!==c&&d.updateStoreFilters()},onFilter:function(){this.widget.scroll(0)},configComboData:function(b){var c=0,d=b.length,e=[];if(a.isObject(b))return b;for(;c<d;c++)e.push({value:c,text:b[c]});return e},destroyFields:function(){var b=this,h=b.widget;a.each(h.columns,function(a){a.filterField&&(a.filterField.destroy(),delete a.filterField)}),a.each(h.leftColumns,function(a){a.filterField&&(a.filterField.destroy(),delete a.filterField)}),a.each(h.rightColumns,function(a){a.filterField&&(a.filterField.destroy(),delete a.filterField)}),h.el.select("."+e).removeCls(e),h.el.select("."+f).removeCls(f),h.el.select("."+g).removeCls(g),h.el.select("."+c).removeCls(c),h.el.select("."+d).removeCls(d)},onLockColumn:function(){this.render()},onUnLockColumn:function(){this.render()},onRightLockColumn:function(){this.render()},onColumnDrag:function(){var a=this;a.destroyFields(),a.render()}})}(),Fancy.define("Fancy.grid.plugin.Search",{extend:Fancy.Plugin,ptype:"grid.search",inWidgetName:"searching",autoEnterDelay:500,constructor:function(a){this.searches={},this.Super("const",arguments)},init:function(){this.Super("init",arguments),this.ons()},ons:function(){var a=this;a.widget.once("init",function(){a.generateKeys()})},search:function(a,b){var c=this,d=c.widget,e=d.store;if(c.searches={},!a&&!b)return c.clear(),c.updateStoreSearches(),void(d.grouping&&d.grouping.reGroup());!1!==Fancy.isArray(a)||b||(c.searches=a),c.setFilters(),e.remoteSort?e.serverFilter():(c.updateStoreSearches(),setTimeout(function(){d.fire("filter",e.filters)},1)),d.grouping&&(e.remoteSort?e.once("load",function(){d.grouping.reGroup()}):d.grouping.reGroup())},updateStoreSearches:function(){var a=this.widget;a.store.changeDataView(),a.update()},setKeys:function(a){var b=this;b.keys=a,b.setFilters(),b.updateStoreSearches()},generateKeys:function(){var a=this,b=a.widget;if(a.items)a.keys={},Fancy.each(a.items,function(b){a.keys[b.index]=!0});else if(!a.keys){a.keys={};var c=[];b.columns&&(c=c.concat(b.columns)),b.leftColumns&&(c=c.concat(b.leftColumns)),b.rightColumns&&(c=c.concat(b.rightColumns));var d=[];Fancy.each(c,function(a){var b=a.index;if(!1!==a.searchable){switch(a.type){case"color":case"combo":case"date":case"number":case"string":case"text":case"currency":break;default:return}b&&d.push(b)}}),Fancy.each(d,function(b){"$selected"!==b&&(a.keys[b]=!0)})}return a.keys},setFilters:function(){var a=this,b=a.widget,c=b.store,d=c.filters||{};if(void 0===a.searches||Fancy.isObject(a.searches))return void a.clear();for(var e in a.keys)!1!==a.keys[e]?(d[e]=d[e]||{},d[e]["*"]=a.searches):d[e]&&delete d[e]["*"];a.filters=d,c.filters=d},clear:function(){var a=this,b=a.widget,c=b.store,d=c.filters||{};for(var e in a.keys)void 0!==d[e]&&delete d[e]["*"];a.filters=d,c.filters=d,delete a.searches}});