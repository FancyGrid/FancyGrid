Fancy.modules.expander=!0,function(){const e=Fancy,t=e.get,d=e.GRID_CELL_CLS,n=e.GRID_COLUMN_CLS,o=e.GRID_ROW_EXPAND_CLS,s=e.GRID_ROW_EXPAND_OVER_CLS,i=e.GRID_ROW_EXPAND_SELECTED_CLS,l=e.GRID_ROW_OVER_CLS;e.define("Fancy.grid.plugin.Expander",{extend:e.Plugin,ptype:"grid.expander",inWidgetName:"expander",plusScroll:0,enabledCollapse:!0,constructor:function(){this.Super("const",arguments)},init(){const e=this;e.Super("init",arguments),e._expanded={},e._expandedIds={},e.expandedGroups={},e.initTpl(),e.ons()},ons(){const e=this,t=e.widget,d=t.store;t.on("scroll",e.onScroll,e),t.on("beforesort",e.onBeforeSort,e),t.on("changepage",e.onChangePage,e),t.on("filter",e.onFilter,e),t.on("columnresize",e.onColumnReSize,e),t.on("rowdblclick",e.onRowDBlClick,e),t.on("rowtrackenter",e.onRowTrackOver,e),t.on("rowtrackleave",e.onRowTrackLeave,e),t.on("collapse",e.onGroupCollapse,e),t.on("expand",e.onGroupExpand,e),t.on("remove",e.onRemove,e),t.on("render",function(){t.el.on("mouseenter",e.onExpandRowMouseEnter,e,"div."+o),t.el.on("mouseleave",e.onExpandRowMouseLeave,e,"div."+o)}),t.on("select",e.onSelect,e),t.on("clearselect",e.onClearSelect,e),d.on("beforeinsert",e.onBeforeInsert,e),t.on("columndrag",e.onColumnDrag,e),t.on("lockcolumn",e.onLockColumn,e),t.on("rightlockcolumn",e.onRightLockColumn,e),t.on("unlockcolumn",e.onUnLockColumn,e),e.expanded&&(d.proxyType?t.once("load",()=>e.expandAll()):t.on("init",()=>e.expandAll()))},expand(t){const o=this,s=o.widget,i=s.get(t).id;void 0===o._expandedIds[i]?(o._expandedIds[i]={},o.expandRow(Number(t),i),o.addMargin(Number(t)+1,i)):o.showRow(Number(t),i),delete o._expandedIds[i].hidden,o.reSetTop(),o.reSetPlusScroll();for(var l=s.el.select(`.${n}[grid="${s.id}"] .${d}[index="${t}"] .fancy-checkbox-expander`),r=0,a=l.length;r<a;r++){const t=e.getWidget(l.item(r).attr("id"));!1===t.get()&&t.set(!0,!1)}o.changeSidesSize(),o.onSelect()},collapse(e){const t=this,d=t.widget,n=d.scroller,o=d.get(e).id;t.collapseRow(Number(e),o),t.clearMargin(Number(e)+1,o),t._expandedIds[o].hidden=!0,t.reSetTop(),t.reSetPlusScroll(),t.changeSidesSize(),n.scrollDelta(1),n.scrollRightKnob()},collapseRow(t,o){const s=this,i=s.widget,l=s._expandedIds[o];if(!s._expandedIds[o])return!1;s._expandedIds[o].timeOutCheckHeight1&&(clearTimeout(s._expandedIds[o].timeOutCheckHeight1),delete s._expandedIds[o].timeOutCheckHeight1),s._expandedIds[o].timeOutCheckHeight2&&(clearTimeout(s._expandedIds[o].timeOutCheckHeight2),delete s._expandedIds[o].timeOutCheckHeight2),s._expandedIds[o].timeOutCheckHeight3&&(clearTimeout(s._expandedIds[o].timeOutCheckHeight3),delete s._expandedIds[o].timeOutCheckHeight3),s._expandedIds[o].timeOutCheckHeight4&&(clearTimeout(s._expandedIds[o].timeOutCheckHeight4),delete s._expandedIds[o].timeOutCheckHeight4),l.el.hide(),l.hidden=!0,i.leftColumns&&l.leftEl.hide(),i.rightColumns&&l.rightEl.hide();for(var r=i.el.select(`.${n}[grid="${i.id}"] .${d}[index="${t}"] .fancy-checkbox-expander`),a=0,c=r.length;a<c;a++){const t=e.getWidget(r.item(a).attr("id"));!0===t.get()&&(t.set(!1,!1),t.collapsedTime=new Date)}},_hideAllSideExpandedRow(){const e=this,t=e.widget;for(const d in e._expandedIds){const n=e._expandedIds[d];n.el.hide(),n.hidden=!0,t.leftColumns&&n.leftEl.hide(),t.rightColumns&&n.rightEl.hide()}},expandAll(){let e=this.widget.getViewTotal(),t=0;for(;t<e;t++)this.expand(t)},expandRow(t,d){var n,s,i=this,l=i.widget,r=e.newEl("div"),a=l.getById(d),c=i.prepareData(a),h=-l.scroller.scrollLeft||0,p=l.getCenterFullWidth();if(i.tpl&&(n=i.tpl.getHTML(c),r.update(n)),r.addCls(o),r.css({left:h,width:p}),r.attr("index",t),l.body.el.dom.appendChild(r.dom),i.render){i.render(r.dom,c,l.getCenterFullWidth());const e=()=>{const e=parseInt(r.css("height"));s!==e&&i._expandedIds[d]&&(i._expandedIds[d].height=e,g.css("height",e),x.css("height",e),i.addMargin(Number(t)+1,d))};i._expandedIds[d].timeOutCheckHeight1=setTimeout(e,100),i._expandedIds[d].timeOutCheckHeight2=setTimeout(e,500),i._expandedIds[d].timeOutCheckHeight3=setTimeout(e,1e3),i._expandedIds[d].timeOutCheckHeight4=setTimeout(e,3e3)}if(s=parseInt(r.css("height")),i._expandedIds[d].rowIndex=t,i._expandedIds[d].el=r,i._expandedIds[d].height=s,i._expandedIds[d].width=p,l.leftColumns){var g=e.newEl("div");g.css("left","0px"),g.css("height",s),g.css("width",l.getLeftFullWidth()),g.attr("index",t),g.addCls(o),l.leftBody.el.dom.appendChild(g.dom),i._expandedIds[d].leftEl=g}if(l.rightColumns){var x=e.newEl("div");x.css("left","0px"),x.css("height",s),x.css("width",l.getRightFullWidth()),x.attr("index",t),x.addCls(o),l.rightBody.el.dom.appendChild(x.dom),i._expandedIds[d].rightEl=x}setTimeout(()=>{l.scroller.update()},100)},addMargin(e,t){const o=this.widget,s=this._expandedIds[t].height;o.el.select(`.${n}[grid="${o.id}"] .${d}[index="${e}"]`).css("margin-top",s)},clearMargin(e){const t=this.widget;t.el.select(`.${n}[grid="${t.id}"] .${d}[index="${e}"]`).css("margin-top","0")},onBeforeSort(){this.reSet()},onChangePage(){this.reSet()},onFilter(){this.reSet()},onRemove(){this.reSet()},reSet(){const e=this,t=e.widget;if(!1!==e.enabledCollapse){for(const t in e._expandedIds){const d=e._expandedIds[t];d.el.destroy(),e.clearMargin(Number(d.rowIndex)+1,t)}e._hideAllSideExpandedRow(),e._expandedIds={},e.reSetTop(),e.reSetPlusScroll(),e.changeSidesSize(),t.scroller.scrollDelta(1),t.setSidesHeight(),setTimeout(()=>{t.setSidesHeight()},100)}},showRow(e,t){const d=this.widget,n=this._expandedIds[t];n.el.show(),d.leftColumns&&n.leftEl.show(),d.rightColumns&&n.rightEl.show(),this.addMargin(e+1,t)},getBeforeHeight(e){let t=0;for(const d in this._expandedIds){const n=this._expandedIds[d];n.rowIndex<e&&!n.hidden&&"none"!==n.el.css("display")&&(t+=n.height)}return t},reSetTop(e){const t=this,d=t.widget,n=d.cellHeight,o=-d.scroller.scrollTop||0,s=-d.scroller.scrollLeft||0;if(d.isGroupable()){t.expandedGroups={};const e=d.grouping.expanded;for(var i in e)t.expandedGroups[i]=t.expandedGroups[i]||{}}for(var i in t._expandedIds){const e=t._expandedIds[i];if("none"!==e.el.css("display")){var l=t.getBeforeHeight(e.rowIndex),r=o+t.getDisplayedRowsBefore(e,i)*n+l;if(d.isGroupable()){const n=i,o=d.grouping.getGroupById(n),s=d.grouping.getGroupOrderIndex(o);"none"!==e.el.css("display")&&(t.expandedGroups[o]=t.expandedGroups[o]||{},t.expandedGroups[o][i]=e,r+=(s+1)*d.groupRowHeight)}e.el.css({top:r,left:s}),d.leftColumns&&e.leftEl.css("top",r),d.rightColumns&&e.rightEl.css("top",r)}}d.isGroupable()&&!1!==e&&(d.grouping.setPositions(),d.grouping.setExpanderCellsPosition())},getDisplayedRowsBefore(e,t){const d=this.widget;if(d.isGroupable()){let n=0;return"none"!==e.el.css("display")&&(n=d.store.getRow(t)),n+1}return e.rowIndex+1},onScroll(){this.reSetTop()},reSetPlusScroll(){const e=this.widget;this.plusScroll=this.getPlusHeight(),e.scroller.setRightKnobSize(),setTimeout(()=>{!1===e.scroller.isRightScrollable()&&e.scroller.scroll(0)},1)},getPlusHeight(){let e=this,t=0;for(const d in e._expandedIds){const n=e._expandedIds[d];n.hidden||"none"===n.el.css("display")||(t+=n.height)}return e.plusHeight=t,e.plusHeight},onColumnReSize(){const e=this,t=e.widget;for(const d in e._expandedIds){const n=e._expandedIds[d],o=t.getCenterFullWidth();n.el.css("width",o)}},prepareData(e){let t=this,d=t.widget,n=e.data;return t.dataFn&&(n=t.dataFn(d,n)),n},changeSidesSize(){const e=this.widget;e.setSidesHeight(),e.scroller.checkRightScroll()},onRowDBlClick(e,t){const d=this,n=d.widget,o=Number(t.rowIndex),s=t.id,i=d._expandedIds[s];n.edit?n.un("rowdblclick",d.onRowDBlClick,d):void 0===i?d.expand(o):!0===i.hidden&&"none"===i.el.css("display")?d.expand(o):d.collapse(o)},onRowTrackOver(e,t){const d=this.widget,n=this._expandedIds[t.id];n&&(n.el.addCls(s),d.leftColumns&&n.leftEl.addCls(s),d.rightColumns&&n.rightEl.addCls(s))},onRowTrackLeave(e,t){const d=this.widget,n=this._expandedIds[t.id];n&&(n.el.removeCls(s),d.leftColumns&&n.leftEl.removeCls(s),d.rightColumns&&n.rightEl.removeCls(s))},onExpandRowMouseEnter(e){const i=this.widget,r=i.scroller,a=t(e.currentTarget).attr("index");i.el.select(`.${o}[index="${a}"]`).addCls(s),!i.trackOver||r.bottomKnobDown||r.rightKnobDown||i.el.select(`.${n}[grid="${i.id}"] .${d}[index="${a}"]`).addCls(l)},onExpandRowMouseLeave(e){const i=this.widget,{bottomKnobDown:r,rightKnobDown:a}=i.scroller,c=t(e.currentTarget).attr("index");i.el.select(`.${o}[index="${c}"]`).removeCls(s),!i.trackOver||r||a||i.el.select(`.${n}[grid="${i.id}"] .${d}[index="${c}"]`).removeCls(l)},onSelect(){const e=this.widget,t=e.selection;t&&(t.row||t.rows)&&(this.onClearSelect(),e.getSelection(!0).rows.forEach(t=>{e.el.select(`.${o}[index="${t}"]`).addCls(i)}))},onClearSelect(){let e=this.widget,t=e.selection;if(!t.row&&!t.rows)return;let d={},n=(t=e.getSelection(!0)).rows,s=0,l=n.length;for(;s<l;s++)d[n[s]]=!0;e.el.select(`.${i}`).each(t=>{const n=t.attr("index");d[n]||e.el.select(`.${o}[index="${n}"]`).removeCls(i)})},onGroupCollapse(e,t,d){const n=this,o=n.widget,s=n.expandedGroups;if(s[d]){const e=s[d];for(const t in e){const d=e[t];n._expandedIds[t]&&delete n._expandedIds[t],d.el.hide(),d.leftEl.dom&&d.leftEl.hide(),d.rightEl.dom&&d.rightEl.hide()}}n.reSetTop(!1),n.reSetIndexes(),setTimeout(()=>{o.grouping.setExpanderCellsPosition()},1)},onGroupExpand(){const e=this.widget;this.reSetTop(!1),this.reSetIndexes(),setTimeout(()=>{e.grouping.setExpanderCellsPosition()},1)},reSetIndexes(){const e=this,t=e.widget.store;for(const d in e._expandedIds)e._expandedIds[d].rowIndex=t.getRow(d)},onAdd(){this.reSet()},onBeforeInsert(){this.reSet()},onColumnDrag(){this.reSet(),this.clearExpandedCheckBoxes()},onLockColumn(){this.reSet(),this.clearExpandedCheckBoxes()},onRightLockColumn(){this.reSet(),this.clearExpandedCheckBoxes()},onUnLockColumn(){this.reSet(),this.clearExpandedCheckBoxes()},clearExpandedCheckBoxes(){this.widget.el.select(".fancy-checkbox-expander.fancy-checkbox-on").each(e=>{const t=e.attr("id");Fancy.getWidget(t).setValue(!1,!1)})},collapseAll(){this.reSet(),this.clearExpandedCheckBoxes()}})}();