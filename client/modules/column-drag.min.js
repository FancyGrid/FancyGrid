Fancy.modules["column-drag"]=!0,function(){const e=Fancy,t=e.get(document),i=e.HIDDEN_CLS,n=e.GRID_HEADER_CELL_CLS,o=e.GRID_HEADER_CELL_TEXT_CLS,d=e.GRID_HEADER_CELL_TRIGGER_CLS,s=e.GRID_HEADER_CELL_TRIGGER_IMAGE_CLS,l=e.GRID_HEADER_CELL_GROUP_LEVEL_1_CLS,r=e.GRID_HEADER_CELL_GROUP_LEVEL_2_CLS,a=e.GRID_STATE_DRAG_COLUMN_CLS,u=e.FIELD_TEXT_INPUT_CLS,c=e.FIELD_CHECKBOX_INPUT_CLS;e.define("Fancy.grid.plugin.ColumnDrag",{extend:e.Plugin,ptype:"grid.columndrag",inWidgetName:"columndrag",activeSide:void 0,activeCell:void 0,activeIndex:void 0,activeColumn:void 0,inCell:void 0,inIndex:void 0,inSide:void 0,ok:!1,status:"none",constructor:function(){this.Super("const",arguments)},init(){const e=this,t=e.widget;e.Super("init",arguments),t.on("render",()=>{e.ons(),e.initHint()})},ons(){this.widget.el.on("mousedown",this.onMouseDownCell,this,`div.${n}`)},onMouseDownCell(i){const o=this,a=o.widget,p=Fancy.get(i.currentTarget),g=Number(p.attr("index")),h=a.getSideByCell(p),C=a.getColumns(h),m=C[g],v=e.get(i.target);m&&m.titleEditable||v.hasCls(d)||v.hasCls(s)||v.hasCls(u)||v.hasCls(c)||(p.hasCls(r)&&(o.activeCellTopGroup=o.getGroupStartEnd(p,h),o.activeCellTopGroup.cell=p),a.startResizing||(o.activeCellTopGroup||!1!==m.draggable)&&(p.hasCls(l)&&(o.activeUnderGroup=!0),o.activeSide=h,o.inSide=h,o.activeCell=p,o.inCell=p,o.activeIndex=Number(p.attr("index")),o.inIndex=o.activeIndex,o.activeColumn=C[o.activeIndex],o.mouseDownX=i.pageX,o.mouseDownY=i.pageY,t.once("mouseup",o.onMouseUp,o),t.on("mousemove",o.onMouseMove,o),a.el.on("mouseleave",o.onMouseLeave,o),a.el.on("mouseenter",o.onMouseEnterCell,o,`div.${n}`),a.el.on("mousemove",o.onMouseMoveCell,o,`div.${n}`)))},onMouseLeave(){this.hideHint()},onMouseUp(){var i,o=this,d=o.widget,s=!1;t.un("mousemove",o.onMouseMove,o),d.el.un("mouseleave",o.onMouseLeave,o),d.el.un("mouseenter",o.onMouseEnterCell,o,`div.${n}`),d.el.un("mousemove",o.onMouseMoveCell,o,`div.${n}`),o.ok&&(o.fire("beforecolumndrag"),o.inSide===o.activeSide?o.dragColumn(o.inSide):(o.activeSide,i=o.inIndex,"right"===o.okPosition&&i++,d.moveColumn(o.activeSide,o.inSide,o.activeIndex,i,o.activeCellTopGroup)),s=!0);const l={column:o.activeColumn,fromSide:o.activeSide,toSide:o.inSide};delete o.inUpGroupCell,delete o.inUnderGroup,delete o.activeCellTopGroup,delete o.activeUnderGroup,delete o.activeSide,delete o.inSide,delete o.inCell,delete o.inIndex,delete o.activeCell,delete o.activeIndex,delete o.activeColumn,delete o.mouseDownX,delete o.mouseDownY,o.ok=!1,delete o.okPosition,e.tip.hide(),setTimeout(function(){o.status="none"},1),o.removeDragState(),"dragging"===o.status&&setTimeout(()=>{o.status="none",s&&(d.fire("columndrag",l),d.sorter&&d.sorter.updateSortedHeader(),o.updateColumnHeaderLImages(),o.clearColumnMenus())},10),o.hideHint(),setTimeout(()=>{d.updateColumnsVisibility()},100),d.scroller.update()},onMouseMove(t){const i=this,n=i.widget,l=n.header,r=n.leftHeader,a=n.rightHeader,u=t.pageX,c=t.pageY,p=n.getColumns(i.activeSide),g=e.get(t.target);if(!g.hasCls(d)&&!g.hasCls(s)&&(Math.abs(u-i.mouseDownX)>10||Math.abs(c-i.mouseDownY))){if(i.activeCellTopGroup?(e.tip.update(i.activeCellTopGroup.cell.select("."+o).item(0).dom.innerHTML||"&nbsp;"),i.status="dragging",i.addDragState()):(e.tip.update(i.activeColumn.title||"&nbsp;"),i.status="dragging",i.addDragState()),1===p.length&&"center"===i.activeSide)return e.tip.hide(),setTimeout(()=>{i.status="none"},1),void i.removeDragState();e.tip.show(t.pageX+15,t.pageY+15),l.hideMenu&&(l.hideMenu(),n.leftColumns&&r.hideMenu()&&r.hideMenu(),n.rightColumns&&a.hideMenu()&&a.hideMenu())}},addDragState(){this.widget.el.addClass(a)},removeDragState(){this.widget.el.removeClass(a)},onMouseEnterCell(e){const t=this,i=t.widget,n=Fancy.get(e.currentTarget),o=i.getSideByCell(n);var d;(t.hideHint(),n.hasCls(l)?t.inUnderGroup=!0:delete t.inUnderGroup,n.hasCls(r)?t.inUpGroupCell=n:delete t.inUpGroupCell,t.inSide=o,t.inCell=n,t.inUpGroupCell)?(i.getHeader(o).el.select('[group-index="'+n.attr("index")+'"]').each(e=>{"none"!==e.css("display")&&void 0===d&&(d=Number(e.attr("index")))}),t.inIndex=d):t.inIndex=Number(n.attr("index"))},onMouseMoveCell(e){const t=this,i=t.widget,n=t.inCell,o=parseInt(n.css("width")),s=n.select(`.${d}`);if(!s.dom)return;const l=Fancy.get(e.target),r=s.within(l)||l.hasClass(d),a=t.activeUnderGroup!==t.inUnderGroup&&!0===t.inUnderGroup,u=t.activeUnderGroup!==t.inUnderGroup&&!0===t.activeUnderGroup,c=i.getColumns(t.activeSide);if(1===c.length&&"center"===t.activeSide)return t.ok=!1,void t.hideHint();if(t.activeCellTopGroup)if(t.inUpGroupCell);else{var p=t.activeCellTopGroup.start,g=t.activeCellTopGroup.end;t.activeSide!==t.inSide?(t.ok=!0,e.offsetX>o/2||r?t.showHint("right"):t.showHint("left")):isNaN(t.inIndex)?t.hideHint():t.inIndex<p?e.offsetX>o/2?t.inIndex+1===p?t.hideHint():(t.ok=!0,t.showHint("right")):(t.ok=!0,t.showHint("left")):t.inIndex>g?e.offsetX<o/2?t.inIndex===g+1?t.hideHint():(t.ok=!0,t.showHint("left")):(t.ok=!0,t.showHint("right")):t.hideHint()}else if(t.inUpGroupCell){var h=t.getGroupStartEnd();p=h.start,g=h.end;t.activeSide!==t.inSide?(t.ok=!0,e.offsetX>o/2||r?t.showHint("right"):t.showHint("left")):e.offsetX>o/2?t.activeIndex>g&&t.activeIndex-1===g?t.hideHint():(t.ok=!0,t.showHint("right")):t.activeIndex<p&&t.activeIndex+1===p?t.hideHint():(t.ok=!0,t.showHint("left"))}else if(t.activeSide!==t.inSide)t.ok=!0,e.offsetX>o/2||r?t.showHint("right"):t.showHint("left");else if(t.activeIndex===t.inIndex)t.ok=!1;else if(t.activeIndex<t.inIndex){if(e.offsetX>o/2||r)c[t.inIndex].disallowAfterDrop||(t.ok=!0,t.showHint("right"));else e.offsetX<o/2&&t.activeIndex+1!==t.inIndex?(t.ok=!0,t.showHint("left")):t.activeIndex+1===t.inIndex&&(a||u)?(t.ok=!0,t.showHint("left")):(t.ok=!1,t.hideHint())}else t.activeIndex>t.inIndex&&(e.offsetX<o/2?r?a||u?(t.ok=!0,t.showHint("right")):t.activeIndex-1===t.inIndex||t.inUpGroupCell?(t.ok=!1,t.hideHint()):(t.ok=!0,t.showHint("right")):(t.ok=!0,t.showHint("left")):e.offsetX>o/2?t.activeIndex-1===t.inIndex&&(a||u)?(t.ok=!0,t.showHint("right")):t.activeIndex-1!==t.inIndex||t.activeUnderGroup?(t.ok=!0,t.showHint("right")):(t.ok=!1,t.hideHint()):(t.ok=!1,t.hideHint()))},showHint(t){const n=this,o=n.widget,d=o.cellHeaderHeight,s=n.inCell,l=n.topEl,r=n.bottomEl,a=s.offset(),u=parseInt(s.css("width")),c=parseInt(s.css("height"));n.okPosition=t,l.removeCls(i),r.removeCls(i);var p=0;"right"===t&&(p+=u),l.css({left:a.left+p-Math.ceil(parseInt(l.css("width"))/2),top:a.top-parseInt(l.css("height"))});var g=a.top+c;if(n.inUpGroupCell){const e=o.header.calcRows();g=a.top+e*d}if(r.css({left:a.left+p-Math.ceil(parseInt(r.css("width"))/2),top:g}),o.window){const t=1e3+e.zIndex++;l.css("z-index",t),r.css("z-index",t)}},hideHint(){this.topEl.addCls(i),this.bottomEl.addCls(i)},initHint(){const t=this.widget,n=Fancy.getThemeCSSCls(t.theme),o=e.get(document.body).dom,d=e.get(document.createElement("div")),s=e.get(document.createElement("div"));d.addCls("fancy-drag-hint-top",i,n),s.addCls("fancy-drag-hint-bottom",i,n),this.topEl=e.get(o.appendChild(d.dom)),this.bottomEl=e.get(o.appendChild(s.dom))},dragColumn(e){var t=this,i=t.widget,n=i.getHeader(e),o=i.getBody(e),d=t.activeIndex,s=t.inIndex,l=t.okPosition,r=i.getColumns(e),a=r[d],u=n.calcRows();if(t.activeCellTopGroup){const n=t.activeCellTopGroup.start,o=t.activeCellTopGroup.end,d=r.splice(n,o-n+1);s=t.inIndex,"right"===l&&s++,r=t.inIndex<n?Fancy.Array.insert(r,s,d):Fancy.Array.insert(r,s-d.length,d),i.setColumnsLinksToSide(r,e)}else if(t.inUpGroupCell){const e=t.getGroupStartEnd();s=e.start,"right"===l&&(s=e.end+1)}else if("right"===l)if(t.inUnderGroup){const e=r[s].grouping,t=r[s+1];t&&t.grouping===e&&s++}else s++;if(i.groupheader&&!t.activeCellTopGroup){const e=r[s];e&&e.grouping&&t.inUnderGroup?(a.grouping=e.grouping,a.filter&&a.filter.header&&u<3&&delete a.filter):delete a.grouping}t.activeCellTopGroup||(r.splice(d,1),d<s&&s--,r.splice(s,0,a)),o.clearColumnsStyles(),n.updateTitles(),n.updateCellsSizes(),n.reSetCheckBoxes(),setTimeout(()=>{i.groupheader&&(i.header.fixGroupHeaderSizing(),i.leftColumns&&i.leftHeader.fixGroupHeaderSizing(),i.rightColumns&&i.rightHeader.fixGroupHeaderSizing(),n.reSetGroupIndexes()),n.reSetColumnsAlign(),n.reSetColumnsCls(),o.reSetColumnsAlign(),o.reSetColumnsCls(),o.updateColumnsSizes()},100),i.update()},getGroupStartEnd(t,i){const n=this.widget.getHeader(i||this.inSide),o=(t||this.inUpGroupCell).attr("index"),d=[];return n.el.select(`[group-index="${o}"]`).each(e=>{d.push(Number(e.attr("index")))}),{start:e.Array.min(d),end:e.Array.max(d)}},clearColumnMenus(){const t=this.widget;e.each(t.columns,t=>{e.isObject(t.menu)&&t._menu&&(t.menu=t._menu,delete t._menu)})},updateColumnHeaderLImages(){const e=this.widget;e.header&&(e.header.updateLImages(),e.leftColumns.length&&e.leftHeader.updateLImages(),e.rightColumns.length&&e.rightHeader.updateLImages())}})}();