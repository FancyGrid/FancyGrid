Fancy.modules.filter=!0,Fancy.Mixin("Fancy.store.mixin.Filter",{filterCheckItem:function(e){var r=this,t=r.widget,i=t.filter.caseSensitive,a=r.filters,n=!0,l=!1;if(r.isTree){var s=e.get("child");if(s){var o=[];if(Fancy.each(s,function(e){var t=e.data?e:new r.model(e);r.filterCheckItem(t)&&o.push(e)}),e.set("filteredChild",o),o.length)return!0}}for(var d in a){var c=t.getColumnByIndex(d),u=a[d],f=e.data[d];if(c&&c.filter&&c.filter.fn)return c.filter.fn(f,a,e);if(r.smartIndexes&&r.smartIndexes[d])f=r.smartIndexes[d](e.data);else if(/\./.test(d)){var g=d.split(".");f=e.data[g[0]][g[1]]}for(var h in"date"===u.type&&(f=null===f?Math.NEGATIVE_INFINITY:Number(Fancy.Date.parse(f,u.format.read,u.format.mode))),!i&&Fancy.isString(f)&&(f=f.toLocaleLowerCase()),u){switch(h){case"type":case"format":continue}var m=u[h];switch(!i&&Fancy.isString(m)&&(m=m.toLocaleLowerCase()),h){case"<":n=Number(f)<m;break;case">":n=Number(f)>m;break;case"<=":n=Number(f)<=m;break;case">=":n=Number(f)>=m;break;case"=":case"==":n=Fancy.isArray(m)?(Fancy.each(m,function(e,t){m[t]=String(e)}),f=String(f),-1!==m.indexOf(f)):f==m;break;case"===":n=Fancy.isArray(m)?(f=String(f),-1!==m.indexOf(f)):f===m;break;case"!==":n=f!==m;break;case"!=":n=Fancy.isArray(m)?(Fancy.each(m,function(e,t){m[t]=String(e)}),f=String(f),-1===m.indexOf(f)):f!=m;break;case"":var p=function(e,t){return e=String(e).toLocaleLowerCase(),t=String(t).toLocaleLowerCase(),e=(e=(e=(e=e.replace(/\(/g,"bracketleft")).replace(/\)/g,"bracketright")).replace(/\+/g,"plus")).replace(/\-/g,"minus"),t=(t=(t=(t=t.replace(/\(/g,"bracketleft")).replace(/\)/g,"bracketright")).replace(/\+/g,"plus")).replace(/\-/g,"minus"),new RegExp(e).test(t)};if(Fancy.isArray(m))for(var v=0,y=m.length;v<y&&!1!==(n=p(m[v],f));v++);else n=p(m,f);break;case"*":m=String(m).toLocaleLowerCase(),n=new RegExp(m).test(String(f).toLocaleLowerCase()),l=!0;break;case"|":n=!0===m[String(f).toLocaleLowerCase()];break;case"fn":n=!0===m(f,e);break;default:throw new Error("FancyGrid Error 5: Unknown filter "+h)}if(!0===l){if(!0===n)return!0}else if(!1===n)return!1}}return!0!==l||!1!==n},filterData:function(){var e=this,t=e.data,r=[],i=0,a=t.length,n=[],l=[];if(e.remoteFilter)e.serverFilter();else{for(e.filteredDataMap={};i<a;i++)l=e.order?(n.push(e.order[i]),t[e.order[i]]):(n.push(i),t[i]),e.filterCheckItem(l)&&(r.push(l),e.filteredDataMap[l.id]=l);e.filterOrder=n,e.filteredData=r,e.paging&&e.calcPages(),e.fire("filter")}},serverFilter:function(){var e=this,t="[",r=e.filters||{};for(var i in r){var a=r[i];for(var n in a){switch(n){case"type":case"format":continue}var l=e.filterOperators[n];if("or"===l){var s=[];for(var o in a[n])s.push(o);t+='{"operator":"'+l+'","value":"'+s.join(", ")+'","property":"'+i+'"},'}else t+='{"operator":"'+l+'","value":"'+a[n]+'","property":"'+i+'"},'}}t=t.replace(/\,$/,""),t+="]",e.params=e.params||{},"[]"===t?(t="",delete e.params[e.filterParam]):e.params[e.filterParam]=encodeURIComponent(t),e.loadData()}}),Fancy.modules.filter=!0,function(){var w=Fancy,F=w.FIELD_CLS,s=w.GRID_HEADER_CELL_DOUBLE_CLS,o=w.GRID_HEADER_CELL_TRIPLE_CLS,d=w.GRID_HEADER_CELL_FILTER_CLS,t=w.GRID_HEADER_CELL_FILTER_FULL_CLS,r=w.GRID_HEADER_CELL_FILTER_SMALL_CLS;w.define("Fancy.grid.plugin.Filter",{extend:w.Plugin,ptype:"grid.filter",inWidgetName:"filter",autoEnterDelay:500,caseSensitive:!0,constructor:function(){this.filters={},this.Super("const",arguments)},init:function(){this.Super("init",arguments),this.ons()},ons:function(){var e=this,t=e.widget;t.once("render",function(){e.render()}),t.on("columnresize",e.onColumnResize,e),t.on("filter",e.onFilter,e),t.on("lockcolumn",e.onLockColumn,e),t.on("rightlockcolumn",e.onRightLockColumn,e),t.on("unlockcolumn",e.onUnLockColumn,e),t.on("columndrag",e.onColumnDrag,e)},render:function(){var e=this.widget;e.header&&(this._renderSideFields(e.header,e.columns),this._renderSideFields(e.leftHeader,e.leftColumns),this._renderSideFields(e.rightHeader,e.rightColumns))},_renderSideFields:function(e,t){for(var r,i,a=this,n=0,l=t.length;n<l;n++)i=t[n],r=e.getCell(n),i.filter&&i.filter.header?(a.renderFilter(i.type,i,r),a.groupHeader&&!i.grouping&&r.addCls(o),r.addCls(d)):a.header&&(a.groupHeader&&!i.grouping?r.addCls(o):i.grouping&&a.groupHeader?r.addCls(s):i.grouping||r.addCls(s))},_clearColumnsFields:function(e,t,r,i){for(var a,n=0,l=e.length;n<l;n++)if((a=e[n]).filter&&a.filter.header){if(r&&a.index!==r)continue;switch(a.type){case"date":var s=t.getCell(n).select("."+F),o=w.getWidget(s.item(0).attr("id")),d=w.getWidget(s.item(1).attr("id"));o.clear(),d.clear();break;default:var c=t.getCell(n).select("."+F).attr("id"),u=w.getWidget(c);if(i){var f=u.get().split(",");if(f.length<2&&!i)u.clear();else{for(var g=0,h=f.length,m="";g<h;g++){var p=f[g];new RegExp(i).test(p)||(m+=p)}u.set(m)}}else u.clear()}}},clearColumnsFields:function(e,t){var r=this.widget;this._clearColumnsFields(r.columns,r.header,e,t),this._clearColumnsFields(r.leftColumns,r.leftHeader,e,t),this._clearColumnsFields(r.rightColumns,r.rightHeader,e,t)},_addValuesInColumnFields:function(e,t,r,i,a){for(var n,l=0,s=e.length;l<s;l++)if((n=e[l]).index===r&&n.filter&&n.filter.header)switch(n.type){case"date":var o=t.getCell(l).select("."+F),d=w.getWidget(o.item(0).attr("id")),c=w.getWidget(o.item(1).attr("id"));d.clear(),c.clear();break;default:var u=t.getCell(l).select("."+F).attr("id"),f=w.getWidget(u),g=f.get(),h=f.get().split(",");if(1===h.length&&""===h[0])f.set((a||"")+i);else if(1===h.length)new RegExp(a).test(g)?f.set((a||"")+i):f.set(g+","+(a||"")+i);else{for(var m=0,p=h.length,v="";m<p;m++){var y=h[m];new RegExp(a).test(y)?(0!==v.length&&(v+=","),v+=(a||"")+i):(0!==v.length&&(v+=","),v+=y)}f.set(v)}}},addValuesInColumnFields:function(e,t,r){var i=this.widget;null!=t&&0!==t.length&&(w.isFunction(t)||(this._addValuesInColumnFields(i.columns,i.header,e,t,r),this._addValuesInColumnFields(i.leftColumns,i.leftHeader,e,t,r),this._addValuesInColumnFields(i.rightColumns,i.rightHeader,e,t,r)))},renderFilter:function(e,t,r){var i,a=this,n=a.widget,l={position:"absolute",bottom:"3px"},s=t.filter,o=n.theme,d=s.tip,c="",u=a.filters[t.index];if(u)for(var f in u){var g=u[f];switch(f){case"":c=g;break;default:c="combo"===t.type?g:f+g}}if(Fancy.isObject(s.header)){var h=s.header;w.apply(h,{renderTo:r.dom,label:!1,style:l,theme:o,widget:n,tip:d,value:c,padding:!1});"combo"===h.type&&w.apply(h,{width:t.width-8,height:28,multiSelect:t.multiSelect,itemCheckBox:t.itemCheckBox,minListWidth:t.minListWidth,listItemTpl:t.listItemTpl});var m={combo:"Combo"}[h.type];i=new w[m](h)}else switch(e){case"date":if((p=[]).push({change:a.onDateChange,scope:a}),w.isString(t.format))switch(t.format){case"date":t.format}i=new w.DateRangeField({renderTo:r.dom,value:new Date,format:t.format,label:!1,padding:!1,style:l,events:p,width:t.width-8,emptyText:s.emptyText,dateImage:!1,value:c,theme:o});break;case"string":var p=[{enter:a.onEnter,scope:a}];!1!==a.autoEnterDelay&&p.push({key:a.onKey,scope:a}),i=new w.StringField({renderTo:r.dom,label:!1,padding:!1,style:l,events:p,emptyText:s.emptyText,tip:d,value:c,widget:n});break;case"number":case"grossloss":case"progressbar":case"progressdonut":p=[{enter:a.onEnter,scope:a}];!1!==a.autoEnterDelay&&p.push({key:a.onKey,scope:a}),i=new w.NumberField({renderTo:r.dom,label:!1,padding:!1,style:l,emptyText:s.emptyText,events:p,widget:n,value:c,tip:d});break;case"combo":var v,y,F="text",C="id";void 0!==t.displayKey&&(F=t.displayKey),C=w.isObject(t.data)||w.isObject(t.data[0])?(v=t.data,void 0!==t.valueKey?t.valueKey:C):(v=a.configComboData(t.data),F),t.filter&&t.filter.selectAll&&(y=t.filter.selectAll),i=new w.Combo({renderTo:r.dom,label:!1,padding:!1,style:l,width:t.width-8,displayKey:F,valueKey:C,value:c,height:28,emptyText:s.emptyText,theme:o,widget:n,tip:d,multiSelect:t.multiSelect,itemCheckBox:t.itemCheckBox,minListWidth:t.minListWidth,listItemTpl:t.listItemTpl,selectAllText:y,subSearch:t.subSearch,events:[{change:a.onEnter,scope:a},{empty:function(){this.set(-1)}}],data:v});break;case"select":n.selection&&/row/.test(n.selection.selModel)&&(i=new w.Combo({renderTo:r.dom,label:!1,padding:!1,style:l,displayKey:"text",valueKey:"value",width:t.width-8,emptyText:s.emptyText,value:c,editable:!1,subSearch:!1,events:[{change:a.onEnterSelect,scope:a}],data:[{value:"",text:""},{value:"false",text:n.lang.no},{value:"true",text:n.lang.yes}]}));break;case"checkbox":i=new w.Combo({renderTo:r.dom,label:!1,padding:!1,style:l,displayKey:"text",valueKey:"value",width:t.width-8,emptyText:s.emptyText,value:c,editable:!1,subSearch:!1,events:[{change:a.onEnter,scope:a}],data:[{value:"",text:""},{value:"false",text:n.lang.no},{value:"true",text:n.lang.yes}]});break;default:p=[{enter:a.onEnter,scope:a}];!1!==a.autoEnterDelay&&p.push({key:a.onKey,scope:a}),i=new w.StringField({renderTo:r.dom,label:!1,style:l,padding:!1,value:c,emptyText:s.emptyText,events:p})}switch(i.filterIndex=t.index,i.column=t,"date"!==e&&(i.el.css("padding-left","4px"),i.el.css("padding-top","0px")),e){case"checkbox":case"combo":case"date":break;default:i.setInputSize({width:t.width-8})}t.filterField=i},onEnter:function(e,t,r){var i=this,a=i.widget,n=a.store,l=e.filterIndex;if(r=r||{},i.intervalAutoEnter&&(clearInterval(i.intervalAutoEnter),i.intervalAutoEnter=!1),delete i.intervalAutoEnter,0===t.length)return i.filters[e.filterIndex]={},i.clearFilter(e.filterIndex,void 0,!1),i.updateStoreFilters(),void(a.grouping&&a.grouping.reGroup());var s=i.processFilterValue(t,e.column.type),o=0,d=s.length;for(i.filters[l]={};o<d;o++){var c=s[o];""===c.operator&&e.column.filter&&e.column.filter.operator&&(c.operator=e.column.filter.operator),"&"===c.separator?w.isArray(i.filters[l][c.operator])?i.filters[l][c.operator].push(c.value):i.filters[l][c.operator]=[c.value]:i.filters[l][c.operator]=c.value,c.operator,"date"===e.column.type&&w.apply(i.filters[l],r)}n.remoteFilter?(n.filters=i.filters,n.once("serversuccess",function(){a.fire("filter",i.filters)}),n.serverFilter()):i.updateStoreFilters(),a.grouping&&(n.remoteSort?n.once("load",function(){a.grouping.reGroup(),a.fire("filter",i.filters)}):a.grouping.reGroup()),a.setSidesHeight()},onEnterSelect:function(e,t,r){var i=this.widget,a=i.getSelection(),n=[];Fancy.each(a,function(e){n.push(e.id)}),t===String(!0)?n.length?i.addFilter("id",n,"="):(i.clearFilter("id","="),i.clearFilter("id","!=")):t===String(!1)?(i.clearFilter("id","="),i.addFilter("id",n,"!=")):i.clearFilter("id")},processFilterValue:function(e,t){var r,i,a,n,l,s={"<":!0,">":!0,"!":!0,"=":!0,"|":!0},o=0,d=[];if(w.isArray(e))return i={},w.Array.each(e,function(e,t){i[String(e).toLocaleLowerCase()]=!0}),d.push({operator:"|",value:i}),d;var c=",";for(/\&/.test(e)&&(c="&"),n=0,l=(a=e.split(c)).length;n<l;n++){for(o=0,r="",i=a[n];o<3;o++)s[i[o]]&&(r+=i[o]);if(!((i=i.replace(new RegExp("^"+r),"")).length<1)){switch(t){case"number":i=Number(i);break;case"combo":r="="}d.push({operator:r,value:i,separator:c})}}return d},updateStoreFilters:function(){var e=this.widget,t=e.store,r=!1;for(var i in e.filtering=!0,t.filters=this.filters,t.filters){if(t.filters[i]){r=!0;break}}r||delete t.filteredData,t.changeDataView(),e.update(),e.fire("filter",this.filters),e.setSidesHeight(),r||(delete t.filteredData,delete t.filteredDataMap,delete t.filterOrder),delete e.filtering},onColumnResize:function(e,t){var r,i=w.get(t.cell),a=t.width,n=i.select("."+F);2===n.length&&(n=n.item(1)),0===n.length||(2===n.length?((r=w.getWidget(n.item(0).dom.id)).setWidth((a-8)/2),(r=w.getWidget(n.item(1).dom.id)).setWidth((a-8)/2)):"field.combo"===(r=w.getWidget(n.dom.id)).wtype?(r.size({width:a-8}),r.el.css("width",a-8+5)):r.setInputSize({width:a-8}))},onKey:function(t,r,e){var i=this;e.keyCode!==w.key.ENTER&&(i.autoEnterTime=+new Date,i.intervalAutoEnter||(i.intervalAutoEnter=setInterval(function(){var e=new Date;i.intervalAutoEnter&&e-i.autoEnterTime>i.autoEnterDelay&&(clearInterval(i.intervalAutoEnter),delete i.intervalAutoEnter,r=t.getValue(),i.onEnter(t,r))},200)))},onDateChange:function(e,t){var r,i,a,n=this,l=n.widget,s=e.format,o=l.store,d=e.dateField1.getDate(),c=e.dateField2.getDate(),u="Invalid Date"!==d.toString()&&w.isDate(d),f="Invalid Date"!==c.toString()&&w.isDate(c),g=o.remoteFilter;u&&(d=new Date(d.getFullYear(),d.getMonth(),d.getDate())),f&&(c=new Date(c.getFullYear(),c.getMonth(),c.getDate())),u&&f?(a=!0!==g?(i=Number(d),Number(c)):(i=w.Date.format(d,s.edit,s.mode),w.Date.format(c,s.edit,s.mode)),r=">="+i+",<="+a):u?(r=!0!==g?">="+Number(d):">="+w.Date.format(d,s.edit,s.mode),n.clearFilter(e.filterIndex,"<=",!1)):f?(r=!0!==g?"<="+Number(c):"<="+w.Date.format(d,s.edit,s.mode),n.clearFilter(e.filterIndex,">=",!1)):n.clearFilter(e.filterIndex),r&&n.onEnter(e,r,{type:"date",format:e.format})},clearFilter:function(e,t,r){void 0===t?delete this.filters[e]:this.filters[e]&&delete this.filters[e][t],!1!==r&&this.updateStoreFilters()},onFilter:function(){this.widget.scroll(0)},configComboData:function(e){var t=0,r=e.length,i=[];if(w.isObject(e))return e;for(;t<r;t++)i.push({value:t,text:e[t]});return i},destroyFields:function(){var e=this.widget;w.each(e.columns,function(e){e.filterField&&(e.filterField.destroy(),delete e.filterField)}),w.each(e.leftColumns,function(e){e.filterField&&(e.filterField.destroy(),delete e.filterField)}),w.each(e.rightColumns,function(e){e.filterField&&(e.filterField.destroy(),delete e.filterField)}),e.el.select("."+d).removeCls(d),e.el.select("."+t).removeCls(t),e.el.select("."+r).removeCls(r),e.el.select("."+s).removeCls(s),e.el.select("."+o).removeCls(o)},onLockColumn:function(){this.render()},onUnLockColumn:function(){this.render()},onRightLockColumn:function(){this.render()},onColumnDrag:function(){this.destroyFields(),this.render()}})}(),Fancy.define("Fancy.grid.plugin.Search",{extend:Fancy.Plugin,ptype:"grid.search",inWidgetName:"searching",autoEnterDelay:500,constructor:function(){this.searches={},this.Super("const",arguments)},init:function(){this.Super("init",arguments),this.ons()},ons:function(){var e=this;e.widget.once("init",function(){e.generateKeys()})},search:function(e,t){var r=this,i=r.widget,a=i.store;if(r.searches={},!e&&!t)return r.clear(),r.updateStoreSearches(),void(i.grouping&&i.grouping.reGroup());!1!==Fancy.isArray(e)||t||(r.searches=e),r.setFilters(),a.remoteSort?a.serverFilter():(r.updateStoreSearches(),setTimeout(function(){i.fire("filter",a.filters)},1)),i.grouping&&(a.remoteSort?a.once("load",function(){i.grouping.reGroup()}):i.grouping.reGroup())},updateStoreSearches:function(){var e=this.widget;e.store.changeDataView(),e.update()},setKeys:function(e){this.keys=e,this.setFilters(),this.updateStoreSearches()},generateKeys:function(){var t=this,e=t.widget;if(t.items)t.keys={},Fancy.each(t.items,function(e){t.keys[e.index]=!0});else if(!t.keys){t.keys={};var r=[];e.columns&&(r=r.concat(e.columns)),e.leftColumns&&(r=r.concat(e.leftColumns)),e.rightColumns&&(r=r.concat(e.rightColumns));var i=[];Fancy.each(r,function(e){var t=e.index;if(!1!==e.searchable){switch(e.type){case"color":case"combo":case"date":case"number":case"string":case"text":case"currency":break;default:return}t&&i.push(t)}}),Fancy.each(i,function(e){"$selected"!==e&&(t.keys[e]=!0)})}return t.keys},setFilters:function(){var e=this,t=e.widget.store,r=t.filters||{};if(void 0===e.searches||Fancy.isObject(e.searches))e.clear();else{for(var i in e.keys)!1!==e.keys[i]?(r[i]=r[i]||{},r[i]["*"]=e.searches):r[i]&&delete r[i]["*"];e.filters=r,t.filters=r}},clear:function(){var e=this.widget.store,t=e.filters||{};for(var r in this.keys)void 0!==t[r]&&delete t[r]["*"];this.filters=t,e.filters=t,delete this.searches}});