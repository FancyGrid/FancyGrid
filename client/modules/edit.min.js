Fancy.modules.edit=!0,Fancy.define("Fancy.grid.plugin.Edit",{extend:Fancy.Plugin,ptype:"grid.edit",inWidgetName:"edit",clicksToEdit:2,tabColumnsSupport:{date:!0,combo:!0,image:!0,number:!0,string:!0,text:!0},constructor:function(){this.Super("const",arguments)},init(){const e=this,t=e.widget,i=t.store;e.addEvents("tab"),e.Super("init",arguments),t.once("render",()=>{e.ons(),i.on("beforeupdate",e.onStoreCRUDBeforeUpdate,e),i.on("update",e.onStoreCRUDUpdate,e),i.on("beforedestroy",e.onStoreCRUDBeforeDestroy,e),i.on("destroy",e.onStoreCRUDDestroy,e),i.on("create",e.onCreate,e)})},ons(){const e=this,t=e.widget,i=t.store,o="cell"+e.getClickEventName();t.on("cellclick",e.onClickCell,e),i.on("set",e.onStoreSet,e),e.on("tab",e.onTab,e),t.once("init",()=>{"cell"!==o&&t.on(o,e.onClickCellToEdit,e)}),t.on("activate",e.onGridActivate,e),t.on("deactivate",e.onGridDeActivate,e)},onGridActivate(){Fancy.get(document).on("keydown",this.onKeyDown,this)},onGridDeActivate(){Fancy.get(document).un("keydown",this.onKeyDown,this)},onKeyDown(e){const t=this.widget,i=e.keyCode,o=Fancy.key;switch(i){case o.TAB:this.fire("tab",e);break;case o.Z:t.undo()}},onTab(e,t){const i=e.widget;if(!e.activeCellEditParams)return;t.preventDefault();const o=e.getNextCellEditParam();i.celledit&&(i.celledit.hideEditor(),!1!==i.tabEdit&&setTimeout(()=>{i.celledit.edit(o)},100))},getNextCellEditParam(){const e=this,t=e.widget,i=t.store,o=e.activeCellEditParams,n=t.leftColumns;for(var s,l,r,d=o.columnIndex,a=o.rowIndex,c=o.side,h=t.getColumns(c),u=h[d+1],m=0;m<20;m++){const i=e.getNextCellInfo({side:c,columnIndex:d,rowIndex:a});if(c=i.side,d=i.columnIndex,a=i.rowIndex,u=(h=t.getColumns(c))[i.columnIndex],e.tabColumnsSupport[u.type]&&!0===u.editable&&!u.hidden)break}return(s=t.getBody(c).getCell(a,d).dom)||(c="center",n.length&&(c="left"),a=0,d=0,s=t.getBody(c).getCell(a,d).dom),l=u.index,{id:r=i.getId(a),side:c,column:u,cell:s,columnIndex:d,rowIndex:a,value:i.get(a,l),data:i.get(a),item:i.getById(r)}},getNextCellInfo(e){var t=this.widget,i=e.side,o=t.getColumns(i),n=e.columnIndex,s=e.rowIndex,l=o[n+1],r=t.rightColumns,d=t.leftColumns;if(l)n++;else switch(i){case"left":i="center",n=0;break;case"center":r.length?(i="right",n=0):d.length?(i="left",n=0,s++):(n=0,s++);break;case"right":d.length?(i="left",n=0,s++):(i="center",n=0,s++)}return{side:i,rowIndex:s,columnIndex:n}},getClickEventName(){switch(this.clicksToEdit){case 1:return"click";case 2:return"dblclick";case!1:return""}},stopEditor(){this.stopped=!0},onClickCell(e,t){const i=this.widget,o=t.column;o.editable&&("checkbox"===o.type||"switcher"===o.type)&&i.celledit&&i.celledit.onCheckBoxChange(t)},onClickCellToEdit(e,t){const i=this.widget,o=t.column;i.rowedit||i.celledit&&i.celledit.hideEditor(),i.rowedit?i.rowedit.edit(t):o.editable&&"checkbox"!==o.type&&"switcher"!==o.type&&i.celledit&&i.celledit.edit(t)},onStoreSet(e,t){this.widget.updater.updateRow(t.rowIndex)},onStoreCRUDBeforeUpdate(){const e=this.widget,t=this.activeCellEditParams;t&&e.updater.updateRow(t.rowIndex)},onStoreCRUDUpdate(e,t){delete e.changed[t],this.clearDirty()},onStoreCRUDBeforeDestroy(){},onStoreCRUDDestroy(){const e=this;clearInterval(e.intCrudDestroy),e.intCrudDestroy=setTimeout(()=>{e.widget.store.loadData(),e.clearDirty()},100)},clearDirty(){const e=this.widget;setTimeout(()=>{e.leftBody.clearDirty(),e.body.clearDirty(),e.rightBody.clearDirty()},500)},onCreate(e,t){const i=this.widget;i.updater.update(),i.fire("insert",t),this.clearDirty()}}),function(){const e=Fancy,t=e.GRID_CELL_CLS,i=e.GRID_ACTIVE_CELL_ENABLED;e.define("Fancy.grid.plugin.CellEdit",{extend:e.Plugin,ptype:"grid.celledit",inWidgetName:"celledit",editorsCls:"fancy-grid-editors",constructor:function(){this.Super("const",arguments)},init(){this.Super("init",arguments),this.ons()},ons(){const e=this,t=e.widget;t.once("render",()=>{e.initEditorContainer(),e.checkAutoInitEditors(),t.on("scroll",e.onScroll,e),t.on("nativescroll",e.onNativeScroll,e),t.on("docclick",e.onDocClick,e),t.on("headercellmousedown",e.onHeaderCellMouseDown,e)})},onDocClick(i,o){var n=this.activeCellEditParams,s=this.activeEditor,l=!0,r=o.target,d=e.get(r);if(void 0!==s&&"date"!==n.column.type)if("combo"===n.column.type)!1===s.el.within(r)&&!1===s.list.within(r)&&!0!==this.comboClick&&(l=!1),!1===l&&s.hide(),this.comboClick=!1;else{d.closest(`.${t}`).dom||s.el.within(r)||s.hide()}},initEditorContainer(){const e=this.widget;this.editorsContainer=e.el.select(`.${this.editorsCls}`)},edit(e){const t=this.widget,o=t.store,n=e.column;"$selected"!==n.index&&(t.selection&&t.selection.activeCell&&t.el.removeCls(i),this.activeCellEditParams=e,t.edit.activeCellEditParams=e,n.editor=this.generateEditor(n),o.infiniteScrolledToRow||t.scroller.scrollToCell(e.cell),this.showEditor(e))},generateEditor(t){let i,o,n=this,s=n.widget,l={position:"absolute",left:"0px",top:"0px",display:"none",padding:"0px"},r=t.type,d=t.vtype,a=s.theme;if(t.editor)return t.editor;const c={renderTo:o=n.editorsContainer.dom,label:!1,style:l,checkValidOnTyping:!0,column:t};switch(r){case"combo":var h="text",u="text",m=t.data,g=[{change:n.onComboChange,scope:n},{esc:n.onComboEsc,scope:n},{beforekey:n.onBeforeKey,scope:n},{"add-new-value":n.onComboAddNewValue,scope:n}];if(t.editorEvents)for(var p=0,E=t.editorEvents.length;p<E;p++)g.push(t.editorEvents[p]);void 0!==t.displayKey&&(h=t.displayKey,u=t.valueKey||h),"default"===a&&(a=void 0),t.minListWidth&&(c.minListWidth=t.minListWidth),t.subSearch&&(c.subSearch=t.subSearch),Fancy.apply(c,{theme:a,data:m,displayKey:h,valueKey:u,value:0,padding:!1,vtype:d,events:g}),t.emptyText&&(c.emptyText=t.emptyText),t.displayTpl&&(c.displayTpl=t.displayTpl),t.listItemTpl&&(c.listItemTpl=t.listItemTpl),t.leftTpl&&(c.leftTpl=t.leftTpl),t.leftWidth&&(c.leftWidth=t.leftWidth),i=new e.Combo(c);break;case"text":i=new e.TextArea({renderTo:o,label:!1,style:l,vtype:d,checkValidOnTyping:!0,events:[{enter:n.onEditorEnter,scope:n},{esc:n.onEditorEsc,scope:n},{beforehide:n.onEditorBeforeHide,scope:n},{blur:n.onBlur,scope:n},{beforekey:n.onBeforeKey,scope:n}]});break;case"image":case"string":case"tree":case"color":i=new e.StringField({renderTo:o,label:!1,style:l,vtype:d,format:t.format,checkValidOnTyping:!0,events:[{enter:n.onEditorEnter,scope:n},{esc:n.onEditorEsc,scope:n},{beforehide:n.onEditorBeforeHide,scope:n},{blur:n.onBlur,scope:n},{beforekey:n.onBeforeKey,scope:n}]});break;case"number":case"currency":e.apply(c,{vtype:d,format:t.format,events:[{enter:n.onEditorEnter,scope:n},{esc:n.onEditorEsc,scope:n},{beforehide:n.onEditorBeforeHide,scope:n},{blur:n.onBlur,scope:n},{beforekey:n.onBeforeKey,scope:n}]}),void 0!==t.spin&&(c.spin=t.spin),void 0!==t.step&&(c.step=t.step),void 0!==t.min&&(c.min=t.min),void 0!==t.max&&(c.max=t.max),i=new e.NumberField(c);break;case"date":i=new e.DateField({renderTo:o,label:!1,style:l,format:t.format,lang:s.lang,i18n:s.i18n,vtype:d,theme:a,checkValidOnTyping:!0,events:[{enter:n.onEditorEnter,scope:n},{esc:n.onEditorEsc,scope:n},{beforehide:n.onEditorBeforeHide,scope:n},{blur:n.onBlur,scope:n},{beforekey:n.onBeforeKey,scope:n}]});break;case"checkbox":case"switcher":break;default:e.error("Type "+r+" editor does not exit")}return i},showEditor(e){const t=this,i=t.widget,o=e.column,n=o.type,s=o.editor,l=e.cell,r=t.getCellPosition(l),d=t.getCellSize(l);if(i.fire("beforeedit",e),!0!==i.edit.stopped){if("combo"===n&&(t.comboClick=!0),s)t.activeEditor=s,t.setEditorValue(e),""===e.value&&setTimeout(()=>{var e=s.get();""===e&&s.input&&(e=s.input.dom.value),s.validate(e)},1),0===e.rowIndex&&d.height++,o.minEditorWidth&&d.width<o.minEditorWidth&&(d.width=o.minEditorWidth),t.setEditorSize(d),s.show(),s.el.css(r),"combo"===n&&s.subSearch||s.focus(),s.input&&o.cellAlign&&(s.input.css("text-align",o.cellAlign),"date"===o.type&&"right"===o.cellAlign&&s.input.css("padding-right","23px")),"combo"===n&&(void 0!==e.value&&s.set(e.value,!1),s.subSearch&&s.showList()),i.fire("startedit",e);else if(!1!==o.editable&&o.index)switch(n){case"checkbox":case"switcher":i.setById(e.item.id,o.index,!e.value)}}else i.edit.stopped=!1},setEditorSize(e){const t=this;"field.combo"===t.activeEditor.wtype?t.activeEditor.size(e):t.activeEditor.setInputSize({width:e.width,height:e.height})},hideEditor(){var t,o,n,s=this,l=s.widget,r=l.store,d=s.activeCellEditParams,a=s.activeEditor;if(a&&a.isVisible()){if(l.fire("beforeendedit",d),l.selection&&l.selection.activeCell&&l.el.addCls(i),a){if(n=d.column,o=a.get(),d.column.beforeSaveFormat)switch(e.typeOf(d.column.beforeSaveFormat)){case"string":o=this.getBeforeSaveFormat(d.column.beforeSaveFormat)(o,d);break;case"function":o=d.column.beforeSaveFormat(o,d)}"server"===r.proxyType&&"combo"!==n.type&&(t=s.getActiveColumnKey(),""===(o=s.prepareValue(o))&&null===r.get(d.rowIndex,t)||r.set(d.rowIndex,t,o)),a.getValue()!==o&&a.setValue(o),a.hide(),a.hideErrorTip()}setTimeout(()=>{delete s.activeEditor,l.fire("endedit",d)},1),l.el.dom.scrollTop&&(l.el.dom.scrollTop=0)}},getCellPosition(t){const i=this.widget,o=e.get(t).offset(),n=i.el.offset(),s=parseInt(i.el.css("border-left-width")),l=parseInt(getComputedStyle(i.el.dom)["border-top-width"]),r=(i.panel&&e.nojQuery,1);return{left:parseInt(o.left)-parseInt(n.left)-1-s+"px",top:parseInt(o.top)-parseInt(n.top)-r-l+"px"}},getCellSize(t){const i=e.get(t);return{width:i.dom.clientWidth+2,height:i.dom.clientHeight+2}},setEditorValue(t){const i=this,o=i.activeEditor;if(t.column.editFormat)switch(e.typeOf(t.column.editFormat)){case"function":t.value=t.column.editFormat(t.value,t);break;case"string":t.value=i.getEditFormat(t.column.editFormat)(t.value,t)}switch(t.column.type){case"combo":-1!==o.valueIndex&&o.set(o.getValueKey(t.value),!1);break;case"date":t.value||(t.value="");const i=t.column.format,n=e.Date.parse(t.value,i.read,i.mode);o.set(n);break;default:o.set(t.value)}},onEditorEsc(){this.hideEditor()},onComboEsc(e){e.list&&"block"===e.list.css("display")||e.aheadList&&"block"===e.aheadList.css("display")||this.hideEditor()},onEditorEnter(){const t=this.widget,i=t.selection||{};if(this.hideEditor(),i.selectBottomCellAfterEdit){var o=t.selectCellDown();setTimeout(()=>{t.el.select(`.${e.GRID_CELL_OVER_CLS}`).removeCls(e.GRID_CELL_OVER_CLS)},1)}switch(i.continueEditOnEnter){case"right":(o=i.moveRight())&&setTimeout(()=>{t.editCell(o)},100);break;case"bottom":(o=i.moveDown())&&setTimeout(()=>{t.editCell(o)},100)}},onHeaderCellMouseDown(){this.hideEditor()},setValue(e){var t,i=this,o=i.widget,n=o.store,s=i.activeCellEditParams,l=i.activeEditor;void 0!==l&&!1!==l.isValid()&&"server"!==n.proxyType&&(o.rowheight&&setTimeout(function(){o.update()},1),t=i.getActiveColumnKey(),e=i.prepareValue(e),"field.date"===l.type&&l.isEqual(n.get(s.rowIndex,t))||n.set(s.rowIndex,t,e))},onEditorBeforeHide(e){e.isValid()&&this.setValue(e.getValue())},onScroll(){this.hideEditor()},onNativeScroll(){this.hideEditor()},onBlur(e){const t=this;if(!t.activeEditor||e.id===t.activeEditor.id){if(!0===e.mouseDownSpinUp||e.mouseDownSpinDown)return;t.hideEditor()}},prepareValue(t){const i=this,o=i.getActiveColumnType(),n=i.activeCellEditParams.column,s=n.format;if(s&&s.beforeSaveFn){return t=i.activeEditor.input.dom.value,s.beforeSaveFn(t)}switch(o){case"number":case"currency":if(s&&s.inputFn){var l="",r=0,d=t.length;if(e.isNumber(t))return t;for(;r<d;r++)isNaN(Number(t[r]))||(l+=t[r]);t=l}else""!==t&&(t=Number(t));break;case"date":if(n.format&&n.format.read){const i=n.editor.getDate();t&&(t=e.Date.format(i,n.format.read,void 0,n.format.mode))}}return t},getActiveColumnType(){return this.activeCellEditParams.column.type},getActiveColumnKey(){return this.activeCellEditParams.column.index},onCheckBoxChange(e){const t=this,i=t.widget,o=e.column.index,n=i.store,s=t.checkBoxChangedValue;t.activeEditor&&t.hideEditor(),void 0!==t.checkBoxChangedValue&&(delete t.checkBoxChangedValue,t.activeCellEditParams=e,i.edit.activeCellEditParams=e,n.set(e.rowIndex,o,s))},onComboChange(e,t){const i=this.widget.store,o=this.activeCellEditParams,n=this.getActiveColumnKey();i.set(o.rowIndex,n,t),this.hideEditor()},checkAutoInitEditors(){const t=this,i=t.widget;e.each(i.columns,e=>{e.editorAutoInit&&(e.editor=t.generateEditor(e))})},onBeforeKey(t,i,o){const n=this,s=n.widget,l=s.selection||{},r=e.key;switch(o.keyCode){case r.UP:l.selectUpCellOnUp&&(n.hideEditor(),s.selectCellUp(),setTimeout(()=>{s.el.select(`.${e.GRID_CELL_OVER_CLS}`).removeCls(e.GRID_CELL_OVER_CLS)},1));break;case r.DOWN:l.selectBottomCellOnDown&&(n.hideEditor(),s.selectCellDown(),setTimeout(()=>{s.el.select(`.${e.GRID_CELL_OVER_CLS}`).removeCls(e.GRID_CELL_OVER_CLS)},1));break;case r.LEFT:if(l.selectLeftCellOnLeftEnd)0===(d=t.getInputSelection()).start&&0===d.end&&(n.hideEditor(),s.selectCellLeft(),setTimeout(()=>{s.el.select(`.${e.GRID_CELL_OVER_CLS}`).removeCls(e.GRID_CELL_OVER_CLS)},1));break;case r.RIGHT:if(l.selectRightCellOnEnd){var d=t.getInputSelection(),a=t.input.dom.value.length;d.start===a&&d.end===a&&(n.hideEditor(),s.selectCellRight(),setTimeout(()=>{s.el.select(`.${e.GRID_CELL_OVER_CLS}`).removeCls(e.GRID_CELL_OVER_CLS)},1))}}},getEditFormat(t){const i=this.widget.lang,o=i.decimalSeparator,n=i.thousandSeparator;switch(t){case"currency":return function(t,s){const l=s.column.currency||i.currencySign,r=s.column.precision||0;return""!==(t=e.Number.currencyFormat(t,o,n,r))&&(t=l+t),t}}},getBeforeSaveFormat(e){const t=this.widget.lang,i=t.thousandSeparator;switch(e){case"currency":return function(e,o){const n=o.column.currency||t.currencySign;return""!==(e=e.replace(n,"").replace(i,""))&&(e=Number(e)),e}}},onComboAddNewValue(t,i){const o=this.widget,n=t.column,s=n.index,l=n.data;e.isObject(l[0])?l.push({text:i,value:i}):l.push(i),o.setColumnComboData(s,l)}})}(),function(){const e=Fancy,t=e.each,i=e.GRID_CELL_CLS,o=e.FIELD_CLS,n=e.GRID_ROW_EDIT_CLS,s=e.GRID_ROW_EDIT_BUTTONS_CLS,l=e.GRID_ROW_EDIT_BUTTON_UPDATE_CLS,r=e.GRID_ROW_EDIT_BUTTON_CANCEL_CLS,d=e.GRID_ACTIVE_CELL_ENABLED,a=e.ANIMATE_DURATION;e.define("Fancy.grid.plugin.RowEdit",{extend:e.Plugin,ptype:"grid.rowedit",inWidgetName:"rowedit",rendered:!1,constructor:function(){this.Super("const",arguments)},init(){this.Super("init",arguments),this.ons()},ons(){const e=this,t=e.widget;t.on("scroll",e.onScroll,e),t.on("columnresize",e.onColumnResize,e),t.on("lockcolumn",e.onLockColumn,e),t.on("rightlockcolumn",e.onRightLockColumn,e),t.on("unlockcolumn",e.onUnLockColumn,e),t.on("beforecolumndrag",e.onBeforeColumnDrag,e),t.on("columndrag",e.onColumnDrag,e),t.on("columnhide",e.onColumnHide,e),t.on("columnshow",e.onColumnShow,e),t.grouping&&t.grouping.by&&(t.on("collapse",e.onCollapse,e),t.on("expand",e.onExpand,e))},onCollapse(){this.hide()},onExpand(){this.hide()},edit(e){const t=this.widget,i=e.column;i&&"$selected"===i.index||(this.activeCellEditParams=e,t.scroller.scrollToCell(e.cell),this.showEditor(e))},showEditor(t){const i=this,o=i.widget;if(o.selection&&o.selection.activeCell&&o.el.removeCls(d),o.fire("beforeedit",t),!0!==o.edit.stopped){for(var n in i.changed={},t.data)null===t.data[n]&&(t.data[n]="");if(i.rendered){const o="none"===i.el.css("display");i.show(),i.changePosition(t.rowIndex,!o),o?i.setValues(t):setTimeout(function(){i.setValues(t)},e.ANIMATE_DURATION)}else i.render(),i.changePosition(t.rowIndex,!1),i.setValues(t);i.setSizes(t)}else o.edit.stopped=!1},render(){const e=this,t=e.widget;t.leftColumns&&(e.leftEl=e.renderTo(t.leftBody.el,t.leftColumns)),t.columns&&(e.el=e.renderTo(t.body.el,t.columns)),t.rightColumns&&(e.rightEl=e.renderTo(t.rightBody.el,t.rightColumns)),e.renderButtons(),e.rendered=!0},renderTo(t,i,s,l,r){const d=t.select("."+o);var a,c,h,u,m=this,g=m.widget,p=e.get(document.createElement("div")),E=0,C=i.length,w=g.theme,f={float:"left",margin:"0px",padding:"0px"};if(l)switch(E=s,C=s+1,l){case"right":d.length&&(u=d.item(s));break;case"left":d.length&&(h=d.item(s));break;case"center":switch(r){case"left":u=d.item(0);break;case"right":h=d.item(d.length-1)}}else p.addCls(n),a=e.get(t.dom.appendChild(p.dom));for(-1===E&&(E=0,C=1);E<C;E++){const o=(c=i[E]).width,n={index:c.index,label:!1,style:f,width:o,vtype:c.vtype,format:c.format,stopPropagation:!0,theme:w,checkValidOnTyping:!0,events:[{change:m.onFieldChange,delay:100,scope:m},{empty:m.onFieldEmpty,delay:100,scope:m},{enter:m.onFieldEnter,scope:m}]};switch(l){case"left":h?n.renderAfter=h:n.renderTo=t.dom;break;case"right":u?n.renderBefore=u:n.renderTo=t.dom;break;case"center":switch(r){case"left":n.renderBefore=d.item(0);break;case"right":n.renderAfter=d.item(d.length-1)}break;default:n.renderTo=a.dom}var y;if(!1===c.editable)switch(c.type){case"string":case"number":y=new e.TextField(n);break;default:y=new e.EmptyField(n)}else switch(c.type){case"date":c.format&&(n.format=c.format),y=new e.DateField(n);break;case"image":case"string":case"text":case"color":y=new e.StringField(n);break;case"number":case"currency":c.spin&&(n.spin=c.spin),c.step&&(n.step=c.step),c.min&&(n.min=c.min),c.max&&(n.max=c.max),y=new e.NumberField(n);break;case"combo":e.apply(n,{data:c.data,value:-1,padding:!1}),c.displayKey?(n.displayKey=c.displayKey,n.valueKey=c.valueKey||c.displayKey):(n.displayKey="text",n.valueKey="text"),c.minListWidth&&(n.minListWidth=c.minListWidth),c.subSearch&&(n.subSearch=c.subSearch),y=new e.Combo(n);break;case"checkbox":switch(c.cellAlign){case"left":v=7;break;case"center":v=(c.width-20-2)/2;break;case"right":v=(c.width-20)/2+11}e.apply(n,{renderId:!0,value:!1,style:{padding:"0px",display:"inline-block","padding-left":v,float:"left",margin:"0px"}}),y=new e.CheckBox(n);break;case"switcher":var v;switch(c.cellAlign){case"left":case void 0:v=7;break;case"center":v=(c.width-20-2)/2;break;case"right":v=(c.width-20)/2+11}e.apply(n,{renderId:!0,value:!1,style:{padding:"0px",display:"inline-block","padding-left":v,float:"left",margin:"0px"}}),y=new e.Switcher(n);break;default:y=new e.EmptyField(n)}y.input&&c.cellAlign&&y.input.css("text-align",c.cellAlign),c.rowEditor=y,c.hidden&&y.hide()}return a},renderButtons(){var t,i=this,o=i.widget,n=o.lang,d=e.get(document.createElement("div"));d.addCls(s),t=e.get(o.body.el.dom.appendChild(d.dom)),i.buttonsEl=t,i.buttonUpdate=new e.Button({cls:l,renderTo:t.dom,text:n.update,events:[{click:i.onClickUpdate,scope:i}]}),i.buttonCancel=new e.Button({cls:r,renderTo:t.dom,text:n.cancel,events:[{click:i.onClickCancel,scope:i}]})},setSizes(e){const t=this,o=t.widget;o.leftColumns&&t._setSizes(o.leftBody.el.select("."+i+'[index="0"]'),o.leftColumns,"left"),o.columns&&t._setSizes(o.body.el.select("."+i+'[index="0"]'),o.columns),o.rightColumns&&t._setSizes(o.rightBody.el.select("."+i+'[index="0"]'),o.rightColumns,"right"),t.setElSize(e)},setElSize(e){var t,i=this,o=i.widget,n=o.getCenterViewWidth(),s=o.getCenterFullWidth();n<s&&i.el.css("width",s+2),e&&e.cell&&(t=e.cell.clientHeight+3,i.el.css("height",t+"px"),o.leftColumns&&i.leftEl.css("height",t+"px"),o.rightColumns&&i.rightEl.css("height",t+"px"))},_setSizes(e,t,i){for(var o,n,s,l,r=0,d=t.length;r<d;r++)o=t[r],s=e.item(r).dom,n=this.getCellSize(s),(l=o.rowEditor)&&("left"!==i&&"right"!==i||r!==d-1||n.width--,"left"===i&&"select"===o.type&&n.width--,n.height-=1,r===d-1?l.el.css("width",n.width-2):l.el.css("width",n.width-1),l.el.css("height",n.height),n.width-=2,n.width-=4,n.height-=4,this.setEditorSize(l,n))},getCellSize(t){var i=e.get(t),o=i.width(),n=i.height(),s=2;return e.nojQuery&&(s=1),{width:o+=parseInt(i.css("border-right-width"))*s,height:n+=parseInt(i.css("border-bottom-width"))*s}},setEditorSize(e,t){"field.combo"===e.wtype?(e.size(t),e.el.css("width",t.width+5)):e.setInputSize({width:t.width,height:t.height})},changePosition(t,i){var o=this,n=o.widget,s=n.infinite?0:n.scroller.getScroll(),l=n.scroller.getBottomScroll(),r=n.cellHeight*t-1-s,d=0;n.grouping&&n.grouping.by&&(r+=d+=n.grouping.getOffsetForRow(t)),o.leftEl&&(!1!==i?o.leftEl.animate({top:r},a):o.leftEl.css("top",r)),o.el&&(!1!==i?o.el.animate({top:r},a):o.el.css("top",r)),o.rightEl&&(!1!==i?o.rightEl.animate({top:r},a):o.rightEl.css("top",r));var c=n.getViewTotal()-3<t,h=r;t<3&&(c=!1),c?n.grouping&&n.grouping.by?n.getViewTotal()-3<t-n.grouping.getSpecialRowsUnder(t)?h=r-parseInt(o.buttonsEl.css("height"))+1:(h=r+n.cellHeight,c=!1):h=r-parseInt(o.buttonsEl.css("height"))+1:h=r+n.cellHeight,e.nojQuery&&(h+=1),!1!==i?o.buttonsEl.animate({top:h},a):o.buttonsEl.css("top",h),o.el.css("left",-l),o.changeButtonsLeftPos(),o.activeRowIndex=t},changeButtonsLeftPos(){const e=this.widget.getCenterViewWidth(),t=parseInt(this.buttonsEl.css("width"));this.buttonsEl.css("left",(e-t)/2)},setValues(e){const t=this,i=t.widget;i.leftColumns&&t._setValues(e.data,i.leftColumns),i.columns&&t._setValues(e.data,i.columns),i.rightColumns&&t._setValues(e.data,i.rightColumns),t.activeId=e.id,t.activeRowIndex=e.rowIndex},_setValues(i,o){const n=this;t(o,function(t){const o=t.rowEditor;if(o)switch(t.type){case"action":case"button":case"order":case"select":case"expand":case"rowdrag":break;default:var s=i[t.index];if(void 0===s&&(s=""),t.editFormat)switch(e.typeOf(t.editFormat)){case"function":s=t.editFormat(s,{column:t});break;case"string":s=n.getEditFormat(t.editFormat)(s,{column:t})}o.set(s,!1)}})},onScroll(){const e=this,t=e.widget;!1!==e.rendered&&(t.infinite&&e.hide(),void 0!==e.activeRowIndex&&e.changePosition(e.activeRowIndex,!1))},onColumnResize(){const t=this;!1!==t.rendered&&(e.nojQuery?setTimeout(()=>{t.setSizes()},400):setTimeout(()=>{t.setSizes()},a))},onClickUpdate(){this.saveChanges()},saveChanges(){var t=this,i=t.widget,o=i.store,n=t.prepareChanged(),s=o.getRow(t.activeId),l=t.getComboNewValues();for(const t in l){const n=o.getColumnUniqueData(t);e.isString(n[0])?n.push(l[t]):n.push({value:l[t],text:l[t]}),i.setColumnComboData(t,n)}e.apply(n,l),o.setItemData(s,n),i.update(),t.hide()},prepareChanged(){const t=this.widget,i=this.changed;for(const o in i){const n=t.getColumnByIndex(o);switch(n.type){case"date":const t=e.Date.parse(i[o],n.format.edit,n.format.mode),s=e.Date.format(t,n.format.read,n.format.mode);i[o]=s}}return i},onClickCancel(){this.hide()},hide(){const e=this,t=e.widget;t.fire("beforeendedit",e.activeCellEditParams),t.selection&&t.selection.activeCell&&t.el.addCls(d),e.el&&(e.leftEl&&e.leftEl.hide(),e.el.hide(),e.rightEl&&e.rightEl.hide(),e.buttonsEl.hide(),t.fire("endedit",e.activeCellEditParams))},show(){const e=this;e.leftEl&&("none"===e.leftEl.css("display")&&e.leftEl.css("opacity",0),e.leftEl.show(),e.leftEl.animate({opacity:1},a)),"none"===e.el.css("display")&&e.el.css("opacity",0),e.el.show(),e.el.animate({opacity:1},a),e.rightEl&&("none"===e.rightEl.css("display")&&e.rightEl.css("opacity",0),e.rightEl.show(),e.rightEl.animate({opacity:1},a)),"none"===e.buttonsEl.css("display")&&e.buttonsEl.css("opacity",0),e.buttonsEl.show(),e.buttonsEl.animate({opacity:1},a)},onFieldChange(e,t){const i=this;e.isValid()?i.changed[e.index]=t:delete i.changed[e.index]},onFieldEmpty(e){const t=this;e.vtype&&!e.isValid()?delete t.changed[e.index]:t.changed[e.index]=""},onFieldEnter(){this.saveChanges()},hideField(e,t){const i=this.widget.getColumns(t)[e];i.rowEditor&&i.rowEditor.hide()},showField(e,t){const i=this.widget.getColumns(t)[e];i.rowEditor&&i.rowEditor.show()},moveEditor(e,t,i,o){var s,l=this,r=l.widget,d=r.store,a=r.getColumns(i),c=e.rowEditor,h=r.getBody(i).el.select("."+n),u=d.getById(l.activeId).get(e.index);h.dom&&(void 0===l.activeId&&(u=d.ge1t(l.activeRowIndex)[e.index]),c.destroy(),l.renderTo(h,a,t,i,o),s=l.getField(t,i),e.rowEditor=s,s.set(u),l.setSizes(),l.changeButtonsLeftPos(),l.reSetColumnsEditorsLinks())},getField(t,i){var s=this.widget.getBody(i);switch(i){case"left":t++}return e.getWidget(s.el.select("."+n+" ."+o).item(t).attr("id"))},reSetColumnsEditorsLinks(){var i=this.widget,s=i.body.el.select("."+n+" ."+o);t(i.columns,(t,i)=>{t.rowEditor=e.getWidget(s.item(i).attr("id"))}),s=i.leftBody.el.select("."+n+" ."+o),t(i.leftColumns,(t,i)=>{t.rowEditor=e.getWidget(s.item(i).attr("id"))}),s=i.rightBody.el.select("."+n+" ."+o),t(i.rightColumns,(t,i)=>{t.rowEditor=e.getWidget(s.item(i).attr("id"))})},onBeforeColumnDrag(){this.destroyEls(),this.hide()},onColumnDrag(){this.destroyEls(),this.hide()},onColumnHide(){this.destroyEls(),this.hide()},onColumnShow(){this.destroyEls(),this.hide()},onLockColumn(){this.destroyEls(),this.hide()},onRightLockColumn(){this.destroyEls(),this.hide()},onUnLockColumn(){this.destroyEls(),this.hide()},destroyEls(){const t=this,i=t.widget;t.rendered&&(t.rendered=!1,i.leftColumns&&(e.each(i.leftColumns,e=>{e.rowEditor.destroy(),delete e.rowEditor}),t.leftEl.destroy()),i.columns&&(e.each(i.columns,e=>{e.rowEditor.destroy(),delete e.rowEditor}),t.el.destroy()),i.rightColumns&&(e.each(i.rightColumns,e=>{e.rowEditor.destroy(),delete e.rowEditor}),t.rightEl.destroy()))},isVisible(){return"none"!==this.el.css("display")},getEditFormat(t){const i=this.widget.lang,o=i.decimalSeparator,n=i.thousandSeparator;switch(t){case"currency":return function(t,s){const l=s.column.currency||i.currencySign,r=s.column.precision||0;return""!==(t=e.Number.currencyFormat(t,o,n,r))&&(t=l+t),t}}},getComboNewValues(){const t=this.widget.getColumns(),i={};return e.each(t,t=>{if("combo"===t.type&&t.editable&&t.rowEditor){const o=t.rowEditor,n=o.get();-1===o.value&&e.isString(n)&&n.length?i[t.index]=n:o.getInputValue()!==n&&(i[t.index]=o.getInputValue())}}),i}})}();