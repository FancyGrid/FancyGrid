!function(){var a=Fancy,b=a.get,c=a.GRID_CELL_CLS,d=a.GRID_COLUMN_CLS,e=a.GRID_ROW_EXPAND_CLS,f=a.GRID_ROW_EXPAND_OVER_CLS,g=a.GRID_ROW_EXPAND_SELECTED_CLS,h=a.GRID_ROW_OVER_CLS;a.define("Fancy.grid.plugin.Expander",{extend:a.Plugin,ptype:"grid.expander",inWidgetName:"expander",plusScroll:0,enabledCollapse:!0,constructor:function(a){this.Super("const",arguments)},init:function(){var a=this;a.Super("init",arguments),a._expanded={},a._expandedIds={},a.expandedGroups={},a.initTpl(),a.ons()},ons:function(){var a=this,b=a.widget,c=b.store;b.on("scroll",a.onScroll,a),b.on("beforesort",a.onBeforeSort,a),b.on("changepage",a.onChangePage,a),b.on("filter",a.onFilter,a),b.on("columnresize",a.onColumnReSize,a),b.on("rowdblclick",a.onRowDBlClick,a),b.on("rowtrackenter",a.onRowTrackOver,a),b.on("rowtrackleave",a.onRowTrackLeave,a),b.on("collapse",a.onGroupCollapse,a),b.on("expand",a.onGroupExpand,a),b.on("remove",a.onRemove,a),b.on("render",function(){b.el.on("mouseenter",a.onExpandRowMouseEnter,a,"div."+e),b.el.on("mouseleave",a.onExpandRowMouseLeave,a,"div."+e)}),b.on("select",a.onSelect,a),b.on("clearselect",a.onClearSelect,a),c.on("beforeinsert",a.onBeforeInsert,a),b.on("columndrag",a.onColumnDrag,a),b.on("lockcolumn",a.onLockColumn,a),b.on("rightlockcolumn",a.onRightLockColumn,a),b.on("unlockcolumn",a.onUnLockColumn,a),a.expanded&&(c.proxyType?b.once("load",function(){a.expandAll()}):b.on("init",function(){a.expandAll()}))},expand:function(b){var e=this,f=e.widget,g=f.get(b).id;void 0===e._expandedIds[g]?(e._expandedIds[g]={},e.expandRow(Number(b),g),e.addMargin(Number(b)+1,g)):e.showRow(Number(b),g),delete e._expandedIds[g].hidden,e.reSetTop(),e.reSetPlusScroll();for(var h=f.el.select("."+d+'[grid="'+f.id+'"] .'+c+'[index="'+b+'"] .fancy-checkbox-expander'),i=0,j=h.length;i<j;i++){var k=a.getWidget(h.item(i).attr("id"));!1===k.get()&&k.set(!0,!1)}e.changeSidesSize(),e.onSelect()},collapse:function(a){var b=this,c=b.widget,d=c.scroller,e=c.get(a).id;b.collapseRow(Number(a),e),b.clearMargin(Number(a)+1,e),delete b._expandedIds[e],b.reSetTop(),b.reSetPlusScroll(),b.changeSidesSize(),d.scrollDelta(1),d.scrollRightKnob()},collapseRow:function(b,e){var f=this,g=f.widget,h=f._expandedIds[e];f._expandedIds[e].timeOutCheckHeight1&&(clearTimeout(f._expandedIds[e].timeOutCheckHeight1),delete f._expandedIds[e].timeOutCheckHeight1),f._expandedIds[e].timeOutCheckHeight2&&(clearTimeout(f._expandedIds[e].timeOutCheckHeight2),delete f._expandedIds[e].timeOutCheckHeight2),f._expandedIds[e].timeOutCheckHeight3&&(clearTimeout(f._expandedIds[e].timeOutCheckHeight3),delete f._expandedIds[e].timeOutCheckHeight3),f._expandedIds[e].timeOutCheckHeight4&&(clearTimeout(f._expandedIds[e].timeOutCheckHeight4),delete f._expandedIds[e].timeOutCheckHeight4),h.el.hide(),h.hidden=!0,g.leftColumns&&h.leftEl.hide(),g.rightColumns&&h.rightEl.hide();for(var i=g.el.select("."+d+'[grid="'+g.id+'"] .'+c+'[index="'+b+'"] .fancy-checkbox-expander'),j=0,k=i.length;j<k;j++){var l=a.getWidget(i.item(j).attr("id"));!0===l.get()&&(l.set(!1,!1),l.collapsedTime=new Date)}},_hideAllSideExpandedRow:function(){var a=this,b=a.widget;for(var c in a._expandedIds){var d=a._expandedIds[c];d.el.hide(),d.hidden=!0,b.leftColumns&&d.leftEl.hide(),b.rightColumns&&d.rightEl.hide()}},expandAll:function(){for(var a=this.widget,b=a.getViewTotal(),c=0;c<b;c++)this.expand(c)},expandRow:function(a,c){var d,f,g=this,h=g.widget,i=b(document.createElement("div")),j=h.getById(c),k=g.prepareData(j),l=-h.scroller.scrollLeft||0,m=h.getCenterFullWidth();if(g.tpl&&(d=g.tpl.getHTML(k),i.update(d)),i.addCls(e),i.css({left:l,width:m}),i.attr("index",a),h.body.el.dom.appendChild(i.dom),g.render){g.render(i.dom,k,h.getCenterFullWidth());var n=function(){var b=parseInt(i.css("height"));f!==b&&g._expandedIds[c]&&(g._expandedIds[c].height=b,o.css("height",b),p.css("height",b),g.addMargin(Number(a)+1,c))};g._expandedIds[c].timeOutCheckHeight1=setTimeout(n,100),g._expandedIds[c].timeOutCheckHeight2=setTimeout(n,500),g._expandedIds[c].timeOutCheckHeight3=setTimeout(n,1e3),g._expandedIds[c].timeOutCheckHeight4=setTimeout(n,3e3)}if(f=parseInt(i.css("height")),g._expandedIds[c].rowIndex=a,g._expandedIds[c].el=i,g._expandedIds[c].height=f,g._expandedIds[c].width=m,h.leftColumns){var o=b(document.createElement("div"));o.css("left","0px"),o.css("height",f),o.css("width",h.getLeftFullWidth()),o.attr("index",a),o.addCls(e),h.leftBody.el.dom.appendChild(o.dom),g._expandedIds[c].leftEl=o}if(h.rightColumns){var p=b(document.createElement("div"));p.css("left","0px"),p.css("height",f),p.css("width",h.getRightFullWidth()),p.attr("index",a),p.addCls(e),h.rightBody.el.dom.appendChild(p.dom),g._expandedIds[c].rightEl=p}setTimeout(function(){h.scroller.update()},100)},addMargin:function(a,b){var e=this,f=e.widget,g=e._expandedIds[b].height;f.el.select("."+d+'[grid="'+f.id+'"] .'+c+'[index="'+a+'"]').css("margin-top",g)},clearMargin:function(a){var b=this.widget;b.el.select("."+d+'[grid="'+b.id+'"] .'+c+'[index="'+a+'"]').css("margin-top","0")},onBeforeSort:function(){this.reSet()},onChangePage:function(){this.reSet()},onFilter:function(){this.reSet()},onRemove:function(){this.reSet()},reSet:function(){var a=this,b=a.widget;if(!1!==a.enabledCollapse){for(var c in a._expandedIds){var d=a._expandedIds[c];d.el.destroy(),a.clearMargin(Number(d.rowIndex)+1,c)}a._hideAllSideExpandedRow(),a._expandedIds={},a.reSetTop(),a.reSetPlusScroll(),a.changeSidesSize(),b.scroller.scrollDelta(1),b.setSidesHeight(),setTimeout(function(){b.setSidesHeight()},100)}},showRow:function(a,b){var c=this,d=c.widget,e=c._expandedIds[b];e.el.show(),d.leftColumns&&e.leftEl.show(),d.rightColumns&&e.rightEl.show(),c.addMargin(a+1,b)},getBeforeHeight:function(a){var b=0;for(var c in this._expandedIds){var d=this._expandedIds[c];d.rowIndex<a&&!d.hidden&&"none"!==d.el.css("display")&&(b+=d.height)}return b},reSetTop:function(a){var b=this,c=b.widget,d=c.cellHeight,e=-c.scroller.scrollTop||0,f=-c.scroller.scrollLeft||0;if(c.grouping){b.expandedGroups={};var g=c.grouping.expanded;for(var h in g)b.expandedGroups[h]=b.expandedGroups[h]||{}}for(var h in b._expandedIds){var i=b._expandedIds[h];if("none"!==i.el.css("display")){var j=b.getBeforeHeight(i.rowIndex),k=b.getDisplayedRowsBefore(i,h),l=e+k*d+j;if(c.grouping){var m=h,n=c.grouping.getGroupById(m),o=c.grouping.getGroupOrderIndex(n);"none"!==i.el.css("display")&&(b.expandedGroups[n]=b.expandedGroups[n]||{},b.expandedGroups[n][h]=i,l+=(o+1)*c.groupRowHeight)}i.el.css({top:l,left:f}),c.leftColumns&&i.leftEl.css("top",l),c.rightColumns&&i.rightEl.css("top",l)}}c.grouping&&!1!==a&&(c.grouping.setPositions(),c.grouping.setExpanderCellsPosition())},getDisplayedRowsBefore:function(a,b){var c=this.widget;if(c.grouping){var d=0;return"none"!==a.el.css("display")&&(d=c.store.getRow(b)),d+1}return a.rowIndex+1},onScroll:function(){this.reSetTop()},reSetPlusScroll:function(){var a=this,b=a.widget;a.plusScroll=a.getPlusHeight(),b.scroller.setRightKnobSize(),setTimeout(function(){!1===b.scroller.isRightScrollable()&&b.scroller.scroll(0)},1)},getPlusHeight:function(){var a=this,b=0;for(var c in a._expandedIds){var d=a._expandedIds[c];d.hidden||"none"===d.el.css("display")||(b+=d.height)}return a.plusHeight=b,a.plusHeight},onColumnReSize:function(){var a=this,b=a.widget;for(var c in a._expandedIds){var d=a._expandedIds[c],e=b.getCenterFullWidth();d.el.css("width",e)}},prepareData:function(a){var b=this,c=b.widget,d=a.data;return b.dataFn&&(d=b.dataFn(c,d)),d},changeSidesSize:function(){var a=this.widget;a.setSidesHeight(),a.scroller.checkRightScroll()},onRowDBlClick:function(a,b){var c=this,d=c.widget,e=Number(b.rowIndex),f=b.id,g=c._expandedIds[f];if(d.edit)return void d.un("rowdblclick",c.onRowDBlClick,c);void 0===g?c.expand(e):!0===g.hidden&&"none"===g.el.css("display")?c.expand(e):c.collapse(e)},onRowTrackOver:function(a,b){var c=this,d=c.widget,e=c._expandedIds[b.id];e&&(e.el.addCls(f),d.leftColumns&&e.leftEl.addCls(f),d.rightColumns&&e.rightEl.addCls(f))},onRowTrackLeave:function(a,b){var c=this,d=c.widget,e=c._expandedIds[b.id];e&&(e.el.removeCls(f),d.leftColumns&&e.leftEl.removeCls(f),d.rightColumns&&e.rightEl.removeCls(f))},onExpandRowMouseEnter:function(a){var g=this,i=g.widget,j=i.scroller,k=b(a.currentTarget),l=k.attr("index");i.el.select("."+e+'[index="'+l+'"]').addCls(f),!i.trackOver||j.bottomKnobDown||j.rightKnobDown||i.el.select("."+d+'[grid="'+i.id+'"] .'+c+'[index="'+l+'"]').addCls(h)},onExpandRowMouseLeave:function(a){var g=this,i=g.widget,j=i.scroller,k=b(a.currentTarget),l=k.attr("index");i.el.select("."+e+'[index="'+l+'"]').removeCls(f),!i.trackOver||j.bottomKnobDown||j.rightKnobDown||i.el.select("."+d+'[grid="'+i.id+'"] .'+c+'[index="'+l+'"]').removeCls(h)},onSelect:function(){var a=this,b=a.widget,c=b.selection;if(c&&(c.row||c.rows)){a.onClearSelect(),c=b.getSelection(!0);for(var d=c.rows,f=0,h=d.length;f<h;f++){var i=d[f];b.el.select("."+e+'[index="'+i+'"]').addCls(g)}}},onClearSelect:function(){var a=this,b=a.widget,c=b.selection;if(c.row||c.rows){c=b.getSelection(!0);for(var d={},f=c.rows,h=0,i=f.length;h<i;h++)d[f[h]]=!0;for(var j=b.el.select("."+g),h=0,i=j.length;h<i;h++){var k=j.item(h).attr("index");d[k]||b.el.select("."+e+'[index="'+k+'"]').removeCls(g)}}},onGroupCollapse:function(a,b,c){var d=this,e=d.widget,f=d.expandedGroups;if(f[c]){var g=f[c];for(var h in g){var i=g[h];d._expandedIds[h]&&delete d._expandedIds[h],i.el.hide(),i.leftEl.dom&&i.leftEl.hide(),i.rightEl.dom&&i.rightEl.hide()}}d.reSetTop(!1),d.reSetIndexes(),setTimeout(function(){e.grouping.setExpanderCellsPosition()},1)},onGroupExpand:function(a,b,c){var d=this,e=d.widget;d.reSetTop(!1),d.reSetIndexes(),setTimeout(function(){e.grouping.setExpanderCellsPosition()},1)},reSetIndexes:function(){var a=this,b=a.widget,c=b.store;for(var d in a._expandedIds)a._expandedIds[d].rowIndex=c.getRow(d)},onAdd:function(){this.reSet()},onBeforeInsert:function(){this.reSet()},onColumnDrag:function(){this.reSet(),this.clearExpandedCheckBoxes()},onLockColumn:function(){this.reSet(),this.clearExpandedCheckBoxes()},onRightLockColumn:function(){this.reSet(),this.clearExpandedCheckBoxes()},onUnLockColumn:function(){this.reSet(),this.clearExpandedCheckBoxes()},clearExpandedCheckBoxes:function(){this.widget.el.select(".fancy-checkbox-expander.fancy-checkbox-on").each(function(a){var b=a.attr("id");Fancy.getWidget(b).setValue(!1,!1)})}})}();