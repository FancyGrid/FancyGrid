Fancy.modules.grouping=!0,Fancy.Mixin("Fancy.store.mixin.Grouping",{expand(e,t){var o=this,r=o.data,s=0,i=r.length,n=[],l={},d={};for(o.filteredData&&(i=(r=o.filteredData).length),o.expanded=o.expanded||{},o.memoryCollapsed=o.memoryCollapsed||{},Fancy.isArray(t)?Fancy.each(t,function(e){o.expanded[e]=!0,delete o.memoryCollapsed[e]}):(o.expanded[t]=!0,delete o.memoryCollapsed[t]);s<i;s++){var a=r[s];o.expanded[a.data[e]]&&(n.push(a),l[a.id]=n.length-1,d[n.length-1]=s)}o.dataView=n,o.dataViewMap=l,o.dataViewIndexes=d},collapse(e,t){var o=this,r=o.data,s=0,i=r.length,n=[],l={},d={};for(o.expanded=o.expanded||{},o.expanded[t]=!1,o.memoryCollapsed=o.memoryCollapsed||{},o.memoryCollapsed[t]=!0;s<i;s++){var a=r[s];o.expanded[a.data[e]]&&(n.push(a),l[a.id]=n.length-1,d[n.length-1]=s)}o.dataView=n,o.dataViewMap=l,o.dataViewIndexes=d},changeOrderByGroups(e,t){var o={},r=[],s=[];Fancy.each(e,e=>o[e]=[]),Fancy.isArray(this.data)&&Fancy.each(this.data,e=>{const r=e.data[t];o[r]?o[r].push(e):s.push(e)}),Fancy.each(e,e=>{r=r.concat(o[e])}),r=r.concat(s),this.grouping={by:t},this.data=r},getColumnOriginalValuesByGroup(e,t,o){var r=this.data,s=0,i=r.length,n=[],l=[],d=r[0].data[t];if(o&&o.format&&"date"===o.type)for(;s<i;s++)r[s].data[t]===d?l.push(Fancy.Date.parse(r[s].data[e],o.format,o.mode)):(n.push({values:l,groupName:d}),l=[],d=r[s].data[t],s--);else for(;s<i;s++)r[s].data[t]===d?l.push(r[s].data[e]):(n.push({values:l,groupName:d}),l=[],d=r[s].data[t],s--);return i>0&&n.push({values:l,groupName:d}),n},addGroup(e){this.widget.grouping.by=e,this.orderDataByGroup()},initGroups(e){const t=this.widget.grouping.by;if(e=e||"data",!t)throw new Error("[FancyGrid Error] - not set by param in grouping");const o=this.getColumnOriginalValues(t,{dataProperty:e,groupMap:!0}),r={};Fancy.each(o,e=>{e=String(e),void 0===r[e]&&(r[e]=0),r[e]++});let s=[];for(const e in r)s.push(e);return{groups:s=this.sortGroupNames(s),_groups:r}},orderDataByGroup(){const e=this,t=e.widget.grouping,o=e.initGroups(),r=e.sortGroupNames(o.groups);e.changeOrderByGroups(r,t.by),e.expanded={},t.collapsed?e.collapsed=!0:Fancy.each(r,t=>{void 0===e.expanded[t]&&(e.expanded[t]=!0)}),e.changeDataView({doNotFired:!0})},sortGroupNames(e){var t={},o=[],r=[],s=this.widget.grouping.sortGroups||"asc";Fancy.each(e,e=>{let r=String(e).toLocaleUpperCase();r=isNaN(Number(e))||""===e||" "===e?e.toLocaleUpperCase():String(Number(e)),t[r]=e,o.push(r)});const i=this.areGroupsNumber(o);switch(s){case"asc":case"ASC":case!0:o=i?o.sort(function(e,t){return Number(e)-Number(t)}):o.sort();break;case"desc":case"DESC":o=i?o.sort(function(e,t){return Number(t)-Number(e)}):o.reverse()}for(var n=0,l=e.length;n<l;n++)r[n]=t[o[n]];return r},getItemsByGroup(e){return this.findItem(this.grouping.by,e)},clearGroup(){const e=this;delete e.expanded,delete e.collapsed,delete e.groupMap,delete e.grouping,delete e.grouping,delete e.memoryCollapsed},areGroupsNumber(e){let t=!1;return Fancy.each(e,e=>{if(Fancy.isString(e)&&""!==e&&" "!==e)return t=!0,!0}),!t}}),Fancy.modules.grouping=!0,function(){const e=Fancy,t=Fancy.each,o=e.GRID_ROW_GROUP_INNER_CLS,r=e.GRID_ROW_GROUP_CLS,s=e.GRID_ROW_GROUP_COLLAPSED_CLS,i=`.${e.GRID_CELL_CLS}`;e.define("Fancy.grid.plugin.Grouping",{extend:e.Plugin,ptype:"grid.grouping",inWidgetName:"grouping",tpl:"{text}: {number}",sortGroups:"asc",_renderFirstTime:!0,constructor:function(){this.Super("const",arguments)},init(){const e=this,t=e.widget;e.Super("init",arguments),e.initTpl(),e.by&&(e.initGroups(),e.initOrder(),e.calcPlusScroll(),e.configParams(),e.ons(),!e.collapsed&&t.store.data&&t.store.changeDataView({doNotFired:!0}))},ons(){const e=this;e.widget.once("render",()=>{e.renderGroupedRows(),e.update(),e.onGridRender()},e)},onGridRender(){const e=this,t=e.widget,o=t.store;t.el.on("click",e.onClick,e,`div.${r}`),t.el.on("mousedown",e.onMouseDown,e,`div.${r}`),t.on("scroll",e.onScroll,e),t.on("columnresize",e.onColumnResize,e),o.on("insert",e.onInsert,e),o.on("remove",e.onRemove,e),t.on("columndrag",e.onColumnDrag,e)},uns(){const e=this,t=e.widget,o=t.store;t.el.un("click",e.onClick,e,`div.${r}`),t.el.un("mousedown",e.onMouseDown,e,`div.${r}`),t.un("scroll",e.onScroll),t.un("columnresize",e.onColumnResize),o.un("insert",e.onInsert),o.un("remove",e.onRemove),t.un("columndrag",e.onColumnDrag)},onInsert(){this.reGroup()},onRemove(){const e=this,o=e.widget.store,r=e.groups;var s;(e.initGroups(),e.update(),e.updateGroupRowsText(),r.length>e.groups.length)&&(t(r,function(t,o){if(t!==e.groups[o])return s=t,!0}),delete o.expanded[s])},initGroups(e){var t;t=this.widget.store.initGroups(e),this.groups=t.groups,this.groupsCounts=t._groups},getGroupById(e){return this.store.groupMap[e]},getGroupOrderIndex(e){for(var t=this.groups,o=0,r=t.length;o<r;o++)if(t[o]===e)return o},initOrder(){var t,o=this,r=o.widget.store;if(o.order&&0!==o.order.length)switch(e.typeOf(o.order)){case"string":break;case"array":t=o.order}else t=r.sortGroupNames(o.groups);o.groups=t,r.changeOrderByGroups(t,o.by)},calcPlusScroll(){const e=this.widget;this.plusScroll=this.groups.length*e.groupRowHeight},configParams(){const e=this,t=e.widget.store;t.expanded=t.expanded||{},e.collapsed?t.collapsed=!0:e.groups.forEach(e=>{void 0===t.expanded[e]&&(t.expanded[e]=!0)})},renderGroupedRows(e){var o,r=this,s=r.widget,i=s.body,n=s.leftBody,l=s.rightBody,d=s.groupRowHeight,a=s.getCenterFullWidth(),p=s.getLeftFullWidth(),u=s.getRightFullWidth(),g=0;e=e||r.groups,t(e,e=>{var t=r.groupsCounts[e];p?((o=r.generateGroupRow(e,t,!0,g)).css("width",p),o.css("height",d),n.el.dom.appendChild(o.dom),(o=r.generateGroupRow(e,t,!1,g)).css("width",a),o.css("height",d),i.el.dom.appendChild(o.dom)):((o=r.generateGroupRow(e,t,!0,g)).css("width",a),o.css("height",d),i.el.dom.appendChild(o.dom)),u&&((o=r.generateGroupRow(e,t,!1,g)).css("width",u),o.css("height",d),l.el.dom.appendChild(o.dom)),r.collapsed&&(g+=d)})},softRenderGroupedRows(e){var i,n,l,d=this,a=d.widget,p=a.body,u=a.leftBody,g=a.rightBody;switch(e){case"left":if(u.el.select(`.${r}`).length){const e=p.el.select("."+o);return void(e.length&&e.destroy())}l=p.el.select("."+r),i=a.getLeftFullWidth(),t(d.groups,(e,t)=>{var r=d.groupsCounts[e],n=l.item(t),a=parseInt(n.css("top")),p=d.generateGroupRow(e,r,!0,a);n.hasClass(s)||p.removeCls(s),n.select("."+o).destroy(),p.css("width",i),u.el.dom.appendChild(p.dom)});break;case"right":if(g.el.select("."+r).length)return;n=a.getRightFullWidth(),l=p.el.select("."+r),t(d.groups,(e,t)=>{var o=d.groupsCounts[e],r=l.item(t),s=parseInt(r.css("top")),i=d.generateGroupRow(e,o,!1,s);i.css("width",n),g.el.dom.appendChild(i.dom)})}},removeGroupRows(){var e=this.widget,t=e.columns,o=e.leftColumns,s=e.rightColumns,i=e.body,n=e.leftBody,l=e.rightBody;t.length&&i.el.select("."+r).remove(),o.length&&n.el.select("."+r).remove(),s.length&&l.el.select("."+r).remove()},clearGroupRows(){var e=this,t=[],o={},s=[];e.widget.el.select(`.${r}`).each(r=>{const s=r.attr("group");e.groupsCounts[s]?o[s]=!0:t.push(r)}),t.forEach(e=>e.destroy()),e.groups.forEach(e=>{o[e]||s.push(e)}),e.renderGroupedRows(s)},removeLastGroupRow(){var e=this.widget,t=e.columns,o=this.groups.length,s=e.leftColumns,i=e.rightColumns,n=e.body,l=e.leftBody,d=e.rightBody;t.length&&n.el.select("."+r).item(o).remove();s.length&&l.el.select("."+r).item(o).remove(),i.length&&d.el.select("."+r).item(o).remove()},removeCells(){const e=this.widget,t=e.columns,o=e.leftColumns,r=e.rightColumns,s=e.body,n=e.leftBody,l=e.rightBody;t.length&&s.el.select(i).remove(),o.length&&n.el.select(i).remove(),r.length&&l.el.select(i).remove()},generateGroupRow(t,i,n,l){var d=this.widget.store,a=e.newEl("div");if(a.addCls(r),a.attr("group",t),n){""===t&&(t="&nbsp;");const e=this.tpl.getHTML({text:t,number:i});a.update('<div class="'+o+'"> '+e+"</div>")}return this.collapsed?(a.css("top",l+"px"),a.addCls(s)):a.css("top","0px"),d.expanded&&!1===d.expanded[t]&&a.addCls(s),a.css("visibility","hidden"),a},insertGroupEls(){var e=this,t=e.widget,s=t.leftBody,i=t.body;t.leftColumns.length?s.el.select("."+r).each((t,r)=>{var s=e.groups[r];t.update('<div class="'+o+'">'+s+"</div>")}):i.el.select("."+r).each((t,r)=>{var s=e.groups[r],i=e.groupsCounts[s],n=e.tpl.getHTML({text:s,number:i});t.update('<div class="'+o+'">'+n+"</div>")})},onClick(t){var o=this,i=o.widget,n=i.store,l=e.get(t.currentTarget),d=l.attr("group");try{i.el.select("."+r+'[group="'+d+'"]').toggleCls(s)}catch(t){l.toggleCls(s)}l.hasCls(s)?o.collapse(o.by,d):o.expand(o.by,d),n.sorters&&n.reSort(),n.filterOrder&&i.filter.updateStoreFilters(!1),(n.sorters||n.filterOrder)&&n.changeDataView({doNotFired:!0}),o.update()},fastCollapse(){},onMouseDown(e){e.preventDefault()},onScroll(){this.setPositions()},collapse(e,t){const o=this.widget;o.store.collapse(e,t),o.fire("collapse",e,t)},expand(t,o){const r=this,s=r.widget,i=s.store;e.isArray(o)?(r.initGroups(),r.initOrder(),i.expand(t,o)):i.expand(t,o),s.fire("expand",t,o)},setPositions(){var e=this,o=e.widget,s=o.store,i=-o.scroller.scrollTop||0;t(e.groups,t=>{if(o.el.select("."+r+'[group="'+t+'"]').each(e=>{e.css({top:i+"px",visibility:"visible"})}),o.expander){const e=o.expander.expandedGroups[t];for(const t in e){const o=e[t];i+=parseInt(o.el.css("height"))}}if(i+=o.groupRowHeight,!0===s.expanded[t])if(o.rowheight){const e=s.getItemsByGroup(t),r=o.rowheight.getRowsHeight(e);if(isNaN(i))return!0;i+=r}else i+=e.groupsCounts[t]*o.cellHeight})},setCellsPosition(e,o){for(var r,s=this,i=s.widget,n=i.store,l=0,d=s.groups.length,a=0,p=i.body,u=i.leftBody,g=i.rightBody,c=0,h=i.groupRowHeight,m=[],w={},f={},v=s.by;l<d;l++){const t=s.groups[l];if(!0===n.expanded[t]){if(m.push(c),w[c]=!0,void 0===o||"center"===o)if(a=0,r=i.columns.length,void 0!==e&&(a=e,r=e+1),i.expander){var C=i.get(c).get(v),y=i.expander.expandedGroups,G=s.getGroupOrderIndex(t),x=0;for(var R in y){if(G<=s.getGroupOrderIndex(R))continue;const e=y[R];for(var b in e){const t=e[b];if("none"!==t.el.css("display")&&!f[b]){var F=c-1;c<0&&(c=0),C!==(F=i.get(F)).get(v)?F.id===b&&(f[b]=!0,x+=parseInt(t.el.css("height"))):(f[b]=!0,x+=parseInt(t.el.css("height")))}}}for(h+=x,p.getCell(c,a);a<r;a++)p.getCell(c,a).css("margin-top",h+"px")}else for(;a<r;a++)p.getCell(c,a).css("margin-top",h+"px");if(void 0===o||"left"===o)for(a=0,r=i.leftColumns.length,void 0!==e&&(a=e,r=e+1);a<r;a++)u.getCell(c,a).css("margin-top",h+"px");if(void 0===o||"right"===o)for(a=0,r=i.rightColumns.length,void 0!==e&&(a=e,r=e+1);a<r;a++)g.getCell(c,a).css("margin-top",h+"px");c+=s.groupsCounts[t],h=i.groupRowHeight}else h+=i.groupRowHeight}if(s._renderFirstTime)s._renderFirstTime=!1;else{var B=[];t(s.prevRows,function(e){!0!==w[e]&&B.push(e)}),s.clearMargins(B)}s.prevRows=m},setExpanderCellsPosition(){var e,o=this.widget,r=o.store,s=r.dataView,i=o.body,n=o.leftBody,l=o.rightBody,d=o.expander.expandedGroups,a=this.groupsCounts,p=o.groupRowHeight,u=0,g=0;t(this.groups,c=>{if(!0===r.expanded[c]){const r=u+a[c];for(;u<r;u++)if(e=s[u]){var h=e.id,m=d[c]?d[c][h]:void 0;g&&(p+=g,g=0),m&&(g=parseInt(m.el.css("height"))),t(o.columns,(e,t)=>{i.getCell(u,t).css("margin-top",p+"px")}),t(o.leftColumns,(e,t)=>{n.getCell(u,t).css("margin-top",p+"px")}),t(o.rightColumns,(e,t)=>{l.getCell(u,t).css("margin-top",p+"px")}),p=0}p=o.groupRowHeight}else p+=o.groupRowHeight})},clearMargins(e){if(void 0!==(e=e||this.prevRows)){var o,r=this.widget,s=r.body,i=r.leftBody,n=r.rightBody;t(e,e=>{t(r.columns,(t,r)=>{if(void 0===(o=s.getCell(e,r)).dom)return!0;o.css("margin-top","0px")}),t(r.leftColumns,(t,r)=>{if(void 0===(o=i.getCell(e,r)).dom)return!0;o.css("margin-top","0px")}),t(r.rightColumns,(t,r)=>{if(void 0===(o=n.getCell(e,r)).dom)return!0;o.css("margin-top","0px")})})}},onColumnResize(){this.updateGroupRows()},updateGroupRows(){var e=this.widget,t=e.leftColumns,o=e.rightColumns,s=e.body,i=e.leftBody,n=e.rightBody,l=0;this.clearGroupRows(),l+=e.getCenterFullWidth(),s.el.select("."+r).css("width",l+"px"),l+=e.getLeftFullWidth(),t.length&&i.el.select("."+r).css("width",l+"px"),l+=e.getRightFullWidth(),o.length&&n.el.select("."+r).css("width",l+"px")},update(e){var t=this,o=t.widget,r=o.store;e||!0!==r.loading&&!1!==r.autoLoad||r.data.length?e&&r.data.length&&r.loadedTimes>1?t.reGroup():(t.setPositions(),o.update(),o.scroller.update(),t.setCellsPosition(),o.setSidesHeight()):r.on("load",()=>{t.initGroups(),t.initOrder(),t.calcPlusScroll(),t.configParams(),r.changeDataView({doNotFired:!0}),t.renderGroupedRows(),t.update(!0)},t)},getOffsetForRow(e){var o=this,r=o.widget,s=r.store,i=0,n=0;return t(o.groups,t=>{if(i+=r.groupRowHeight,!0===s.expanded[t]&&(n+=o.groupsCounts[t]),e<n)return!0}),i},getCollapsedRowsBefore(t){const o=this,r=o.widget,s=r.store,i=r.getById(t);if(!i)return 0;var n=i.get(o.by),l=0;return o.collapsedRowsBefore=o.collapsedRowBefore||{},void 0!==o.collapsedRowsBefore[n]?o.collapsedRowsBefore[n]:(e.each(o.groups,e=>{if(e===n)return!0;!0!==s.expanded[e]&&(l+=o.groupsCounts[e])}),o.collapsedRowsBefore[n]=l,l)},getSpecialRowsUnder:e=>{var o=this,r=o.widget.store,s=0,i=0;return t(o.groups,t=>{e<s&&i++,!0===r.expanded[t]&&(s+=o.groupsCounts[t])}),i},getSpecialRowsAbove(e){var t=this.widget.get(e),o=this.getGroupById(t.id),r=0;return Fancy.each(this.groups,e=>{if(r++,o==e)return!0}),r},reGroup(){var e=this,t=e.widget,o=t.store,r="data";t.store.expanded={},t.store.dataView=[],e.collapsed=!0,t.store.filteredData&&(r="filteredData"),e.removeGroupRows(),e.removeCells(),e.initGroups(r),o.remoteFilter&&e.initOrder(),e.calcPlusScroll(),e.configParams(),e.renderGroupedRows(),t.setSidesHeight()},addGroup(e){const t=this;t.reGroup(),e&&t.onGridRender()},clearGroup(){const e=this,t=e.widget.store;delete e.collapsed,delete t.expanded,delete e.groups,delete e.groupsCounts,delete e.by,delete e.by,delete e.plusScroll,delete e.prevRows,e.removeGroupRows(),e.removeCells(),e.uns()},scrollLeft(e){this.widget.body.el.select(`.${r}`).css("left",e)},updateGroupRowsText(){var e=this,i=e.widget,n=i.store,l=e.groups,d=i.leftBody,a=i.body,p=i.rightBody,u=d.el.select("."+o),g=a.el.select("."+o),c=d.el.select("."+r),h=a.el.select("."+r),m=p.el.select("."+r);t(l,(t,o)=>{var r,l=e.groupsCounts[t],d=e.tpl.getHTML({text:t,number:l});i.leftColumns.length?(u.item(o).update(d),(r=c.item(o)).attr("group",t),n.expanded[t]?r.removeClass(s):r.addClass(s)):(g.item(o).update(d),r=h.item(o),n.expanded[t]?r.removeClass(s):r.addClass(s)),h.item(o).attr("group",t),i.rightColumns.length&&m.item(o).attr("group",t)}),l.length<a.el.select("."+r).length&&setTimeout(()=>{e.removeLastGroupRow()},10)},onColumnDrag(){var e=this.widget,t=e.el.select("."+r),o={};if(e.el.select("."+r+":not(."+s+")").each(function(e){o[e.attr("group")]=!0}),!e.leftColumns.length&&t.length){t.destroy(),this.renderGroupedRows(),this.update();for(const t in o){e.el.select("."+r+'[group="'+t+'"]').removeCls(s)}}},getGroupRowsHeight(){var t=this.widget,o=0;return e.each(this.groupsCounts,e=>{e&&o++}),o*t.groupRowHeight},reFreshExpanded(){var t=this,o=t.widget,r=t.groups,s=o.store,i=s.expanded,n=s.memoryCollapsed||{};for(const e in i)t.groupsCounts[e]||delete i[e];for(const e in n)n[e]&&(i[e]=!1);e.each(r,e=>{void 0===i[e]&&(i[e]=!t.collapsed)}),s.expanded=i},reFreshGroupTexts(){const e=this;e.widget.el.select("."+r).each(t=>{const o=t.attr("group"),r=t.firstChild(),s=e.tpl.getHTML({text:o,number:e.groupsCounts[o]});r.dom&&r.update(s)})}})}();