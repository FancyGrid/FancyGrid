Fancy.modules.grouping=!0,Fancy.Mixin("Fancy.store.mixin.Grouping",{expand:function(a,b){var c=this,d=c.data,e=0,f=d.length,g=[],h={},i={};for(c.filteredData&&(d=c.filteredData,f=d.length),c.expanded=c.expanded||{},c.memoryCollapsed=c.memoryCollapsed||{},Fancy.isArray(b)?Fancy.each(b,function(a){c.expanded[a]=!0,delete c.memoryCollapsed[a]}):(c.expanded[b]=!0,delete c.memoryCollapsed[b]);e<f;e++){var j=d[e];c.expanded[j.data[a]]&&(g.push(j),h[j.id]=g.length-1,i[g.length-1]=e)}c.dataView=g,c.dataViewMap=h,c.dataViewIndexes=i},collapse:function(a,b){var c=this,d=c.data,e=0,f=d.length,g=[],h={},i={};for(c.expanded=c.expanded||{},c.expanded[b]=!1,c.memoryCollapsed=c.memoryCollapsed||{},c.memoryCollapsed[b]=!0;e<f;e++){var j=d[e];c.expanded[j.data[a]]&&(g.push(j),h[j.id]=g.length-1,i[g.length-1]=e)}c.dataView=g,c.dataViewMap=h,c.dataViewIndexes=i},changeOrderByGroups:function(a,b){var c=this,d={},e=[],f=[];Fancy.each(a,function(a){d[a]=[]}),Fancy.isArray(c.data)&&Fancy.each(c.data,function(a){var c=a.data[b];d[c]?d[c].push(a):f.push(a)}),Fancy.each(a,function(a){e=e.concat(d[a])}),e=e.concat(f),c.grouping={by:b},c.data=e},getColumnOriginalValuesByGroup:function(a,b,c){var d=this,e=d.data,f=0,g=e.length,h=[],i=[],j=e[0].data[b];if(c&&c.format&&"date"===c.type)for(;f<g;f++)e[f].data[b]===j?i.push(Fancy.Date.parse(e[f].data[a],c.format,c.mode)):(h.push({values:i,groupName:j}),i=[],j=e[f].data[b],f--);else for(;f<g;f++)e[f].data[b]===j?i.push(e[f].data[a]):(h.push({values:i,groupName:j}),i=[],j=e[f].data[b],f--);return g>0&&h.push({values:i,groupName:j}),h},addGroup:function(a){var b=this;b.widget.grouping.by=a,b.orderDataByGroup()},initGroups:function(a){var b=this,c=b.widget,d=c.grouping,e=d.by;if(a=a||"data",!e)throw new Error("[FancyGrid Error] - not set by param in grouping");var f=b.getColumnOriginalValues(e,{dataProperty:a,groupMap:!0}),g={};Fancy.each(f,function(a){a=String(a),void 0===g[a]&&(g[a]=0),g[a]++});var h=[];for(var i in g)h.push(i);return h=b.sortGroupNames(h),{groups:h,_groups:g}},orderDataByGroup:function(){var a=this,b=a.widget.grouping,c=a.initGroups(),d=a.sortGroupNames(c.groups);a.changeOrderByGroups(d,b.by),a.expanded={},b.collapsed?a.collapsed=!0:Fancy.each(d,function(b){void 0===a.expanded[b]&&(a.expanded[b]=!0)}),a.changeDataView({doNotFired:!0})},sortGroupNames:function(a){var b=this,c=b.widget.grouping,d={},e=[],f=[],g=c.sortGroups||"asc";Fancy.each(a,function(a){var b=String(a).toLocaleUpperCase();b=isNaN(Number(a))||""===a||" "===a?a.toLocaleUpperCase():String(Number(a)),d[b]=a,e.push(b)});var h=b.areGroupsNumber(e);switch(g){case"asc":case"ASC":case!0:e=h?e.sort(function(a,b){return Number(a)-Number(b)}):e.sort();break;case"desc":case"DESC":e=h?e.sort(function(a,b){return Number(b)-Number(a)}):e.reverse()}for(var i=0,j=a.length;i<j;i++)f[i]=d[e[i]];return f},getItemsByGroup:function(a){var b=this;return b.findItem(b.grouping.by,a)},clearGroup:function(){var a=this;delete a.expanded,delete a.collapsed,delete a.groupMap,delete a.grouping,delete a.grouping,delete a.memoryCollapsed},areGroupsNumber:function(a){var b=!1;return Fancy.each(a,function(a){if(Fancy.isString(a)&&""!==a&&" "!==a)return b=!0,!0}),!b}}),Fancy.modules.grouping=!0,function(){var a=Fancy,b=Fancy.each,c=a.GRID_ROW_GROUP_INNER_CLS,d=a.GRID_ROW_GROUP_CLS,e=a.GRID_ROW_GROUP_COLLAPSED_CLS,f=a.GRID_CELL_CLS;a.define("Fancy.grid.plugin.Grouping",{extend:a.Plugin,ptype:"grid.grouping",inWidgetName:"grouping",tpl:"{text}: {number}",sortGroups:"asc",_renderFirstTime:!0,constructor:function(){this.Super("const",arguments)},init:function(){var a=this,b=a.widget;a.Super("init",arguments),a.initTpl(),a.by&&(a.initGroups(),a.initOrder(),a.calcPlusScroll(),a.configParams(),a.ons(),!a.collapsed&&b.store.data&&b.store.changeDataView({doNotFired:!0}))},ons:function(){var a=this;a.widget.once("render",function(){a.renderGroupedRows(),a.update(),a.onGridRender()},a)},onGridRender:function(){var a=this,b=a.widget,c=b.store;b.el.on("click",a.onClick,a,"div."+d),b.el.on("mousedown",a.onMouseDown,a,"div."+d),b.on("scroll",a.onScroll,a),b.on("columnresize",a.onColumnResize,a),c.on("insert",a.onInsert,a),c.on("remove",a.onRemove,a),b.on("columndrag",a.onColumnDrag,a)},uns:function(){var a=this,b=a.widget,c=b.store;b.el.un("click",a.onClick,a,"div."+d),b.el.un("mousedown",a.onMouseDown,a,"div."+d),b.un("scroll",a.onScroll),b.un("columnresize",a.onColumnResize),c.un("insert",a.onInsert),c.un("remove",a.onRemove),b.un("columndrag",a.onColumnDrag)},onInsert:function(){this.reGroup()},onRemove:function(){var a=this,c=a.widget,d=c.store,e=a.groups;if(a.initGroups(),a.update(),a.updateGroupRowsText(),e.length>a.groups.length){var f;b(e,function(b,c){if(b!==a.groups[c])return f=b,!0}),delete d.expanded[f]}},initGroups:function(a){var b,c=this,d=c.widget,e=d.store;b=e.initGroups(a),c.groups=b.groups,c.groupsCounts=b._groups},getGroupById:function(a){return this.widget.store.groupMap[a]},getGroupOrderIndex:function(a){for(var b=this.groups,c=0,d=b.length;c<d;c++)if(b[c]===a)return c},initOrder:function(){var b,c=this,d=c.widget,e=d.store;if(c.order&&0!==c.order.length)switch(a.typeOf(c.order)){case"string":break;case"array":b=c.order}else b=e.sortGroupNames(c.groups);c.groups=b,e.changeOrderByGroups(b,c.by)},calcPlusScroll:function(){var a=this.widget;this.plusScroll=this.groups.length*a.groupRowHeight},configParams:function(){var a=this,c=a.widget,d=c.store;d.expanded=d.expanded||{},a.collapsed?d.collapsed=!0:b(a.groups,function(a){void 0===d.expanded[a]&&(d.expanded[a]=!0)})},renderGroupedRows:function(a){var c,d=this,e=d.widget,f=e.body,g=e.leftBody,h=e.rightBody,i=e.groupRowHeight,j=e.getCenterFullWidth(),k=e.getLeftFullWidth(),l=e.getRightFullWidth(),m=0;a=a||d.groups,b(a,function(a){var b=d.groupsCounts[a];k?(c=d.generateGroupRow(a,b,!0,m),c.css("width",k),c.css("height",i),g.el.dom.appendChild(c.dom),c=d.generateGroupRow(a,b,!1,m),c.css("width",j),c.css("height",i),f.el.dom.appendChild(c.dom)):(c=d.generateGroupRow(a,b,!0,m),c.css("width",j),c.css("height",i),f.el.dom.appendChild(c.dom)),l&&(c=d.generateGroupRow(a,b,!1,m),c.css("width",l),c.css("height",i),h.el.dom.appendChild(c.dom)),d.collapsed&&(m+=i)})},softRenderGroupedRows:function(a){var f,g,h,i=this,j=i.widget,k=j.body,l=j.leftBody,m=j.rightBody;switch(a){case"left":if(l.el.select("."+d).length){var n=k.el.select("."+c);return void(n.length&&n.destroy())}h=k.el.select("."+d),f=j.getLeftFullWidth(),b(i.groups,function(a,b){var d=i.groupsCounts[a],g=h.item(b),j=parseInt(g.css("top")),k=i.generateGroupRow(a,d,!0,j);g.hasClass(e)||k.removeCls(e),g.select("."+c).destroy(),k.css("width",f),l.el.dom.appendChild(k.dom)});break;case"right":if(m.el.select("."+d).length)return;g=j.getRightFullWidth(),h=k.el.select("."+d),b(i.groups,function(a,b){var c=i.groupsCounts[a],d=h.item(b),e=parseInt(d.css("top")),f=i.generateGroupRow(a,c,!1,e);f.css("width",g),m.el.dom.appendChild(f.dom)})}},removeGroupRows:function(){var a=this,b=a.widget,c=b.columns,e=b.leftColumns,f=b.rightColumns,g=b.body,h=b.leftBody,i=b.rightBody;c.length&&g.el.select("."+d).remove(),e.length&&h.el.select("."+d).remove(),f.length&&i.el.select("."+d).remove()},clearGroupRows:function(){var b=this,c=b.widget,e=c.el.select("."+d),f=[],g={},h=[];e.each(function(a){var c=a.attr("group");b.groupsCounts[c]?g[c]=!0:f.push(a)}),a.each(f,function(a){a.destroy()}),a.each(b.groups,function(a){g[a]||h.push(a)}),b.renderGroupedRows(h)},removeLastGroupRow:function(){var a=this,b=a.widget,c=b.columns,e=a.groups,f=e.length,g=b.leftColumns,h=b.rightColumns,i=b.body,j=b.leftBody,k=b.rightBody;if(c.length){i.el.select("."+d).item(f).remove()}g.length&&j.el.select("."+d).item(f).remove(),h.length&&k.el.select("."+d).item(f).remove()},removeCells:function(){var a=this,b=a.widget,c=b.columns,d=b.leftColumns,e=b.rightColumns,g=b.body,h=b.leftBody,i=b.rightBody;c.length&&g.el.select("."+f).remove(),d.length&&h.el.select("."+f).remove(),e.length&&i.el.select("."+f).remove()},generateGroupRow:function(b,f,g,h){var i=this,j=i.widget,k=j.store,l=a.get(document.createElement("div"));if(l.addCls(d),l.attr("group",b),g){""===b&&(b="&nbsp;");var m=i.tpl.getHTML({text:b,number:f});l.update('<div class="'+c+'"> '+m+"</div>")}return i.collapsed?(l.css("top",h+"px"),l.addCls(e)):l.css("top","0px"),k.expanded&&!1===k.expanded[b]&&l.addCls(e),l.css("visibility","hidden"),l},insertGroupEls:function(){var a=this,b=a.widget,e=b.leftBody,f=b.body;b.leftColumns.length?e.el.select("."+d).each(function(b,d){var e=a.groups[d];b.update('<div class="'+c+'">'+e+"</div>")}):f.el.select("."+d).each(function(b,d){var e=a.groups[d],f=a.groupsCounts[e],g=a.tpl.getHTML({text:e,number:f});b.update('<div class="'+c+'">'+g+"</div>")})},onClick:function(b){var c,f=this,g=f.widget,h=g.store,i=a.get(b.currentTarget),j=i.attr("group");try{g.el.select("."+d+'[group="'+j+'"]').toggleCls(e)}catch(b){i.toggleCls(e)}c=i.hasCls(e),c?f.collapse(f.by,j):f.expand(f.by,j),h.sorters&&h.reSort(),h.filterOrder&&g.filter.updateStoreFilters(!1),(h.sorters||h.filterOrder)&&h.changeDataView({doNotFired:!0}),f.update()},fastCollapse:function(){},onMouseDown:function(a){a.preventDefault()},onScroll:function(){this.setPositions()},collapse:function(a,b){var c=this,d=c.widget;d.store.collapse(a,b),d.fire("collapse",a,b)},expand:function(b,c){var d=this,e=d.widget,f=e.store;a.isArray(c)?(d.initGroups(),d.initOrder(),f.expand(b,c)):f.expand(b,c),e.fire("expand",b,c)},setPositions:function(){var a=this,c=a.widget,e=c.store,f=-c.scroller.scrollTop||0;b(a.groups,function(b){if(c.el.select("."+d+'[group="'+b+'"]').each(function(a){a.css({top:f+"px",visibility:"visible"})}),c.expander){var g=c.expander.expandedGroups[b];for(var h in g){var i=g[h];f+=parseInt(i.el.css("height"))}}if(f+=c.groupRowHeight,!0===e.expanded[b])if(c.rowheight){var j=e.getItemsByGroup(b),k=c.rowheight.getRowsHeight(j);if(isNaN(f))return!0;f+=k}else f+=a.groupsCounts[b]*c.cellHeight})},setCellsPosition:function(a,c){for(var d,e,f=this,g=f.widget,h=g.store,i=0,j=f.groups.length,k=0,l=g.body,m=g.leftBody,n=g.rightBody,o=0,p=g.groupRowHeight,q=[],r={},s={},t=f.by;i<j;i++){var u=f.groups[i];if(!0===h.expanded[u]){if(q.push(o),r[o]=!0,void 0===c||"center"===c)if(k=0,d=g.columns.length,void 0!==a&&(k=a,d=a+1),g.expander){var v=g.get(o),w=v.get(t),x=g.expander.expandedGroups,y=f.getGroupOrderIndex(u),z=0;for(var A in x){var B=f.getGroupOrderIndex(A);if(!(y<=B)){var C=x[A];for(var D in C){var E=C[D];if("none"!==E.el.css("display")&&!s[D]){var F=o-1;o<0&&(o=0),F=g.get(F);var G=F.get(t);w!==G?F.id===D&&(s[D]=!0,z+=parseInt(E.el.css("height"))):(s[D]=!0,z+=parseInt(E.el.css("height")))}}}}for(p+=z,e=l.getCell(o,k);k<d;k++)e=l.getCell(o,k),e.css("margin-top",p+"px")}else for(;k<d;k++)e=l.getCell(o,k),e.css("margin-top",p+"px");if(void 0===c||"left"===c)for(k=0,d=g.leftColumns.length,void 0!==a&&(k=a,d=a+1);k<d;k++)e=m.getCell(o,k),e.css("margin-top",p+"px");if(void 0===c||"right"===c)for(k=0,d=g.rightColumns.length,void 0!==a&&(k=a,d=a+1);k<d;k++)e=n.getCell(o,k),e.css("margin-top",p+"px");o+=f.groupsCounts[u],p=g.groupRowHeight}else p+=g.groupRowHeight}if(f._renderFirstTime)f._renderFirstTime=!1;else{var H=[];b(f.prevRows,function(a){!0!==r[a]&&H.push(a)}),f.clearMargins(H)}f.prevRows=q},setExpanderCellsPosition:function(){var a,c,d=this,e=d.widget,f=e.store,g=f.dataView,h=e.body,i=e.leftBody,j=e.rightBody,k=e.expander.expandedGroups,l=d.groupsCounts,m=e.groupRowHeight,n=0,o=0;b(d.groups,function(d){if(!0===f.expanded[d]){for(var p=n+l[d];n<p;n++)if(c=g[n]){var q=c.id,r=k[d]?k[d][q]:void 0;o&&(m+=o,o=0),r&&(o=parseInt(r.el.css("height"))),b(e.columns,function(b,c){a=h.getCell(n,c),a.css("margin-top",m+"px")}),b(e.leftColumns,function(b,c){a=i.getCell(n,c),a.css("margin-top",m+"px")}),b(e.rightColumns,function(b,c){a=j.getCell(n,c),a.css("margin-top",m+"px")}),m=0}m=e.groupRowHeight}else m+=e.groupRowHeight})},clearMargins:function(a){var c=this;if(void 0!==(a=a||c.prevRows)){var d,e=c.widget,f=e.body,g=e.leftBody,h=e.rightBody;b(a,function(a){b(e.columns,function(b,c){if(d=f.getCell(a,c),void 0===d.dom)return!0;d.css("margin-top","0px")}),b(e.leftColumns,function(b,c){if(d=g.getCell(a,c),void 0===d.dom)return!0;d.css("margin-top","0px")}),b(e.rightColumns,function(b,c){if(d=h.getCell(a,c),void 0===d.dom)return!0;d.css("margin-top","0px")})})}},onColumnResize:function(){this.updateGroupRows()},updateGroupRows:function(){var a=this,b=a.widget,c=b.leftColumns,e=b.rightColumns,f=b.body,g=b.leftBody,h=b.rightBody,i=0;a.clearGroupRows(),i+=b.getCenterFullWidth(),f.el.select("."+d).css("width",i+"px"),i+=b.getLeftFullWidth(),c.length&&g.el.select("."+d).css("width",i+"px"),i+=b.getRightFullWidth(),e.length&&h.el.select("."+d).css("width",i+"px")},update:function(a){var b=this,c=b.widget,d=c.store;a||!0!==d.loading&&!1!==d.autoLoad||d.data.length?a&&d.data.length&&d.loadedTimes>1?b.reGroup():(b.setPositions(),c.update(),c.scroller.update(),b.setCellsPosition(),c.setSidesHeight()):d.on("load",function(){b.initGroups(),b.initOrder(),b.calcPlusScroll(),b.configParams(),d.changeDataView({doNotFired:!0}),b.renderGroupedRows(),b.update(!0)},b)},getOffsetForRow:function(a){var c=this,d=c.widget,e=d.store,f=0,g=0;return b(c.groups,function(b){if(f+=d.groupRowHeight,!0===e.expanded[b]&&(g+=c.groupsCounts[b]),a<g)return!0}),f},getCollapsedRowsBefore:function(b){var c=this,d=c.widget,e=d.store,f=d.getById(b);if(!f)return 0;var g=f.get(c.by),h=0;return c.collapsedRowsBefore=c.collapsedRowBefore||{},void 0!==c.collapsedRowsBefore[g]?c.collapsedRowsBefore[g]:(a.each(c.groups,function(a){if(a===g)return!0;!0!==e.expanded[a]&&(h+=c.groupsCounts[a])}),c.collapsedRowsBefore[g]=h,h)},getSpecialRowsUnder:function(a){var c=this,d=c.widget,e=d.store,f=0,g=0;return b(c.groups,function(b){a<f&&g++,!0===e.expanded[b]&&(f+=c.groupsCounts[b])}),g},getSpecialRowsAbove:function(a){var b=this,c=b.widget,d=c.get(a),e=b.getGroupById(d.id),f=0;return Fancy.each(b.groups,function(a){if(f++,e==a)return!0}),f},reGroup:function(){var a=this,b=a.widget,c=b.store,d="data";b.store.expanded={},b.store.dataView=[],a.collapsed=!0,b.store.filteredData&&(d="filteredData"),a.removeGroupRows(),a.removeCells(),a.initGroups(d),c.remoteFilter&&a.initOrder(),a.calcPlusScroll(),a.configParams(),a.renderGroupedRows(),b.setSidesHeight()},addGroup:function(a){var b=this;b.reGroup(),a&&b.onGridRender()},clearGroup:function(){var a=this,b=a.widget,c=b.store;delete a.collapsed,delete c.expanded,delete a.groups,delete a.groupsCounts,delete a.by,delete a.by,delete a.plusScroll,delete a.prevRows,a.removeGroupRows(),a.removeCells(),a.uns()},scrollLeft:function(a){this.widget.body.el.select("."+d).css("left",a)},updateGroupRowsText:function(){var a=this,f=a.widget,g=f.store,h=a.groups,i=f.leftBody,j=f.body,k=f.rightBody,l=i.el.select("."+c),m=j.el.select("."+c),n=i.el.select("."+d),o=j.el.select("."+d),p=k.el.select("."+d);b(h,function(b,c){var d,h=a.groupsCounts[b],i=a.tpl.getHTML({text:b,number:h});f.leftColumns.length?(l.item(c).update(i),d=n.item(c),d.attr("group",b),g.expanded[b]?d.removeClass(e):d.addClass(e)):(m.item(c).update(i),d=o.item(c),g.expanded[b]?d.removeClass(e):d.addClass(e)),o.item(c).attr("group",b),f.rightColumns.length&&p.item(c).attr("group",b)}),h.length<j.el.select("."+d).length&&setTimeout(function(){a.removeLastGroupRow()},10)},onColumnDrag:function(){var a=this,b=a.widget,c=b.el.select("."+d),f=b.el.select("."+d+":not(."+e+")"),g={};if(f.each(function(a){g[a.attr("group")]=!0}),!b.leftColumns.length&&c.length){c.destroy(),a.renderGroupedRows(),a.update();for(var h in g){b.el.select("."+d+'[group="'+h+'"]').removeCls(e)}}},getGroupRowsHeight:function(){var b=this,c=b.widget,d=0;return a.each(b.groupsCounts,function(a){a&&d++}),d*c.groupRowHeight},reFreshExpanded:function(){var b=this,c=b.widget,d=b.groups,e=c.store,f=e.expanded,g=e.memoryCollapsed||{};for(var h in f)b.groupsCounts[h]||delete f[h];for(var i in g)g[i]&&(f[i]=!1);a.each(d,function(a){void 0===f[a]&&(f[a]=!b.collapsed)}),e.expanded=f},reFreshGroupTexts:function(){var a=this;a.widget.el.select("."+d).each(function(b){var c=b.attr("group"),d=b.firstChild(),e=a.tpl.getHTML({text:c,number:a.groupsCounts[c]});d.dom&&d.update(e)})}})}();